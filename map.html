<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Map — Nave</title>
    <meta name="description" content="Explore the Catholic culture heat map. Discover churches, missionaries, pilgrimages, schools, retreats, and Catholic businesses near you.">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Favicon (red Nave logo, cache-busted) -->
    <link rel="icon" href="/favicon.ico?v=20260209-red" sizes="48x48">
    <link rel="icon" href="assets/favicon-32.png?v=20260209-red" sizes="32x32" type="image/png">
    <link rel="icon" href="assets/favicon-16.png?v=20260209-red" sizes="16x16" type="image/png">
    <link rel="icon" href="assets/favicon-adaptive.svg?v=20260209-red" type="image/svg+xml" sizes="any">
    <link rel="apple-touch-icon" href="assets/apple-touch-icon.png?v=20260209-red" sizes="180x180">
    <link rel="mask-icon" href="assets/favicon-adaptive.svg?v=20260209-red" color="#CC3333">
    <link rel="shortcut icon" href="/favicon.ico?v=20260209-red">
    <link rel="manifest" href="site.webmanifest">
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="theme-color" content="#0D0D10">
    
    <style>
        /* Map Page Specific Styles */
        .map-page {
            height: 100vh;
            height: 100dvh; /* dynamic viewport height — respects mobile URL bar */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .map-wrapper {
            flex: 1;
            position: relative;
            margin-top: 57px; /* nav height */
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: #0a0a0a;
        }
        
        /* Override Leaflet dark theme */
        .leaflet-container {
            background: #0a0a0a;
            font-family: 'Instrument Sans', -apple-system, sans-serif;
        }
        
        .leaflet-control-zoom a {
            background: #1a1a1a !important;
            color: #f5f5f5 !important;
            border-color: #2a2a2a !important;
        }
        
        .leaflet-control-zoom a:hover {
            background: #2a2a2a !important;
        }
        
        .leaflet-control-attribution {
            background: rgba(10, 10, 10, 0.8) !important;
            color: #707070 !important;
            font-size: 10px !important;
        }
        
        .leaflet-control-attribution a {
            color: #a0a0a0 !important;
        }
        
        /* Map Legend / Filter Panel */
        .map-legend {
            position: absolute;
            bottom: 16px;
            left: 16px;
            z-index: 1000;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            min-width: 200px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .map-legend.collapsed {
            transform: translateX(-calc(100% + 16px));
            opacity: 0;
            pointer-events: none;
        }
        
        .legend-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .legend-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #f5f5f5;
            margin: 0;
        }
        
        .legend-close {
            background: none;
            border: none;
            color: #707070;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }
        
        .legend-close:hover {
            color: #f5f5f5;
        }
        
        .legend-filters {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .legend-filter {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
        }
        
        .legend-filter input[type="checkbox"] {
            display: none;
        }
        
        .filter-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            flex-shrink: 0;
            transition: opacity 0.2s;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .legend-filter input:not(:checked) ~ .filter-dot {
            opacity: 0.25;
        }
        
        .filter-label {
            font-size: 0.95rem;
            color: #f5f5f5;
            font-weight: 400;
        }
        
        .legend-filter input:not(:checked) ~ .filter-label {
            color: #707070;
        }
        
        .filter-count {
            margin-left: auto;
            font-size: 0.75rem;
            color: #707070;
            font-weight: 500;
        }
        
        /* Toggle Legend Button — positioned right of zoom controls */
        .legend-toggle {
            position: absolute;
            bottom: 16px;
            left: 56px;
            z-index: 999;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            padding: 10px 14px;
            color: #f5f5f5;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }
        
        .legend-toggle.visible {
            display: flex;
        }
        
        /* Stats bar */
        .map-stats {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 0.85rem;
            color: #a0a0a0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }
        
        .map-stats .stat-highlight {
            color: #d4af37;
            font-weight: 700;
        }
        
        /* Loading overlay */
        .map-loading {
            position: absolute;
            inset: 0;
            z-index: 1001;
            background: rgba(10, 10, 10, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            transition: opacity 0.5s ease;
        }
        
        .map-loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .map-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #2a2a2a;
            border-top-color: #d4af37;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .map-loading-text {
            color: #a0a0a0;
            font-size: 0.95rem;
        }
        
        /* Location popup */
        .leaflet-popup-content-wrapper {
            background: #1a1a1a !important;
            border: 1px solid #2a2a2a !important;
            border-radius: 10px !important;
            color: #f5f5f5 !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4) !important;
        }
        
        .leaflet-popup-tip {
            background: #1a1a1a !important;
            border: 1px solid #2a2a2a !important;
        }
        
        .leaflet-popup-close-button {
            color: #707070 !important;
        }
        
        .leaflet-popup-close-button:hover {
            color: #f5f5f5 !important;
        }
        
        .popup-content {
            padding: 4px 0;
        }
        
        .popup-type {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 2px 8px;
            border-radius: 4px;
            margin-bottom: 6px;
        }
        
        .popup-name {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .popup-detail {
            font-size: 0.85rem;
            color: #a0a0a0;
        }
        
        /* Add To Map — rainbow wrapper + white inner button */
        .add-to-map-wrap {
            position: absolute;
            bottom: 80px;
            right: 76px;
            z-index: 1000;
            padding: 2px;
            border-radius: 12px;
            background: linear-gradient(135deg, #e06060, #e0b040, #50c050, #4090e0, #9050d0);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .add-to-map-wrap:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .add-to-map-btn {
            display: block;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 700;
            font-family: 'Instrument Sans', -apple-system, sans-serif;
            color: #111;
            background: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
        }

        /* Locate me button */
        .locate-btn {
            position: absolute;
            bottom: 80px;
            right: 16px;
            z-index: 1000;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            padding: 12px;
            color: #f5f5f5;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            transition: background 0.2s;
        }
        
        .locate-btn:hover {
            background: rgba(40, 40, 40, 0.95);
        }
        
        .locate-btn svg {
            display: block;
            width: 20px;
            height: 20px;
        }

        /* ── iOS-style pulsing current location marker ─── */
        .user-location-marker {
            position: relative;
            width: 21px;
            height: 21px;
        }

        /* Green pulse waves — 2 gentle staggered rings */
        .user-location-pulse,
        .user-location-pulse2 {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 17px;
            height: 17px;
            border-radius: 50%;
            background: rgba(0, 220, 80, 0.35);
            transform: translate(-50%, -50%) scale(1);
            will-change: transform, opacity;
        }
        /* Hidden on mobile — only show on desktop */
        .user-location-pulse3,
        .user-location-pulse4 { display: none; }
        .user-location-pulse  { animation: locationPulse 4s ease-out infinite 0s; }
        .user-location-pulse2 { animation: locationPulse 4s ease-out infinite 2s; }

        /* The dot itself — black fill, white outline */
        .user-location-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #0a0a0a;
            border: 2.5px solid #ffffff;
            box-shadow: 0 0 8px rgba(0, 220, 80, 0.5);
            z-index: 2;
        }

        @keyframes locationPulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.7;
            }
            100% {
                transform: translate(-50%, -50%) scale(4.5);
                opacity: 0;
            }
        }

        /* ── Location Prompt Modal ─────────────────────── */
        .location-prompt-overlay {
            position: absolute;
            inset: 0;
            z-index: 1002;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.4s ease;
        }

        .location-prompt-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .location-prompt {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.6);
            text-align: center;
        }

        .location-prompt-icon {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .location-prompt-icon svg {
            width: 28px;
            height: 28px;
            color: #d4af37;
        }

        .location-prompt h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #f5f5f5;
            margin: 0 0 6px;
        }

        .location-prompt p {
            font-size: 0.9rem;
            color: #8e8e93;
            margin: 0 0 24px;
            line-height: 1.4;
        }

        .location-prompt-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .location-prompt-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 20px;
            border-radius: 12px;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        .location-prompt-btn:active {
            transform: scale(0.98);
        }

        .location-prompt-btn svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .location-prompt-btn.primary {
            background: #d4af37;
            color: #0a0a0a;
        }

        .location-prompt-btn.primary:hover {
            background: #e0bf4a;
        }

        .location-prompt-btn.primary.loading {
            opacity: 0.7;
            cursor: default;
        }

        .location-prompt-btn.secondary {
            background: #2a2a2a;
            color: #f5f5f5;
        }

        .location-prompt-btn.secondary:hover {
            background: #333;
        }

        .location-prompt-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 4px 0;
        }

        .location-prompt-divider::before,
        .location-prompt-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #2a2a2a;
        }

        .location-prompt-divider span {
            font-size: 0.75rem;
            color: #707070;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .location-prompt-search {
            display: flex;
            gap: 8px;
        }

        .location-prompt-search input {
            flex: 1;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid #2a2a2a;
            background: #0f0f0f;
            color: #f5f5f5;
            font-size: 0.9rem;
            font-family: inherit;
            outline: none;
        }

        .location-prompt-search input::placeholder {
            color: #555;
        }

        .location-prompt-search input:focus {
            border-color: #d4af37;
        }

        .location-prompt-search button {
            padding: 12px 16px;
            border-radius: 10px;
            border: none;
            background: #2a2a2a;
            color: #f5f5f5;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }

        .location-prompt-search button:hover {
            background: #3a3a3a;
        }

        .location-prompt-skip {
            background: none;
            border: none;
            color: #707070;
            font-size: 0.85rem;
            font-family: inherit;
            cursor: pointer;
            padding: 8px;
            margin-top: 4px;
            transition: color 0.2s;
        }

        .location-prompt-skip:hover {
            color: #a0a0a0;
        }
        
        /* Drag handle — hidden on desktop */
        .legend-drag-handle {
            display: none;
        }

        /* Legend backdrop — hidden on desktop */
        .legend-backdrop {
            display: none;
        }

        /* Cluster styling overrides */
        .marker-cluster {
            background-clip: padding-box;
        }
        
        .marker-cluster div {
            width: 30px;
            height: 30px;
            margin-left: 5px;
            margin-top: 5px;
            text-align: center;
            border-radius: 50%;
            font: 12px 'Instrument Sans', -apple-system, sans-serif;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .marker-cluster-small {
            background: rgba(0, 0, 0, 0.25);
        }
        .marker-cluster-small div {
            width: 28px;
            height: 28px;
            font-size: 11px;
        }
        
        .marker-cluster-medium {
            background: rgba(0, 0, 0, 0.3);
        }
        .marker-cluster-medium div {
            width: 32px;
            height: 32px;
            font-size: 12px;
        }
        
        .marker-cluster-large {
            background: rgba(0, 0, 0, 0.35);
        }
        .marker-cluster-large div {
            width: 36px;
            height: 36px;
            font-size: 13px;
        }
        
        /* ── Mobile-first improvements ─────────────────────── */
        @media (max-width: 768px) {
            .map-wrapper {
                margin-top: 52px;
            }

            /* Legend panel — compact floating card, top-right on mobile */
            .map-legend {
                top: 8px;
                right: 8px;
                bottom: auto;
                left: auto;
                min-width: auto;
                width: auto;
                border-radius: 12px;
                padding: 10px 12px 10px;
                max-height: none;
                overflow-y: visible;
            }

            .map-legend.collapsed {
                transform: translateX(calc(100% + 12px));
                opacity: 0;
            }

            /* Hide drag handle on mobile — not needed for floating card */
            .legend-drag-handle {
                display: none;
            }

            .legend-header {
                margin-bottom: 8px;
            }

            .legend-header h3 {
                font-size: 0.85rem;
            }

            .legend-close {
                font-size: 1rem;
            }

            .legend-filters {
                gap: 4px;
            }

            .legend-filter {
                padding: 3px 0;
                gap: 8px;
                min-height: auto;
            }

            .filter-dot {
                width: 10px;
                height: 10px;
                border-width: 1.5px;
            }

            .filter-label {
                font-size: 0.75rem;
            }

            .filter-count {
                font-size: 0.65rem;
            }

            /* Legend backdrop — hide for floating card */
            .legend-backdrop {
                display: none !important;
            }

            /* Legend toggle — bottom-right on mobile */
            .legend-toggle {
                top: auto;
                bottom: 10px;
                left: auto;
                right: 12px;
                padding: 8px 12px;
                font-size: 0.75rem;
                min-height: 36px;
                border-radius: 10px;
                gap: 6px;
                padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
            }
            .legend-toggle svg {
                width: 26px;
                height: 13px;
            }

            /* Hide Add To Map on mobile */
            .add-to-map-wrap {
                display: none;
            }

            /* Hide zoom controls on mobile (pinch to zoom) */
            .leaflet-control-zoom {
                display: none !important;
            }
            
            /* Stats bar — bottom left, safe-area aware */
            .map-stats {
                bottom: 10px;
                left: 12px;
                transform: none;
                font-size: 0.8rem;
                padding: 8px 16px;
                gap: 8px;
                border-radius: 8px;
                padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
            }

            /* Locate me — bottom-left, above stats bar */
            .locate-btn {
                top: auto;
                bottom: 48px;
                left: 12px;
                right: auto;
                padding: 10px;
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                padding-bottom: 10px;
            }

            .locate-btn svg {
                width: 22px;
                height: 22px;
            }

            /* Location prompt — full-width on mobile */
            .location-prompt {
                width: 94%;
                padding: 24px 20px;
                border-radius: 14px;
            }

            .location-prompt h3 {
                font-size: 1.15rem;
            }

            .location-prompt p {
                font-size: 0.85rem;
                margin-bottom: 20px;
            }

            .location-prompt-btn {
                padding: 13px 18px;
                font-size: 0.92rem;
                min-height: 48px;
            }

            .location-prompt-search input {
                padding: 12px 14px;
                font-size: 16px; /* prevent iOS auto-zoom on focus */
            }

            .location-prompt-search button {
                min-width: 48px;
                min-height: 48px;
            }

            /* Popup sizing */
            .leaflet-popup-content-wrapper {
                max-width: 240px !important;
            }

            .popup-name {
                font-size: 0.9rem;
            }

            .popup-detail {
                font-size: 0.8rem;
            }
        }

        /* Small phones */
        @media (max-width: 380px) {
            .legend-toggle {
                padding: 6px 10px;
                font-size: 0.7rem;
                gap: 5px;
            }

            .map-stats {
                font-size: 0.72rem;
                padding: 6px 12px;
            }
        }

        /* ═══════════════════════════════════════════════════════
           Search Bar + Overlay (matches iOS CatholicSearchOverlay)
           ═══════════════════════════════════════════════════════ */
        .map-search-bar { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); z-index: 1001; display: flex; align-items: center; gap: 10px; background: rgba(20,20,20,0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid #2a2a2a; border-radius: 22px; padding: 10px 16px; cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,0.4); width: 100%; max-width: 560px; box-sizing: border-box; }
        .map-search-bar svg { flex-shrink: 0; color: #888; }
        .map-search-placeholder { flex: 1; overflow: hidden; white-space: nowrap; }
        .map-search-placeholder-inner { display: inline-flex; align-items: baseline; }
        .map-search-placeholder-static { color: #888; font-size: 0.95rem; }
        .map-search-placeholder-words { display: inline-grid; margin-left: 0.3em; }
        .map-search-placeholder-words > span { grid-area: 1 / 1; }
        .map-search-placeholder-word { color: #6699ff; font-size: 0.95rem; opacity: 0; transition: opacity 0.5s ease; white-space: nowrap; }
        .map-search-placeholder-word.active { opacity: 1; }

        /* Search overlay */
        .map-search-overlay { position: fixed; inset: 0; z-index: 9999; background: #0D0D10; display: none; flex-direction: column; }
        .map-search-overlay.active { display: flex; }
        .map-search-header { display: flex; align-items: center; gap: 10px; padding: 12px 16px; border-bottom: 1px solid #1e1e1e; background: #141414; flex-shrink: 0; }
        .map-search-back { width: 36px; height: 36px; border-radius: 50%; border: none; background: none; color: #999; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .map-search-back:hover { color: #f5f5f5; }
        .map-search-input { flex: 1; padding: 8px 12px; border-radius: 18px; border: 1px solid #2a2a2a; background: #1a1a1a; font-size: 1rem; font-family: inherit; color: #f5f5f5; outline: none; }
        .map-search-input::placeholder { color: #666; }
        .map-search-input:focus { box-shadow: 0 0 0 2px rgba(51,102,204,0.3); }
        .map-search-clear { width: 28px; height: 28px; border-radius: 50%; border: none; background: #2a2a2a; color: #888; cursor: pointer; display: none; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0; }
        .map-search-clear.visible { display: flex; }

        /* Results */
        .map-search-results { flex: 1; overflow-y: auto; padding: 0; overscroll-behavior: contain; }
        .map-search-section-title { font-size: 0.72rem; font-weight: 700; color: #666; text-transform: uppercase; letter-spacing: 0.8px; padding: 16px 16px 6px; }
        .map-search-row { display: flex; align-items: center; gap: 12px; padding: 10px 16px; cursor: pointer; transition: background 0.15s; }
        .map-search-row:hover { background: #1a1a1a; }
        .map-search-row:active { background: #222; }
        .map-search-row-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.85rem; }
        .map-search-row-info { flex: 1; min-width: 0; }
        .map-search-row-title { font-size: 0.92rem; font-weight: 600; color: #f5f5f5; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .map-search-row-subtitle { font-size: 0.78rem; color: #888; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .map-search-row-badge { font-size: 0.65rem; font-weight: 600; color: #888; background: #1e1e1e; padding: 2px 8px; border-radius: 10px; flex-shrink: 0; white-space: nowrap; }
        .map-search-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem 1rem; color: #666; text-align: center; }
        .map-search-empty svg { width: 40px; height: 40px; color: #444; margin-bottom: 12px; }
        .map-search-empty-text { font-size: 0.9rem; }
        .map-search-divider { height: 1px; background: #1e1e1e; margin: 0 16px; }

        @media (max-width: 768px) {
            .map-search-bar { top: 10px; left: 50%; right: auto; transform: translateX(-50%); width: fit-content; max-width: calc(100% - 104px); padding: 9px 14px; border-radius: 14px; gap: 6px; font-size: 0.82rem; }
            .map-search-placeholder { flex: 0 0 auto; }
            .map-search-placeholder-static, .map-search-placeholder-word { font-size: 0.78rem; }
            .map-search-bar svg { width: 14px; height: 14px; }
            .map-search-header { padding: 10px 12px; padding-top: calc(10px + env(safe-area-inset-top, 0px)); }
            .map-search-input { font-size: 0.95rem; }
            .map-search-row { padding: 9px 14px; gap: 10px; }
            .map-search-row-icon { width: 28px; height: 28px; font-size: 0.75rem; }
            .map-search-row-title { font-size: 0.85rem; }
            .map-search-row-subtitle { font-size: 0.72rem; }
        }

        /* ═══════════════════════════════════════════════════════
           Entity Detail Panel (matches iOS Prime Detail Views)
           ═══════════════════════════════════════════════════════ */
        .entity-detail-overlay { position: fixed; inset: 0; z-index: 9998; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: none; justify-content: center; align-items: flex-end; transition: opacity 0.3s; }
        .entity-detail-overlay.active { display: flex; }
        .entity-detail-panel { background: #141416; border-radius: 20px 20px 0 0; width: 100%; max-width: 540px; max-height: 85vh; overflow-y: auto; animation: slideUpDetail 0.35s ease-out; overscroll-behavior: contain; }
        @keyframes slideUpDetail { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .entity-detail-handle { display: flex; justify-content: center; padding: 10px 0 4px; cursor: grab; }
        .entity-detail-handle span { width: 36px; height: 4px; border-radius: 2px; background: #444; }
        .entity-detail-header { display: flex; align-items: flex-start; gap: 14px; padding: 8px 20px 16px; }
        .entity-detail-icon { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; background: #1e1e1e; }
        .entity-detail-header-info { flex: 1; min-width: 0; }
        .entity-detail-name { font-size: 1.25rem; font-weight: 700; color: #f5f5f5; line-height: 1.3; margin: 0 0 2px; }
        .entity-detail-type-badge { display: inline-block; font-size: 0.72rem; font-weight: 600; color: #999; background: #1e1e1e; padding: 2px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .entity-detail-close { width: 32px; height: 32px; border-radius: 50%; border: none; background: #2a2a2a; color: #999; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; transition: background 0.2s; }
        .entity-detail-close:hover { background: #3a3a3a; }
        .entity-detail-card { margin: 0 16px 16px; padding: 16px; border-radius: 16px; background: #1a1a1a; position: relative; }
        .entity-detail-card.rainbow { border: 2px solid transparent; background-clip: padding-box; }
        .entity-detail-card.rainbow::before { content: ''; position: absolute; inset: -2px; border-radius: 18px; background: linear-gradient(135deg, #EF4444, #F97316, #EAB308, #22C55E, #06B6D4, #3B82F6, #8B5CF6); z-index: -1; }
        .entity-detail-location { display: flex; align-items: center; gap: 6px; color: #999; font-size: 0.88rem; margin-bottom: 12px; }
        .entity-detail-location svg { width: 14px; height: 14px; flex-shrink: 0; }
        .entity-detail-description { font-size: 0.9rem; line-height: 1.6; color: #ccc; margin-bottom: 12px; }
        .entity-detail-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        .entity-detail-action-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 10px; border: 1px solid #333; background: #1e1e1e; color: #6699ff; font-size: 0.82rem; font-weight: 600; cursor: pointer; text-decoration: none; transition: background 0.2s, transform 0.1s; }
        .entity-detail-action-btn:hover { background: #252525; transform: translateY(-1px); }
        .entity-detail-action-btn svg { width: 14px; height: 14px; }
        .entity-detail-action-btn.primary-action { background: rgba(51,102,204,0.15); border-color: rgba(51,102,204,0.3); color: #6699ff; }
        .entity-detail-section-title { font-size: 0.75rem; font-weight: 700; color: #666; text-transform: uppercase; letter-spacing: 0.8px; padding: 12px 20px 6px; }
        .entity-detail-schedule { margin: 0 16px 8px; padding: 12px 14px; background: #1a1a1a; border-radius: 12px; }
        .entity-detail-schedule-row { display: flex; justify-content: space-between; font-size: 0.82rem; color: #aaa; padding: 3px 0; }
        .entity-detail-schedule-row .day { color: #ccc; font-weight: 500; }
        .entity-detail-schedule-row .times { text-align: right; color: #999; }
        .entity-detail-events { margin: 0 16px 12px; }
        .entity-detail-event-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 14px; background: #1a1a1a; border-radius: 12px; margin-bottom: 6px; position: relative; border: 1.5px solid transparent; }
        .entity-detail-event-item::before { content: ''; position: absolute; inset: -1.5px; border-radius: 14px; background: linear-gradient(135deg, #EF4444, #F97316, #EAB308, #22C55E, #06B6D4, #3B82F6, #8B5CF6); z-index: -1; }
        .entity-detail-event-date { width: 44px; text-align: center; flex-shrink: 0; }
        .entity-detail-event-date .month { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: #EF4444; }
        .entity-detail-event-date .day-num { font-size: 1.1rem; font-weight: 700; color: #f5f5f5; }
        .entity-detail-event-info { flex: 1; }
        .entity-detail-event-title { font-size: 0.85rem; font-weight: 600; color: #f5f5f5; }
        .entity-detail-event-time { font-size: 0.78rem; color: #888; margin-top: 2px; }
        .entity-detail-programs { display: flex; flex-wrap: wrap; gap: 6px; margin: 0 16px 16px; }
        .entity-detail-program-pill { display: inline-flex; align-items: center; gap: 4px; padding: 5px 10px; background: rgba(34, 197, 94, 0.12); border: 1px solid rgba(34, 197, 94, 0.25); border-radius: 8px; color: #22C55E; font-size: 0.75rem; font-weight: 600; }
        .entity-detail-info-grid { margin: 0 16px 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .entity-detail-info-item { padding: 10px 12px; background: #1a1a1a; border-radius: 10px; }
        .entity-detail-info-label { font-size: 0.68rem; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        .entity-detail-info-value { font-size: 0.88rem; color: #f5f5f5; font-weight: 500; }
        .entity-detail-info-full { margin: 0 16px 8px; padding: 12px 14px; background: #1a1a1a; border-radius: 12px; }
        .entity-detail-info-full .info-title { font-size: 0.82rem; font-weight: 600; color: #ccc; margin-bottom: 4px; }
        .entity-detail-info-full .info-text { font-size: 0.82rem; color: #999; line-height: 1.5; }
        .entity-detail-stats { display: flex; gap: 8px; margin: 0 16px 12px; }
        .entity-detail-stat { flex: 1; padding: 12px; background: #1a1a1a; border-radius: 12px; text-align: center; }
        .entity-detail-stat .stat-value { font-size: 1.25rem; font-weight: 700; color: #d4af37; }
        .entity-detail-stat .stat-label { font-size: 0.68rem; color: #888; margin-top: 2px; }
        .entity-detail-contact { margin: 0 16px 16px; padding: 12px 14px; background: #1a1a1a; border-radius: 12px; }
        .entity-detail-contact-row { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 0.85rem; }
        .entity-detail-contact-row svg { width: 14px; height: 14px; color: #666; flex-shrink: 0; }
        .entity-detail-contact-row a { color: #6699ff; text-decoration: none; }
        .entity-detail-contact-row span { color: #ccc; }
        .entity-detail-footer { padding: 12px 16px 24px; display: flex; gap: 8px; }
        .entity-detail-footer-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: background 0.2s, transform 0.1s; }
        .entity-detail-footer-btn:hover { transform: translateY(-1px); }
        .entity-detail-footer-btn.primary { background: #3366CC; color: #fff; }
        .entity-detail-footer-btn.secondary { background: #1e1e1e; border: 1px solid #333; color: #ccc; }
        .entity-detail-footer-btn svg { width: 16px; height: 16px; }
        .entity-detail-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; gap: 12px; }
        .entity-detail-spinner { width: 32px; height: 32px; border: 3px solid #333; border-top-color: #3366CC; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .entity-detail-loading-text { font-size: 0.85rem; color: #888; }
        .entity-detail-hours { margin: 0 16px 12px; padding: 12px 14px; background: #1a1a1a; border-radius: 12px; }
        .entity-detail-hours-row { display: flex; justify-content: space-between; font-size: 0.82rem; color: #aaa; padding: 3px 0; }
        .entity-detail-hours-row .day { color: #ccc; font-weight: 500; }
        .entity-detail-hours-row .time { color: #999; text-align: right; }
        .entity-detail-social { display: flex; gap: 8px; margin: 0 16px 16px; flex-wrap: wrap; }
        .entity-detail-social a { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #6699ff; font-size: 0.78rem; font-weight: 600; text-decoration: none; }
        @media (min-width: 769px) { .entity-detail-overlay { align-items: center; } .entity-detail-panel { border-radius: 20px; max-height: 80vh; } }
        @media (max-width: 768px) { .entity-detail-panel { max-height: 90vh; } .entity-detail-header { padding: 6px 16px 12px; } .entity-detail-name { font-size: 1.15rem; } .entity-detail-card { margin: 0 12px 12px; } .entity-detail-footer { padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px)); } }
    </style>
</head>
<body class="map-page">
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-logo">
                <img src="assets/whitenavelogo.png" alt="Nave" class="logo-img">
                <span class="logo-text">Nave</span>
            </a>
            <div class="nav-links" id="nav-links">
                <a href="map.html" class="nav-link nav-link-active">Map</a>
                <a href="engage.html" class="nav-link">Engage</a>
                <a href="ask-gabe.html" class="nav-link">Ask</a>
                <a href="about.html" class="nav-link">About</a>
                <a href="join.html" class="nav-cta">Try Nave Free</a>
            </div>
            <button class="nav-hamburger" id="nav-hamburger" aria-label="Menu" onclick="document.getElementById('nav-links').classList.toggle('open');document.getElementById('nav-backdrop').classList.toggle('visible');">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </button>
        </div>
    </nav>
    <div class="nav-backdrop" id="nav-backdrop" onclick="document.getElementById('nav-links').classList.remove('open');this.classList.remove('visible');"></div>

    <!-- Map Container -->
    <div class="map-wrapper">
        <!-- Search Bar -->
        <div class="map-search-bar" id="map-search-bar" onclick="openMapSearch()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <div class="map-search-placeholder" id="search-placeholder">
                <span class="map-search-placeholder-inner">
                    <span class="map-search-placeholder-static">Search Catholic</span><span class="map-search-placeholder-words"><span class="map-search-placeholder-word active" data-idx="0">Culture</span><span class="map-search-placeholder-word" data-idx="1">Churches</span><span class="map-search-placeholder-word" data-idx="2">Missionaries</span><span class="map-search-placeholder-word" data-idx="3">Businesses</span><span class="map-search-placeholder-word" data-idx="4">Schools</span><span class="map-search-placeholder-word" data-idx="5">Vocations</span><span class="map-search-placeholder-word" data-idx="6">Retreats</span><span class="map-search-placeholder-word" data-idx="7">Pilgrimages</span><span class="map-search-placeholder-word" data-idx="8">Campus</span></span>
                </span>
            </div>
        </div>

        <!-- Search Overlay -->
        <div class="map-search-overlay" id="map-search-overlay">
            <div class="map-search-header">
                <button class="map-search-back" onclick="closeMapSearch()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                </button>
                <input type="text" class="map-search-input" id="map-search-input" placeholder="Search Catholic Culture" autocomplete="off">
                <button class="map-search-clear" id="map-search-clear" onclick="clearMapSearch()">&times;</button>
            </div>
            <div class="map-search-results" id="map-search-results">
                <div class="map-search-empty" id="map-search-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <div class="map-search-empty-text">Search across all Catholic resources</div>
                </div>
            </div>
        </div>

        <!-- Location Prompt -->
        <div id="location-prompt-overlay" class="location-prompt-overlay">
            <div class="location-prompt">
                <div class="location-prompt-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                </div>
                <h3>Where are you?</h3>
                <p>Help us show Catholic resources near you</p>
                <div class="location-prompt-actions">
                    <button class="location-prompt-btn primary" id="use-my-location-btn" onclick="useMyLocation()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                        </svg>
                        Use My Location
                    </button>

                    <div class="location-prompt-divider"><span>or</span></div>

                    <div class="location-prompt-search">
                        <input type="text" id="city-search-input" placeholder="Enter city or zip code" autocomplete="off">
                        <button onclick="searchCity()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            </svg>
                        </button>
                    </div>

                    <button class="location-prompt-skip" onclick="dismissPrompt()">
                        Browse the full map →
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="map-loading" class="map-loading">
            <div class="map-loading-spinner"></div>
            <div class="map-loading-text">Loading Catholic locations...</div>
        </div>
        
        <!-- Map -->
        <div id="map"></div>
        
        <!-- Add To Map Button (desktop only) -->
        <div class="add-to-map-wrap"><a href="join.html" class="add-to-map-btn">Add To Map</a></div>

        <!-- Legend / Filters -->
        <div id="map-legend" class="map-legend">
            <div class="legend-drag-handle" onclick="toggleLegend()"><span></span></div>
            <div class="legend-header">
                <h3>Map Legend</h3>
                <button class="legend-close" onclick="toggleLegend()">&times;</button>
            </div>
            <div class="legend-filters">
                <label class="legend-filter">
                    <input type="checkbox" data-type="church" checked>
                    <span class="filter-dot" style="background: #3B82F6;"></span>
                    <span class="filter-label">Church</span>
                    <span class="filter-count" id="count-church">0</span>
                </label>
                <label class="legend-filter">
                    <input type="checkbox" data-type="missionary" checked>
                    <span class="filter-dot" style="background: #D4A017;"></span>
                    <span class="filter-label">Missionary</span>
                    <span class="filter-count" id="count-missionary">0</span>
                </label>
                <label class="legend-filter">
                    <input type="checkbox" data-type="pilgrimage" checked>
                    <span class="filter-dot" style="background: #EF4444;"></span>
                    <span class="filter-label">Pilgrimage</span>
                    <span class="filter-count" id="count-pilgrimage">0</span>
                </label>
                <label class="legend-filter">
                    <input type="checkbox" data-type="school" checked>
                    <span class="filter-dot" style="background: #A855F7;"></span>
                    <span class="filter-label">Education</span>
                    <span class="filter-count" id="count-school">0</span>
                </label>
                <label class="legend-filter">
                    <input type="checkbox" data-type="vocation" checked>
                    <span class="filter-dot" style="background: #22C55E;"></span>
                    <span class="filter-label">Vocation</span>
                    <span class="filter-count" id="count-vocation">0</span>
                </label>
                <label class="legend-filter">
                    <input type="checkbox" data-type="retreat" checked>
                    <span class="filter-dot" style="background: #F97316;"></span>
                    <span class="filter-label">Retreat</span>
                    <span class="filter-count" id="count-retreat">0</span>
                </label>
                <label class="legend-filter">
                    <input type="checkbox" data-type="business" checked>
                    <span class="filter-dot" style="background: #A1887F;"></span>
                    <span class="filter-label">Business</span>
                    <span class="filter-count" id="count-business">0</span>
                </label>
                <label class="legend-filter">
                    <input type="checkbox" data-type="campus" checked>
                    <span class="filter-dot" style="background: #166534;"></span>
                    <span class="filter-label">Campus</span>
                    <span class="filter-count" id="count-campus">0</span>
                </label>
            </div>
        </div>
        
        <!-- Toggle Legend Button (when legend is hidden) -->
        <button id="legend-toggle" class="legend-toggle" onclick="toggleLegend()">
            <span class="legend-toggle-label">Map Legend</span>
            <svg width="28" height="14" viewBox="0 0 28 14" fill="currentColor">
                <circle cx="2.5" cy="3.5" r="2.4" fill="#3B82F6"/>
                <circle cx="9.5" cy="3.5" r="2.4" fill="#D4A017"/>
                <circle cx="16.5" cy="3.5" r="2.4" fill="#EF4444"/>
                <circle cx="23.5" cy="3.5" r="2.4" fill="#A855F7"/>
                <circle cx="2.5" cy="10.5" r="2.4" fill="#22C55E"/>
                <circle cx="9.5" cy="10.5" r="2.4" fill="#F97316"/>
                <circle cx="16.5" cy="10.5" r="2.4" fill="#A1887F"/>
                <circle cx="23.5" cy="10.5" r="2.4" fill="#166534"/>
            </svg>
        </button>
        
        <!-- Legend backdrop (mobile only — closes legend on tap) -->
        <div id="legend-backdrop" class="legend-backdrop" onclick="toggleLegend()"></div>

        <!-- Locate Me Button -->
        <button class="locate-btn" onclick="locateMe()" title="Find my location">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
            </svg>
        </button>
        
        <!-- Stats Bar -->
        <div class="map-stats">
            <span><span class="stat-highlight" id="total-visible">0</span> Cultural Keys</span>
        </div>
    </div>

    <!-- Entity Detail Panel -->
    <div class="entity-detail-overlay" id="entity-detail-overlay">
        <div class="entity-detail-panel" id="entity-detail-panel">
            <div class="entity-detail-handle"><span></span></div>
            <div id="entity-detail-content"></div>
        </div>
    </div>

    <!-- Waitlist Popup (30s) -->
    <div id="map-waitlist-overlay" class="location-prompt-overlay hidden" style="z-index: 1100;">
        <div class="location-prompt" style="text-align: center;">
            <button onclick="closeMapWaitlist()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:#707070;font-size:1.5rem;cursor:pointer;line-height:1;">&times;</button>
            <div class="location-prompt-icon" style="margin: 0 auto 16px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="#d4af37" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
            </div>
            <h3 style="color:#f5f5f5;font-size:1.25rem;margin:0 0 8px;">Join the Waitlist</h3>
            <p style="color:#888;font-size:0.9rem;margin:0 0 20px;">Love exploring? Be the first to know when Nave launches on iOS.</p>
            <form id="map-waitlist-form">
                <input type="email" id="map-waitlist-email" placeholder="you@email.com" required style="width:100%;padding:12px 16px;font-size:1rem;border:1px solid #333;border-radius:10px;background:#111;color:#f5f5f5;margin-bottom:12px;box-sizing:border-box;">
                <button type="submit" class="map-waitlist-btn" style="width:100%;padding:12px;font-size:1rem;font-weight:600;color:#000;background:#fff;border:none;border-radius:10px;cursor:pointer;">Join the Waitlist</button>
            </form>
            <div id="map-waitlist-success" class="hidden" style="padding:20px 0;">
                <svg width="48" height="48" viewBox="0 0 20 20" fill="none" style="margin:0 auto 12px;display:block;">
                    <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm-2 15l-5-5 1.41-1.41L8 12.17l7.59-7.59L17 6l-9 9z" fill="#d4af37"/>
                </svg>
                <p style="color:#f5f5f5;font-size:1rem;">You're on the list! We'll be in touch.</p>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase config (same project as iOS app)
        const firebaseConfig = {
            apiKey: "AIzaSyDMzrI35yZxIlUr-OJ56acE_bMnYnrHoEw",
            authDomain: "navefirebase.firebaseapp.com",
            projectId: "navefirebase",
            storageBucket: "navefirebase.firebasestorage.app",
            messagingSenderId: "701712826975",
            appId: "1:701712826975:web:placeholder"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Pin colors matching iOS app
        const PIN_COLORS = {
            church: '#3B82F6',
            missionary: '#D4A017',
            pilgrimage: '#EF4444',
            school: '#A855F7',
            vocation: '#22C55E',
            retreat: '#F97316',
            business: '#A1887F',
            campus: '#166534'
        };
        
        // Collection mapping (must match Firebase exactly)
        const COLLECTIONS = {
            church: 'Churches',
            missionary: 'missionaries',
            pilgrimage: 'pilgrimageSites',
            school: 'schools',
            vocation: 'vocations',
            retreat: 'retreats',
            business: 'businesses',
            campus: 'bibleStudies'
        };
        
        // Initialize map
        const map = L.map('map', {
            center: [39.5, -98.35],  // Center of US
            zoom: 5,
            zoomControl: true,
            attributionControl: true
        });
        
        // Dark-themed tile layer (CartoDB Dark Matter)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // Create color-coded cluster icon factory
        function createClusterIcon(type) {
            return function(cluster) {
                const count = cluster.getChildCount();
                let size = 'small';
                if (count >= 100) size = 'large';
                else if (count >= 10) size = 'medium';
                
                const color = PIN_COLORS[type];
                const dims = size === 'large' ? 44 : size === 'medium' ? 40 : 36;
                const innerDims = dims - 8;
                
                return L.divIcon({
                    html: `<div style="background:${color}; width:${innerDims}px; height:${innerDims}px;">${count}</div>`,
                    className: `marker-cluster marker-cluster-${size}`,
                    iconSize: L.point(dims, dims)
                });
            };
        }
        
        // Cluster layer groups for each type
        const layers = {};
        const markerCounts = {};
        
        Object.keys(PIN_COLORS).forEach(type => {
            // Churches cluster more aggressively since there are so many
            const clusterRadius = (type === 'church') ? 200 : 50;
            const unclusterZoom = (type === 'church') ? 9 : 15;
            
            layers[type] = L.markerClusterGroup({
                iconCreateFunction: createClusterIcon(type),
                maxClusterRadius: clusterRadius,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                disableClusteringAtZoom: unclusterZoom
            }).addTo(map);
            markerCounts[type] = 0;
        });
        
        // ── Entity data store ─────────────────────────────────
        const entityDataMap = new Map();

        // Create circle marker — click opens detail panel
        function createMarker(lat, lng, type, name, detail, docId) {
            const marker = L.circleMarker([lat, lng], {
                radius: 6,
                fillColor: PIN_COLORS[type],
                color: '#ffffff',
                weight: 1.5,
                opacity: 0.9,
                fillOpacity: 0.85
            });

            // Click → open full detail panel
            marker.on('click', () => openMapEntityDetail(docId));
            
            return marker;
        }
        
        // Extract coordinates from different document structures
        function getCoords(doc, type) {
            const d = doc.data();
            
            // Missionaries: coordinates nested in locationPrimary { latitude, longitude }
            if (type === 'missionary') {
                if (d.locationPrimary) {
                    const lp = d.locationPrimary;
                    if (lp.latitude !== undefined && lp.longitude !== undefined) {
                        return { lat: lp.latitude, lng: lp.longitude };
                    }
                    if (lp.coordinates) {
                        const c = lp.coordinates;
                        if (c.latitude !== undefined) return { lat: c.latitude, lng: c.longitude };
                    }
                }
                // Also try locationSecondary if primary has no coords
                if (d.locationSecondary) {
                    const ls = d.locationSecondary;
                    if (ls.latitude !== undefined && ls.longitude !== undefined) {
                        return { lat: ls.latitude, lng: ls.longitude };
                    }
                }
            }
            
            // Schools have nested location object
            if (type === 'school') {
                if (d.location?.coordinates) {
                    const c = d.location.coordinates;
                    // GeoPoint
                    if (c.latitude !== undefined) return { lat: c.latitude, lng: c.longitude };
                    if (c._latitude !== undefined) return { lat: c._latitude, lng: c._longitude };
                    // Array [lat, lng]
                    if (Array.isArray(c)) return { lat: c[0], lng: c[1] };
                }
                if (d.location?.latitude !== undefined) return { lat: d.location.latitude, lng: d.location.longitude };
            }
            
            // GeoPoint in coordinates field
            if (d.coordinates) {
                const c = d.coordinates;
                if (c.latitude !== undefined) return { lat: c.latitude, lng: c.longitude };
                if (c._latitude !== undefined) return { lat: c._latitude, lng: c._longitude };
                if (Array.isArray(c)) return { lat: c[0], lng: c[1] };
            }
            
            // Direct lat/lng fields
            if (d.latitude !== undefined && d.longitude !== undefined) {
                return { lat: d.latitude, lng: d.longitude };
            }
            
            // lat/lon fields
            if (d.lat !== undefined && (d.lng !== undefined || d.lon !== undefined)) {
                return { lat: d.lat, lng: d.lng || d.lon };
            }
            
            return null;
        }
        
        // Get name from document
        function getName(doc, type) {
            const d = doc.data();
            return d.name || d.title || d.parishName || 'Unknown';
        }
        
        // Get detail from document
        function getDetail(doc, type) {
            const d = doc.data();
            
            switch (type) {
                case 'church': return d.address || d.city || '';
                case 'missionary': return d.role || d.organization || (d.locationPrimary?.city ? `${d.locationPrimary.city}, ${d.locationPrimary.state || ''}` : '') || '';
                case 'pilgrimage': return d.location || d.city || '';
                case 'school': return d.location?.formatted || d.city || '';
                case 'vocation': return d.location || d.order || '';
                case 'retreat': return d.location || d.city || '';
                case 'business': return d.subcategory || d.category || '';
                case 'campus': return d.location || d.university || '';
                default: return '';
            }
        }
        
        // Load data from Firebase
        async function loadData() {
            const loadingEl = document.getElementById('map-loading');
            let totalLoaded = 0;
            
            const loadPromises = Object.entries(COLLECTIONS).map(async ([type, collectionName]) => {
                try {
                    const snapshot = await getDocs(collection(db, collectionName));
                    let count = 0;
                    
                    snapshot.forEach(doc => {
                        const coords = getCoords(doc, type);
                        if (coords && coords.lat && coords.lng && 
                            Math.abs(coords.lat) <= 90 && Math.abs(coords.lng) <= 180) {
                            const name = getName(doc, type);
                            const detail = getDetail(doc, type);
                            // Store full document data for the detail panel
                            const docId = `${type}_${doc.id}`;
                            entityDataMap.set(docId, { ...doc.data(), _docId: doc.id, _type: type, _coords: coords });
                            const marker = createMarker(coords.lat, coords.lng, type, name, detail, docId);
                            marker.addTo(layers[type]);
                            count++;
                        }
                    });
                    
                    markerCounts[type] = count;
                    document.getElementById(`count-${type}`).textContent = count.toLocaleString();
                    totalLoaded += count;
                    
                } catch (error) {
                    console.warn(`Could not load ${collectionName}:`, error.message);
                }
            });
            
            await Promise.all(loadPromises);
            
            updateVisibleCount();
            
            // Hide loading
            loadingEl.classList.add('hidden');
            setTimeout(() => loadingEl.remove(), 500);
        }
        
        // Update visible count
        window.updateVisibleCount = function() {
            let total = 0;
            document.querySelectorAll('.legend-filter input[type="checkbox"]').forEach(cb => {
                if (cb.checked) {
                    total += markerCounts[cb.dataset.type] || 0;
                }
            });
            document.getElementById('total-visible').textContent = total.toLocaleString();
        };
        
        // Filter toggle handlers
        document.querySelectorAll('.legend-filter input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const type = this.dataset.type;
                if (this.checked) {
                    map.addLayer(layers[type]);
                } else {
                    map.removeLayer(layers[type]);
                }
                updateVisibleCount();
            });
        });
        
        // Legend toggle
        window.toggleLegend = function() {
            const legend = document.getElementById('map-legend');
            const toggle = document.getElementById('legend-toggle');
            const backdrop = document.getElementById('legend-backdrop');
            legend.classList.toggle('collapsed');
            const isCollapsed = legend.classList.contains('collapsed');
            toggle.classList.toggle('visible', isCollapsed);
            // Show/hide backdrop on mobile
            if (backdrop) backdrop.classList.toggle('visible', !isCollapsed);
        };

        // ── Auto-collapse legend on mobile ──
        if (window.innerWidth <= 768) {
            const legend = document.getElementById('map-legend');
            const toggle = document.getElementById('legend-toggle');
            legend.classList.add('collapsed');
            toggle.classList.add('visible');
        }

        // ── Prevent dot shrinking during pinch-zoom on mobile ──
        // Leaflet redraws circles during zoom which causes visual jitter on
        // touch pinch. Disable continuous circle redraws during touch-zoom,
        // only update after zoom ends.
        if ('ontouchstart' in window) {
            let isPinching = false;
            const savedRadii = new Map();

            map.on('zoomstart', () => {
                isPinching = true;
                // Freeze all circle marker radii
                Object.values(layers).forEach(layerGroup => {
                    layerGroup.eachLayer(marker => {
                        if (marker instanceof L.CircleMarker && marker.setRadius) {
                            savedRadii.set(marker, marker.getRadius());
                        }
                    });
                });
            });

            map.on('zoomend', () => {
                isPinching = false;
                // Restore all radii (forces clean redraw at final zoom)
                savedRadii.forEach((radius, marker) => {
                    try { marker.setRadius(radius); } catch(e) {}
                });
                savedRadii.clear();
            });

            // Override the internal _updatePath to freeze during pinch
            const origUpdateStyle = L.CircleMarker.prototype._updateStyle;
            L.CircleMarker.prototype._updateStyle = function() {
                if (isPinching) return;
                origUpdateStyle.call(this);
            };
        }

        // Swipe-down to dismiss legend on mobile
        (function() {
            const legend = document.getElementById('map-legend');
            let startY = 0;
            let currentY = 0;
            let swiping = false;

            legend.addEventListener('touchstart', (e) => {
                // Only enable swipe on the drag handle or at scroll top
                if (legend.scrollTop > 0) return;
                startY = e.touches[0].clientY;
                swiping = true;
            }, { passive: true });

            legend.addEventListener('touchmove', (e) => {
                if (!swiping) return;
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;
                if (diff > 0) {
                    legend.style.transform = `translateY(${diff}px)`;
                }
            }, { passive: true });

            legend.addEventListener('touchend', () => {
                if (!swiping) return;
                swiping = false;
                const diff = currentY - startY;
                legend.style.transform = '';
                if (diff > 80) {
                    toggleLegend();
                }
                currentY = 0;
                startY = 0;
            }, { passive: true });
        })();
        
        // ── User location marker (shared) — iOS-style pulsing dot ──
        let userLocationMarker = null;

        function addUserMarker(lat, lng) {
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
            }

            const pulsingIcon = L.divIcon({
                className: '',
                html: `
                    <div class="user-location-marker">
                        <div class="user-location-pulse"></div>
                        <div class="user-location-pulse2"></div>
                        <div class="user-location-pulse3"></div>
                        <div class="user-location-pulse4"></div>
                        <div class="user-location-dot"></div>
                    </div>
                `,
                iconSize: [21, 21],
                iconAnchor: [11, 11]
            });

            userLocationMarker = L.marker([lat, lng], { icon: pulsingIcon, zIndexOffset: 9999 }).addTo(map);
            userLocationMarker.bindPopup('<div class="popup-content"><div class="popup-name">You are here</div></div>');
        }

        // ── Location Prompt ──────────────────────────────────
        const promptOverlay = document.getElementById('location-prompt-overlay');
        const cityInput = document.getElementById('city-search-input');

        // Check if user already has a saved location
        const savedLocation = localStorage.getItem('nave_user_location');
        if (savedLocation) {
            try {
                const { lat, lng, zoom } = JSON.parse(savedLocation);
                map.setView([lat, lng], zoom || 11);
                addUserMarker(lat, lng);
                // Skip the prompt
                promptOverlay.style.display = 'none';
            } catch (e) {
                // Ignore bad stored data
            }
        }

        // Enter key on city input
        cityInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') searchCity();
        });

        window.dismissPrompt = function() {
            promptOverlay.classList.add('hidden');
            setTimeout(() => promptOverlay.style.display = 'none', 400);
        };

        window.useMyLocation = function() {
            if (!('geolocation' in navigator)) {
                alert('Geolocation is not supported by your browser.');
                return;
            }

            const btn = document.getElementById('use-my-location-btn');
            btn.classList.add('loading');
            btn.innerHTML = `
                <div class="map-loading-spinner" style="width:20px;height:20px;border-width:2px;margin:0;"></div>
                Locating...
            `;

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;
                    map.setView([latitude, longitude], 11);
                    addUserMarker(latitude, longitude);
                    localStorage.setItem('nave_user_location', JSON.stringify({ lat: latitude, lng: longitude, zoom: 11 }));
                    dismissPrompt();
                },
                (err) => {
                    console.warn('Geolocation error:', err);
                    btn.classList.remove('loading');
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                        </svg>
                        Use My Location
                    `;
                    alert('Could not determine your location. Try entering a city instead.');
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        };

        window.searchCity = async function() {
            const query = cityInput.value.trim();
            if (!query) return;

            // Use Nominatim (free geocoding) to find the city
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=us&limit=1`, {
                    headers: { 'Accept-Language': 'en' }
                });
                const results = await res.json();

                if (results.length > 0) {
                    const lat = parseFloat(results[0].lat);
                    const lon = parseFloat(results[0].lon);
                    map.setView([lat, lon], 11);
                    addUserMarker(lat, lon);
                    localStorage.setItem('nave_user_location', JSON.stringify({ lat, lng: lon, zoom: 11 }));
                    dismissPrompt();
                } else {
                    cityInput.style.borderColor = '#EF4444';
                    cityInput.placeholder = 'City not found — try again';
                    cityInput.value = '';
                    setTimeout(() => {
                        cityInput.style.borderColor = '#2a2a2a';
                        cityInput.placeholder = 'Enter city or zip code';
                    }, 2000);
                }
            } catch (err) {
                console.error('Geocoding error:', err);
                alert('Could not search for that location. Please try again.');
            }
        };

        // Locate me button (existing — reuse shared function)
        window.locateMe = function() {
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const { latitude, longitude } = pos.coords;
                        map.setView([latitude, longitude], 11);
                        addUserMarker(latitude, longitude);
                        localStorage.setItem('nave_user_location', JSON.stringify({ lat: latitude, lng: longitude, zoom: 11 }));
                    },
                    (err) => {
                        console.warn('Geolocation error:', err);
                        alert('Could not determine your location. Please enable location services in your browser settings.');
                    },
                    { enableHighAccuracy: false, timeout: 15000, maximumAge: 300000 }
                );
            } else {
                alert('Location services are not available in this browser.');
            }
        };
        
        // ══════════════════════════════════════════════════════
        // ENTITY DETAIL PANEL — iOS Prime Detail Views parity
        // ══════════════════════════════════════════════════════

        const detailOverlay = document.getElementById('entity-detail-overlay');
        const detailContent = document.getElementById('entity-detail-content');
        const detailPanel = document.getElementById('entity-detail-panel');

        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        function getEntityIcon(type) {
            const icons = { church:'⛪', missionary:'✝️', pilgrimage:'🗺️', retreat:'🙏', school:'🎓', vocation:'📿', business:'🏪', campus:'🎒' };
            return icons[type] || '📍';
        }

        function getTypeLabel(type) {
            const labels = { church:'Church', missionary:'Missionary', pilgrimage:'Pilgrimage', retreat:'Retreat', school:'School', vocation:'Vocation', business:'Business', campus:'Campus Ministry' };
            return labels[type] || type;
        }

        // ── Open detail panel ──────────────────────────────
        function openMapEntityDetail(docId) {
            const data = entityDataMap.get(docId);
            if (!data) return;
            detailOverlay.classList.add('active');
            renderMapEntityDetail(data);
        }

        window.closeEntityDetail = function() {
            detailOverlay.classList.remove('active');
        };

        detailOverlay.addEventListener('click', (e) => { if (e.target === detailOverlay) closeEntityDetail(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && detailOverlay.classList.contains('active')) closeEntityDetail(); });

        // Swipe-to-dismiss
        let detailTouchY = 0;
        detailPanel.addEventListener('touchstart', (e) => { if (detailPanel.scrollTop <= 0) detailTouchY = e.touches[0].clientY; }, { passive: true });
        detailPanel.addEventListener('touchmove', (e) => { if (detailPanel.scrollTop <= 0 && e.touches[0].clientY - detailTouchY > 80) closeEntityDetail(); }, { passive: true });

        // ── Schedule parser ────────────────────────────────
        function parseSchedule(scheduleData) {
            if (!scheduleData || typeof scheduleData !== 'object' || Array.isArray(scheduleData)) return {};
            const result = {};
            for (const [day, value] of Object.entries(scheduleData)) {
                if (Array.isArray(value)) {
                    const times = [];
                    for (const v of value) {
                        if (typeof v === 'string') times.push(v);
                        else if (typeof v === 'object' && v.time) {
                            let t = v.time;
                            if (v.language && v.language !== 'English') t += ` (${v.language})`;
                            times.push(t);
                        }
                    }
                    if (times.length > 0) result[day] = times;
                } else if (typeof value === 'string') {
                    result[day] = [value];
                }
            }
            return result;
        }

        function renderScheduleRows(schedule) {
            const dayOrder = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Monday-Friday'];
            let html = '';
            for (const day of dayOrder) {
                if (schedule[day] && schedule[day].length > 0) {
                    html += `<div class="entity-detail-schedule-row"><span class="day">${day}</span><span class="times">${schedule[day].map(t => escapeHTML(t)).join(', ')}</span></div>`;
                }
            }
            return html;
        }

        // ── Event parser ───────────────────────────────────
        function parseEvent(data) {
            const title = data.title || data.name || '';
            if (!title) return null;
            let eventDate = new Date();
            if (data.date && data.date.toDate) eventDate = data.date.toDate();
            else if (data.date && data.date.seconds) eventDate = new Date(data.date.seconds * 1000);
            else if (typeof data.date === 'string') eventDate = new Date(data.date);
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return { title, date: eventDate, time: data.time || null, location: data.location || null,
                month: months[eventDate.getMonth()] || '', dayNum: eventDate.getDate() || '' };
        }

        // ── Shared builders ────────────────────────────────
        function buildHeader(d, type) {
            const icon = getEntityIcon(type);
            const name = d.name || d.title || d.parishName || 'Unknown';
            const badge = d.diocese || d.category || d.type || d.schoolType || d.retreatType || d.organization || getTypeLabel(type);
            return `<div class="entity-detail-header"><div class="entity-detail-icon">${icon}</div><div class="entity-detail-header-info"><div class="entity-detail-name">${escapeHTML(name)}</div><span class="entity-detail-type-badge">${escapeHTML(badge)}</span></div><button class="entity-detail-close" onclick="closeEntityDetail()">&times;</button></div>`;
        }

        function buildLocation(d) {
            const parts = [];
            if (d.address) parts.push(d.address);
            if (d.city && d.state) parts.push(`${d.city}, ${d.state}`);
            else if (d.city) parts.push(d.city);
            else if (d.state) parts.push(d.state);
            else if (d.location && typeof d.location === 'string') parts.push(d.location);
            // Missionaries
            if (!parts.length && d.locationPrimary) {
                if (d.locationPrimary.city) parts.push(d.locationPrimary.city + (d.locationPrimary.state ? ', ' + d.locationPrimary.state : ''));
            }
            const loc = parts.join(' · ');
            if (!loc) return '';
            return `<div class="entity-detail-location"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg><span>${escapeHTML(loc)}</span></div>`;
        }

        function buildDescription(d) {
            const desc = d.description || d.bio || '';
            if (!desc) return '';
            const truncated = desc.length > 400 ? desc.substring(0, 397) + '...' : desc;
            return `<div class="entity-detail-description">${escapeHTML(truncated)}</div>`;
        }

        function buildMapsUrl(d) {
            if (d._coords) return `https://maps.google.com/maps?q=${d._coords.lat},${d._coords.lng}`;
            if (d.address && d.city) return `https://maps.google.com/maps?q=${encodeURIComponent(d.address + ', ' + d.city + ' ' + (d.state || ''))}`;
            return '';
        }

        function buildActions(d, type) {
            let html = '';
            const mapsUrl = buildMapsUrl(d);
            if (mapsUrl) html += `<a href="${mapsUrl}" target="_blank" rel="noopener" class="entity-detail-action-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>Maps</a>`;
            const website = d.website || d.websiteURL || d.link || d.contactInfo?.website || '';
            if (website) { const url = website.startsWith('http') ? website : 'https://' + website; html += `<a href="${url}" target="_blank" rel="noopener" class="entity-detail-action-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2z"/></svg>Website</a>`; }
            const phone = d.phone || d.phoneNumber || d.contactInfo?.phone || '';
            if (phone) html += `<a href="tel:${phone}" class="entity-detail-action-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>Call</a>`;
            // Type-specific actions
            if (type === 'missionary' && d.donationLink) { html += `<a href="${d.donationLink}" target="_blank" rel="noopener" class="entity-detail-action-btn primary-action">Donate</a>`; }
            if (type === 'missionary' && d.calendlyLink) { html += `<a href="${d.calendlyLink}" target="_blank" rel="noopener" class="entity-detail-action-btn primary-action">Schedule</a>`; }
            if (type === 'retreat') { const regUrl = d.registrationURL || ''; if (regUrl) html += `<a href="${regUrl}" target="_blank" rel="noopener" class="entity-detail-action-btn primary-action">Register</a>`; }
            if (type === 'vocation' && d.applicationLink) { html += `<a href="${d.applicationLink}" target="_blank" rel="noopener" class="entity-detail-action-btn primary-action">Apply</a>`; }
            if (type === 'school') { const enrollUrl = d.enrollmentURL || ''; if (enrollUrl) html += `<a href="${enrollUrl}" target="_blank" rel="noopener" class="entity-detail-action-btn primary-action">Enroll</a>`; }
            return html ? `<div class="entity-detail-actions">${html}</div>` : '';
        }

        function buildContact(d) {
            const phone = d.phone || d.phoneNumber || d.contactInfo?.phone || '';
            const email = d.email || d.contactInfo?.email || '';
            const website = d.website || d.websiteURL || d.link || d.contactInfo?.website || '';
            if (!phone && !email && !website) return '';
            let html = '<div class="entity-detail-contact">';
            if (phone) html += `<div class="entity-detail-contact-row"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg><a href="tel:${phone}">${escapeHTML(phone)}</a></div>`;
            if (email) html += `<div class="entity-detail-contact-row"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg><a href="mailto:${email}">${escapeHTML(email)}</a></div>`;
            if (website) { const url = website.startsWith('http') ? website : 'https://' + website; const display = website.replace(/^https?:\/\/(www\.)?/, '').replace(/\/$/, ''); html += `<div class="entity-detail-contact-row"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2z"/></svg><a href="${url}" target="_blank" rel="noopener">${escapeHTML(display)}</a></div>`; }
            html += '</div>';
            return html;
        }

        function buildFooter(d) {
            let html = '<div class="entity-detail-footer">';
            const mapsUrl = buildMapsUrl(d);
            if (mapsUrl) html += `<a href="${mapsUrl}" target="_blank" rel="noopener" class="entity-detail-footer-btn primary" style="text-decoration:none;"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>Open in Maps</a>`;
            html += `<button class="entity-detail-footer-btn secondary" onclick="closeEntityDetail()">Close</button>`;
            html += '</div>';
            return html;
        }

        function buildInfoItem(label, value) {
            if (!value) return '';
            return `<div class="entity-detail-info-item"><div class="entity-detail-info-label">${escapeHTML(label)}</div><div class="entity-detail-info-value">${escapeHTML(String(value))}</div></div>`;
        }

        function buildInfoFull(title, text) {
            if (!text) return '';
            return `<div class="entity-detail-info-full"><div class="info-title">${escapeHTML(title)}</div><div class="info-text">${escapeHTML(String(text))}</div></div>`;
        }

        // ══════════════════════════════════════════════════════
        // MASTER RENDER FUNCTION
        // ══════════════════════════════════════════════════════

        function renderMapEntityDetail(d) {
            const type = d._type;
            let html = buildHeader(d, type);

            // Main card
            const isChurch = type === 'church';
            const cardClass = isChurch && d.isUnlocked ? 'entity-detail-card rainbow' : 'entity-detail-card';
            let cardHTML = buildLocation(d) + buildDescription(d);

            // Founding year / rating / subtitle
            if (d.foundingYear) cardHTML += `<div style="font-size:0.82rem;color:#999;margin-bottom:8px;">Since ${escapeHTML(String(d.foundingYear))}</div>`;
            if (d.rating) cardHTML += `<div style="font-size:0.82rem;color:#d4af37;margin-bottom:8px;">★ ${d.rating}${d.reviewCount ? ` (${d.reviewCount} reviews)` : ''}</div>`;

            cardHTML += buildActions(d, type);
            if (cardHTML) html += `<div class="${cardClass}">${cardHTML}</div>`;

            // ── Type-specific sections ──
            switch (type) {
                case 'church': html += renderChurch(d); break;
                case 'business': html += renderBusiness(d); break;
                case 'school': html += renderSchool(d); break;
                case 'missionary': html += renderMissionary(d); break;
                case 'retreat': html += renderRetreat(d); break;
                case 'pilgrimage': html += renderPilgrimage(d); break;
                case 'vocation': html += renderVocation(d); break;
                case 'campus': html += renderCampus(d); break;
            }

            // Contact + footer
            html += `<div class="entity-detail-section-title">Contact</div>`;
            html += buildContact(d);
            html += buildFooter(d);

            detailContent.innerHTML = html;
        }

        // ══════════════════════════════════════════════════════
        // CHURCH — PrimeParishDetailView
        // ══════════════════════════════════════════════════════

        function renderChurch(d) {
            let html = '';

            // Mass schedule
            if (d.massSchedule && typeof d.massSchedule === 'object') {
                const schedule = parseSchedule(d.massSchedule);
                if (Object.keys(schedule).length) {
                    html += `<div class="entity-detail-section-title">Mass Schedule</div>`;
                    html += `<div class="entity-detail-schedule">${renderScheduleRows(schedule)}</div>`;
                }
            }

            // Confession
            if (d.confessionSchedule && typeof d.confessionSchedule === 'object') {
                const schedule = parseSchedule(d.confessionSchedule);
                if (Object.keys(schedule).length) {
                    html += `<div class="entity-detail-section-title">Confession</div>`;
                    html += `<div class="entity-detail-schedule">${renderScheduleRows(schedule)}</div>`;
                }
            }

            // Adoration
            if (d.adorationSchedule && typeof d.adorationSchedule === 'object') {
                const schedule = parseSchedule(d.adorationSchedule);
                if (Object.keys(schedule).length) {
                    html += `<div class="entity-detail-section-title">Adoration</div>`;
                    html += `<div class="entity-detail-schedule">${renderScheduleRows(schedule)}</div>`;
                }
            }

            // Events
            if (Array.isArray(d.events) && d.events.length > 0) {
                const now = new Date();
                const upcoming = d.events.map(e => parseEvent(e)).filter(e => e && e.date >= now).sort((a, b) => a.date - b.date).slice(0, 5);
                if (upcoming.length) {
                    html += `<div class="entity-detail-section-title">Upcoming Events</div><div class="entity-detail-events">`;
                    for (const evt of upcoming) {
                        html += `<div class="entity-detail-event-item"><div class="entity-detail-event-date"><div class="month">${evt.month}</div><div class="day-num">${evt.dayNum}</div></div><div class="entity-detail-event-info"><div class="entity-detail-event-title">${escapeHTML(evt.title)}</div>${evt.time ? `<div class="entity-detail-event-time">${escapeHTML(evt.time)}${evt.location ? ' · ' + escapeHTML(evt.location) : ''}</div>` : ''}</div></div>`;
                    }
                    html += '</div>';
                }
            }

            // Programs & Sacraments
            const programs = [];
            if (d.hasOCIA === true || d.prepClassSignupURL) programs.push('OCIA');
            if (d.hasConfirmation !== false && d.hasConfirmation !== undefined) programs.push('Confirmation');
            if (d.hasFirstEucharist !== false && d.hasFirstEucharist !== undefined) programs.push('First Eucharist');
            if (d.hasMarriagePrep !== false && d.hasMarriagePrep !== undefined) programs.push('Marriage Prep');
            if (programs.length > 0) {
                html += `<div class="entity-detail-section-title">Programs & Sacraments</div><div class="entity-detail-programs">`;
                programs.forEach(p => { html += `<div class="entity-detail-program-pill">${escapeHTML(p)}</div>`; });
                html += '</div>';
            }

            return html;
        }

        // ══════════════════════════════════════════════════════
        // BUSINESS — BusinessDetailViewPrime
        // ══════════════════════════════════════════════════════

        function renderBusiness(d) {
            let html = '';

            // Features
            if (Array.isArray(d.features) && d.features.length > 0) {
                html += `<div class="entity-detail-section-title">Highlights</div><div class="entity-detail-programs">`;
                d.features.slice(0, 5).forEach(f => { html += `<div class="entity-detail-program-pill">${escapeHTML(f)}</div>`; });
                html += '</div>';
            }

            // Hours
            if (Array.isArray(d.hours) && d.hours.length > 0) {
                html += `<div class="entity-detail-section-title">Hours</div><div class="entity-detail-hours">`;
                d.hours.forEach(h => {
                    const day = h.day || h.dayOfWeek || '';
                    const time = h.hours || h.time || h.open || '';
                    if (day && time) html += `<div class="entity-detail-hours-row"><span class="day">${escapeHTML(day)}</span><span class="time">${escapeHTML(time)}</span></div>`;
                });
                html += '</div>';
            } else if (typeof d.hours === 'object' && d.hours && !Array.isArray(d.hours)) {
                html += `<div class="entity-detail-section-title">Hours</div><div class="entity-detail-hours">`;
                for (const [day, time] of Object.entries(d.hours)) {
                    html += `<div class="entity-detail-hours-row"><span class="day">${escapeHTML(day)}</span><span class="time">${escapeHTML(String(time))}</span></div>`;
                }
                html += '</div>';
            }

            // Philanthropy
            const hasPhilanthropy = d.communityPartnerships || d.communityInvolvement || d.additionalEventsSummary;
            if (hasPhilanthropy) {
                html += `<div class="entity-detail-section-title">Community & Philanthropy</div>`;
                html += buildInfoFull('Parish Support', d.communityPartnerships);
                html += buildInfoFull('Nonprofit Partnerships', d.communityInvolvement);
                html += buildInfoFull('Event Sponsorships', d.additionalEventsSummary);
            }

            // Events
            if (d.eventTitle) {
                html += `<div class="entity-detail-section-title">Events</div>`;
                html += `<div class="entity-detail-info-full"><div class="info-title">${escapeHTML(d.eventTitle)}${d.eventSubtitle ? ' — ' + escapeHTML(d.eventSubtitle) : ''}</div><div class="info-text">${d.eventDate ? escapeHTML(d.eventDate) : ''}${d.eventTime ? ' at ' + escapeHTML(d.eventTime) : ''}</div></div>`;
            }

            // Awards & Reviews
            if (d.awardsRecognition) html += buildInfoFull('Awards & Recognition', d.awardsRecognition);
            if (d.customerReviewsSummary) html += buildInfoFull('Customer Reviews', d.customerReviewsSummary);

            // Newsletter
            if (d.marketingNewsletter) html += buildInfoFull('Newsletter', d.marketingNewsletter);

            // Social Media
            const social = d.socialMedia || d.contactInfo?.socialMedia;
            if (social && typeof social === 'object') {
                html += `<div class="entity-detail-section-title">Social Media</div><div class="entity-detail-social">`;
                for (const [platform, url] of Object.entries(social)) {
                    if (url) { const link = String(url).startsWith('http') ? url : 'https://' + url; html += `<a href="${link}" target="_blank" rel="noopener">${escapeHTML(platform)}</a>`; }
                }
                html += '</div>';
            }

            return html;
        }

        // ══════════════════════════════════════════════════════
        // SCHOOL — SchoolDetailViewPrime
        // ══════════════════════════════════════════════════════

        function renderSchool(d) {
            let html = '';

            // Academics grid
            const academicFields = [
                ['Grade Levels', d.gradeLevels], ['Enrollment', d.enrollment],
                ['Class Size', d.classSize], ['Tuition', d.tuition],
                ['Financial Aid', d.financialAid], ['Admissions', d.admissionsProcess]
            ].filter(([, v]) => v);

            if (academicFields.length) {
                html += `<div class="entity-detail-section-title">Academics</div><div class="entity-detail-info-grid">`;
                academicFields.forEach(([label, value]) => { html += buildInfoItem(label, value); });
                html += '</div>';
                if (d.parentInvolvement) html += buildInfoFull('Parent Involvement', d.parentInvolvement);
                if (d.enrollmentURL) html += `<div style="margin:0 16px 12px;"><a href="${d.enrollmentURL}" target="_blank" rel="noopener" class="entity-detail-action-btn primary-action" style="display:inline-flex;">Apply / Enroll</a></div>`;
            }

            // Classical Education
            const classicalFields = [
                ['Trivium & Quadrivium', d.triviumQuadrivium], ['Latin & Greek', d.latinGreekStudies],
                ['Great Books', d.greatBooks], ['Socratic Method', d.socraticMethod]
            ].filter(([, v]) => v);

            if (classicalFields.length) {
                html += `<div class="entity-detail-section-title">Classical Education</div>`;
                classicalFields.forEach(([label, value]) => { html += buildInfoFull(label, value); });
            }

            // Catholic Formation
            const formationFields = [
                ['Religious Education', d.religiousEducation], ['Sacramental Preparation', d.sacramentalPreparation],
                ['Daily Mass', d.dailyMass], ['Confession', d.confessionSchedule],
                ['Adoration', d.adoration], ['Virtue Formation', d.virtueFormation]
            ].filter(([, v]) => v);

            if (formationFields.length) {
                html += `<div class="entity-detail-section-title">Catholic Formation</div>`;
                formationFields.forEach(([label, value]) => {
                    if (typeof value === 'object') html += buildInfoFull(label, JSON.stringify(value));
                    else html += buildInfoFull(label, value);
                });
            }

            return html;
        }

        // ══════════════════════════════════════════════════════
        // MISSIONARY — MissionaryDetailViewPrime
        // ══════════════════════════════════════════════════════

        function renderMissionary(d) {
            let html = '';

            // Organization & Campus
            if (d.organization) html += buildInfoFull('Organization', d.organization);
            if (d.campus) html += buildInfoFull('Campus', d.campus);

            // Impact Stats
            const stats = d.impactStats;
            if (stats && (stats.studentsReached || stats.campusesCovered || stats.yearsOfService)) {
                html += `<div class="entity-detail-section-title">Impact</div><div class="entity-detail-stats">`;
                if (stats.studentsReached) html += `<div class="entity-detail-stat"><div class="stat-value">${escapeHTML(String(stats.studentsReached))}</div><div class="stat-label">Students Reached</div></div>`;
                if (stats.campusesCovered) html += `<div class="entity-detail-stat"><div class="stat-value">${escapeHTML(String(stats.campusesCovered))}</div><div class="stat-label">Campuses</div></div>`;
                if (stats.yearsOfService) html += `<div class="entity-detail-stat"><div class="stat-value">${escapeHTML(String(stats.yearsOfService))}</div><div class="stat-label">Years</div></div>`;
                html += '</div>';
            }

            // FOCUS Bible Studies
            if (Array.isArray(d.bibleStudies) && d.bibleStudies.length > 0) {
                html += `<div class="entity-detail-section-title">Bible Studies</div><div class="entity-detail-schedule">`;
                d.bibleStudies.forEach(bs => {
                    const day = bs.dayOfWeek || '';
                    const time = bs.time || '';
                    const participants = bs.currentParticipants && bs.maxParticipants ? `${bs.currentParticipants}/${bs.maxParticipants}` : '';
                    html += `<div class="entity-detail-schedule-row"><span class="day">${escapeHTML(day)} ${escapeHTML(time)}</span><span class="times">${participants ? escapeHTML(participants) + ' spots' : ''}</span></div>`;
                });
                html += '</div>';
            }

            return html;
        }

        // ══════════════════════════════════════════════════════
        // RETREAT — RetreatDetailViewPrime
        // ══════════════════════════════════════════════════════

        function renderRetreat(d) {
            let html = '';

            // Dates & Pricing
            const dateFields = [
                ['Date', d.date ? (typeof d.date === 'string' ? d.date : '') : ''],
                ['Duration', d.duration], ['Price', d.price], ['Capacity', d.capacity]
            ].filter(([, v]) => v);
            if (dateFields.length) {
                html += `<div class="entity-detail-section-title">Details</div><div class="entity-detail-info-grid">`;
                dateFields.forEach(([label, value]) => { html += buildInfoItem(label, value); });
                html += '</div>';
            }

            // Organization
            if (d.organizationName) {
                html += `<div class="entity-detail-section-title">Organization</div>`;
                html += buildInfoFull(d.organizationName, d.organizationDescription);
                if (d.organizationWebsite) {
                    const url = d.organizationWebsite.startsWith('http') ? d.organizationWebsite : 'https://' + d.organizationWebsite;
                    html += `<div style="margin:0 16px 12px;"><a href="${url}" target="_blank" rel="noopener" class="entity-detail-action-btn">Organization Website</a></div>`;
                }
            }

            // Program
            const programFields = [
                ['Topics & Themes', d.retreatTopics], ['Speaker Info', d.speakerInfo],
                ['Schedule & Structure', d.scheduleStructure], ['Pricing Details', d.pricing]
            ].filter(([, v]) => v);
            if (programFields.length) {
                html += `<div class="entity-detail-section-title">Program</div>`;
                programFields.forEach(([label, value]) => { html += buildInfoFull(label, value); });
            }

            // Spiritual Life
            const spirFields = [
                ['Mass Schedule', d.massSchedule], ['Confession', d.confessionAvailability],
                ['Adoration', d.adorationOpportunities], ['Spiritual Direction', d.spiritualDirection],
                ['Prayer Formats', d.prayerFormats]
            ].filter(([, v]) => v);
            if (spirFields.length) {
                html += `<div class="entity-detail-section-title">Spiritual Life</div>`;
                spirFields.forEach(([label, value]) => {
                    if (typeof value === 'object' && !Array.isArray(value)) {
                        const schedule = parseSchedule(value);
                        if (Object.keys(schedule).length) html += `<div class="entity-detail-schedule">${renderScheduleRows(schedule)}</div>`;
                        else html += buildInfoFull(label, JSON.stringify(value));
                    } else {
                        html += buildInfoFull(label, value);
                    }
                });
            }

            // Logistics
            const logFields = [
                ['Director', d.directorName], ['Accommodation', d.accommodationInfo],
                ['Frequency', d.retreatFrequency]
            ].filter(([, v]) => v);
            if (logFields.length) {
                html += `<div class="entity-detail-section-title">Logistics</div>`;
                logFields.forEach(([label, value]) => { html += buildInfoFull(label, value); });
            }

            // Address
            const addr = [d.address, d.city, d.state, d.zipCode].filter(Boolean).join(', ');
            if (addr && !d.address) html += buildInfoFull('Address', addr);

            // Testimonials
            if (d.testimonials) html += buildInfoFull('Testimonials', d.testimonials);

            // Social
            if (d.socialMedia && typeof d.socialMedia === 'object') {
                html += `<div class="entity-detail-section-title">Social Media</div><div class="entity-detail-social">`;
                for (const [platform, url] of Object.entries(d.socialMedia)) {
                    if (url) { const link = String(url).startsWith('http') ? url : 'https://' + url; html += `<a href="${link}" target="_blank" rel="noopener">${escapeHTML(platform)}</a>`; }
                }
                html += '</div>';
            }

            return html;
        }

        // ══════════════════════════════════════════════════════
        // PILGRIMAGE — PilgrimageDetailViewPrime
        // ══════════════════════════════════════════════════════

        function renderPilgrimage(d) {
            let html = '';

            // Site info
            if (d.siteName || d.siteDescription) {
                html += `<div class="entity-detail-section-title">Site Information</div>`;
                if (d.siteName) html += buildInfoFull(d.siteName, d.siteDescription);
                if (d.siteHistoricalSignificance) html += buildInfoFull('Historical Significance', d.siteHistoricalSignificance);
                if (d.siteVisitingHours) html += buildInfoFull('Visiting Hours', d.siteVisitingHours);
                if (d.siteAdmissionInfo) html += buildInfoFull('Admission', d.siteAdmissionInfo);
            }

            // Travel facilitations (trips)
            if (Array.isArray(d.travelFacilitations) && d.travelFacilitations.length > 0) {
                html += `<div class="entity-detail-section-title">Upcoming Trips</div><div class="entity-detail-events">`;
                d.travelFacilitations.forEach(trip => {
                    const date = trip.date || '';
                    const price = trip.price || '';
                    const spots = trip.spots || '';
                    html += `<div class="entity-detail-event-item"><div class="entity-detail-event-date"><div class="month">${price ? '$' : ''}</div><div class="day-num">${escapeHTML(String(price || ''))}</div></div><div class="entity-detail-event-info"><div class="entity-detail-event-title">${escapeHTML(String(date))}${trip.endDate ? ' — ' + escapeHTML(String(trip.endDate)) : ''}</div>${spots ? `<div class="entity-detail-event-time">${escapeHTML(String(spots))} spots available</div>` : ''}</div></div>`;
                });
                html += '</div>';
            }

            // Pilgrimage type
            if (d.type && d.type !== d._type) html += buildInfoFull('Pilgrimage Type', d.type);

            return html;
        }

        // ══════════════════════════════════════════════════════
        // VOCATION — VocationDetailViewPrime
        // ══════════════════════════════════════════════════════

        function renderVocation(d) {
            let html = '';

            // Director & Community
            const infoFields = [
                ['Vocation Director', d.directorName], ['Community', d.communityName],
                ['Vocation Type', d.type && d.type !== d._type ? d.type : '']
            ].filter(([, v]) => v);
            if (infoFields.length) {
                html += `<div class="entity-detail-section-title">Overview</div><div class="entity-detail-info-grid">`;
                infoFields.forEach(([label, value]) => { html += buildInfoItem(label, value); });
                html += '</div>';
            }

            // Formation
            const formFields = [
                ['Formation Process', d.formationProcess],
                ['Requirements', d.requirements],
                ['Discernment Opportunities', d.discernmentOpportunities]
            ].filter(([, v]) => v);
            if (formFields.length) {
                html += `<div class="entity-detail-section-title">Formation & Discernment</div>`;
                formFields.forEach(([label, value]) => { html += buildInfoFull(label, value); });
            }

            // Location details
            const addr = [d.address, d.city, d.state, d.zipCode].filter(Boolean).join(', ');
            if (addr) html += buildInfoFull('Location', addr);

            return html;
        }

        // ══════════════════════════════════════════════════════
        // CAMPUS — follows Missionary pattern
        // ══════════════════════════════════════════════════════

        function renderCampus(d) {
            let html = '';
            if (d.university) html += buildInfoFull('University', d.university);
            if (d.organization) html += buildInfoFull('Organization', d.organization);
            if (d.type) html += buildInfoFull('Type', d.type);
            return html;
        }

        // ══════════════════════════════════════════════════════
        // SEARCH BAR — iOS CatholicSearchOverlay parity
        // ══════════════════════════════════════════════════════

        const searchOverlay = document.getElementById('map-search-overlay');
        const searchInput = document.getElementById('map-search-input');
        const searchResults = document.getElementById('map-search-results');
        const searchClearBtn = document.getElementById('map-search-clear');
        const searchEmptyEl = document.getElementById('map-search-empty');
        let searchDebounceTimer = null;

        // ── Animated placeholder (matches iOS ScrollingSearchTextController) ──
        (function() {
            const words = document.querySelectorAll('.map-search-placeholder-word');
            let currentIdx = 0;
            const total = words.length;

            setInterval(() => {
                words[currentIdx].classList.remove('active');
                currentIdx = (currentIdx + 1) % total;
                words[currentIdx].classList.add('active');
            }, 1800);
        })();

        // ── Open / close search overlay ──
        window.openMapSearch = function() {
            searchOverlay.classList.add('active');
            searchInput.focus();
        };

        window.closeMapSearch = function() {
            searchOverlay.classList.remove('active');
            searchInput.blur();
        };

        window.clearMapSearch = function() {
            searchInput.value = '';
            searchClearBtn.classList.remove('visible');
            searchResults.innerHTML = '';
            searchResults.appendChild(searchEmptyEl);
            searchEmptyEl.style.display = '';
            searchInput.focus();
        };

        // Close on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && searchOverlay.classList.contains('active')) closeMapSearch();
        });

        // ── Normalize for search (diacritics, lowercase, collapse spaces) ──
        function normalizeForSearch(text) {
            if (!text) return '';
            return String(text).normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .toLowerCase().replace(/\s+/g, ' ').trim();
        }

        // ── Search fields per type ──
        function getSearchableText(data, type) {
            const parts = [];
            const n = data.name || data.title || data.parishName || '';
            if (n) parts.push(n);

            switch (type) {
                case 'church':
                    if (data.address) parts.push(data.address);
                    if (data.city) parts.push(data.city);
                    if (data.diocese) parts.push(data.diocese);
                    break;
                case 'missionary':
                    if (data.locationPrimary?.city) parts.push(data.locationPrimary.city);
                    if (data.organization) parts.push(data.organization);
                    break;
                case 'vocation':
                    if (data.location) parts.push(data.location);
                    if (data.communityName) parts.push(data.communityName);
                    break;
                case 'retreat':
                    if (data.location) parts.push(data.location);
                    if (data.city) parts.push(data.city);
                    if (data.organizationName) parts.push(data.organizationName);
                    break;
                case 'pilgrimage':
                    if (data.location) parts.push(data.location);
                    if (data.city) parts.push(data.city);
                    if (data.siteName) parts.push(data.siteName);
                    break;
                case 'school':
                    if (data.location?.city) parts.push(data.location.city);
                    else if (data.city) parts.push(data.city);
                    break;
                case 'campus':
                    if (data.location) parts.push(data.location);
                    if (data.university) parts.push(data.university);
                    if (data.type) parts.push(data.type);
                    break;
                case 'business':
                    if (data.city) parts.push(data.city);
                    if (data.subcategory) parts.push(data.subcategory);
                    if (data.category) parts.push(data.category);
                    break;
            }
            return normalizeForSearch(parts.join(' '));
        }

        // ── Section config (order + limits matching iOS) ──
        const SEARCH_SECTIONS = [
            { type: 'church', title: 'Churches', limit: 5 },
            { type: 'missionary', title: 'Missionaries', limit: 5 },
            { type: 'vocation', title: 'Vocations', limit: 2 },
            { type: 'retreat', title: 'Retreats', limit: 2 },
            { type: 'pilgrimage', title: 'Pilgrimage', limit: 3 },
            { type: 'school', title: 'Education', limit: 2 },
            { type: 'campus', title: 'Campus Ministries', limit: 2 },
            { type: 'business', title: 'Businesses', limit: 5 }
        ];

        const TYPE_ICONS = {
            church: '⛪', missionary: '✝️', pilgrimage: '🗺️', retreat: '🙏',
            school: '🎓', vocation: '📿', business: '🏪', campus: '🎒'
        };

        const TYPE_LABELS = {
            church: 'Church', missionary: 'Missionary', pilgrimage: 'Pilgrimage',
            retreat: 'Retreat', school: 'School', vocation: 'Vocation',
            business: 'Business', campus: 'Campus'
        };

        // ── Perform search across entityDataMap ──
        function performMapSearch(query) {
            const q = normalizeForSearch(query);
            if (q.length < 2) {
                searchResults.innerHTML = '';
                searchResults.appendChild(searchEmptyEl);
                searchEmptyEl.style.display = '';
                return;
            }

            const tokens = q.split(' ').filter(t => t.length > 0);
            const sections = [];

            for (const sec of SEARCH_SECTIONS) {
                const matches = [];
                entityDataMap.forEach((data, docId) => {
                    if (data._type !== sec.type) return;
                    const haystack = getSearchableText(data, sec.type);
                    const allMatch = tokens.every(tok => haystack.includes(tok));
                    if (allMatch) matches.push({ docId, data });
                });
                if (matches.length > 0) {
                    sections.push({ ...sec, results: matches.slice(0, sec.limit) });
                }
            }

            renderSearchResults(sections, q);
        }

        // ── Get subtitle for result row ──
        function getResultSubtitle(data, type) {
            switch (type) {
                case 'church': return data.address || data.city || data.diocese || '';
                case 'missionary': return data.organization || (data.locationPrimary?.city ? data.locationPrimary.city + (data.locationPrimary.state ? ', ' + data.locationPrimary.state : '') : '') || '';
                case 'vocation': return data.location || data.communityName || '';
                case 'retreat': return data.location || data.organizationName || data.city || '';
                case 'pilgrimage': return data.location || data.city || '';
                case 'school': return data.location?.city || data.city || '';
                case 'campus': return data.university || data.location || '';
                case 'business': return [data.subcategory, data.city].filter(Boolean).join(' · ') || '';
                default: return '';
            }
        }

        // ── Render search results ──
        function renderSearchResults(sections, query) {
            if (sections.length === 0) {
                searchResults.innerHTML = `<div class="map-search-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><div class="map-search-empty-text">No results for "${escapeHTML(query)}"</div></div>`;
                return;
            }

            let html = '';
            for (const sec of sections) {
                html += `<div class="map-search-section-title">${sec.title}</div>`;
                sec.results.forEach((r, i) => {
                    const name = r.data.name || r.data.title || r.data.parishName || 'Unknown';
                    const subtitle = getResultSubtitle(r.data, sec.type);
                    const color = PIN_COLORS[sec.type];
                    const icon = TYPE_ICONS[sec.type] || '📍';
                    const badge = TYPE_LABELS[sec.type] || sec.type;
                    html += `<div class="map-search-row" onclick="selectSearchResult('${r.docId}')"><div class="map-search-row-icon" style="background:${color}22;"><span>${icon}</span></div><div class="map-search-row-info"><div class="map-search-row-title">${escapeHTML(name)}</div>${subtitle ? `<div class="map-search-row-subtitle">${escapeHTML(subtitle)}</div>` : ''}</div><span class="map-search-row-badge">${badge}</span></div>`;
                    if (i < sec.results.length - 1) html += `<div class="map-search-divider"></div>`;
                });
            }
            searchResults.innerHTML = html;
        }

        // ── Select search result: close overlay, fly to, open detail ──
        window.selectSearchResult = function(docId) {
            const data = entityDataMap.get(docId);
            if (!data) return;
            closeMapSearch();
            if (data._coords) {
                map.flyTo([data._coords.lat, data._coords.lng], 14, { duration: 0.8 });
            }
            setTimeout(() => openMapEntityDetail(docId), 400);
        };

        // ── Debounced search on input ──
        searchInput.addEventListener('input', () => {
            const val = searchInput.value.trim();
            searchClearBtn.classList.toggle('visible', val.length > 0);
            if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => performMapSearch(val), 300);
        });

        // Enter key submits search
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
                performMapSearch(searchInput.value.trim());
            }
        });

        // Start loading
        loadData();

        // ── Waitlist popup after 30s ──────────────────────────
        (function() {
            if (sessionStorage.getItem('nave_map_waitlist_shown')) return;
            setTimeout(() => {
                if (sessionStorage.getItem('nave_map_waitlist_shown')) return;
                document.getElementById('map-waitlist-overlay').classList.remove('hidden');
                sessionStorage.setItem('nave_map_waitlist_shown', '1');
            }, 30000);
        })();

        function closeMapWaitlist() {
            document.getElementById('map-waitlist-overlay').classList.add('hidden');
        }

        document.getElementById('map-waitlist-overlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'map-waitlist-overlay') closeMapWaitlist();
        });

        document.getElementById('map-waitlist-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('map-waitlist-email').value.trim();
            if (!email) return;
            const btn = e.target.querySelector('.map-waitlist-btn');
            btn.disabled = true;
            btn.textContent = 'Submitting...';
            try {
                const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const { db } = await import('./firebase-config.js');
                await addDoc(collection(db, 'waitlist'), {
                    email: email,
                    createdAt: serverTimestamp(),
                    source: 'map_30s'
                });
                document.getElementById('map-waitlist-form').classList.add('hidden');
                document.getElementById('map-waitlist-success').classList.remove('hidden');
                setTimeout(() => closeMapWaitlist(), 2000);
            } catch (err) {
                console.error('Waitlist error:', err);
                btn.textContent = 'Error - Try Again';
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
