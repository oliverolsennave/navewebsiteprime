<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Map — Nave</title>
    <meta name="description" content="Explore the Catholic culture heat map. Discover churches, missionaries, pilgrimages, schools, retreats, and Catholic businesses near you.">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Favicon (red Nave logo, cache-busted) -->
    <link rel="icon" href="/favicon.ico?v=20260209-red" sizes="48x48">
    <link rel="icon" href="assets/favicon-32.png?v=20260209-red" sizes="32x32" type="image/png">
    <link rel="icon" href="assets/favicon-16.png?v=20260209-red" sizes="16x16" type="image/png">
    <link rel="icon" href="assets/favicon-adaptive.svg?v=20260209-red" type="image/svg+xml" sizes="any">
    <link rel="apple-touch-icon" href="assets/apple-touch-icon.png?v=20260209-red" sizes="180x180">
    <link rel="mask-icon" href="assets/favicon-adaptive.svg?v=20260209-red" color="#CC3333">
    <link rel="shortcut icon" href="/favicon.ico?v=20260209-red">
    <link rel="manifest" href="site.webmanifest">
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="theme-color" content="#0D0D10">
    
    <style>
        /* Map Page Specific Styles */
        .map-page {
            height: 100vh;
            height: 100dvh; /* dynamic viewport height — respects mobile URL bar */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .map-wrapper {
            flex: 1;
            position: relative;
            margin-top: 57px; /* nav height */
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: #0a0a0a;
        }
        
        /* Override Leaflet dark theme */
        .leaflet-container {
            background: #0a0a0a;
            font-family: 'Instrument Sans', -apple-system, sans-serif;
        }
        
        .leaflet-control-zoom a {
            background: #1a1a1a !important;
            color: #f5f5f5 !important;
            border-color: #2a2a2a !important;
        }
        
        .leaflet-control-zoom a:hover {
            background: #2a2a2a !important;
        }
        
        .leaflet-control-attribution {
            background: rgba(10, 10, 10, 0.8) !important;
            color: #707070 !important;
            font-size: 10px !important;
        }
        
        .leaflet-control-attribution a {
            color: #a0a0a0 !important;
        }
        
        /* Map Legend / Filter Panel */
        .map-legend {
            position: absolute;
            bottom: 16px;
            left: 16px;
            z-index: 1000;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            min-width: 200px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .map-legend.collapsed {
            transform: translateX(-calc(100% + 16px));
            opacity: 0;
            pointer-events: none;
        }
        
        .legend-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .legend-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #f5f5f5;
            margin: 0;
        }
        
        .legend-close {
            background: none;
            border: none;
            color: #707070;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }
        
        .legend-close:hover {
            color: #f5f5f5;
        }
        
        .legend-filters {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .legend-filter {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
        }
        
        .legend-filter input[type="checkbox"] {
            display: none;
        }
        
        .filter-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            flex-shrink: 0;
            transition: opacity 0.2s;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .legend-filter input:not(:checked) ~ .filter-dot {
            opacity: 0.25;
        }
        
        .filter-label {
            font-size: 0.95rem;
            color: #f5f5f5;
            font-weight: 400;
        }
        
        .legend-filter input:not(:checked) ~ .filter-label {
            color: #707070;
        }
        
        .filter-count {
            margin-left: auto;
            font-size: 0.75rem;
            color: #707070;
            font-weight: 500;
        }
        
        /* Toggle Legend Button — positioned right of zoom controls */
        .legend-toggle {
            position: absolute;
            bottom: 16px;
            left: 56px;
            z-index: 999;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            padding: 10px 14px;
            color: #f5f5f5;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }
        
        .legend-toggle.visible {
            display: flex;
        }
        
        /* Stats bar */
        .map-stats {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 0.85rem;
            color: #a0a0a0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }
        
        .map-stats .stat-highlight {
            color: #d4af37;
            font-weight: 700;
        }
        
        /* Loading overlay */
        .map-loading {
            position: absolute;
            inset: 0;
            z-index: 1001;
            background: rgba(10, 10, 10, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            transition: opacity 0.5s ease;
        }
        
        .map-loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .map-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #2a2a2a;
            border-top-color: #d4af37;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .map-loading-text {
            color: #a0a0a0;
            font-size: 0.95rem;
        }
        
        /* Location popup */
        .leaflet-popup-content-wrapper {
            background: #1a1a1a !important;
            border: 1px solid #2a2a2a !important;
            border-radius: 10px !important;
            color: #f5f5f5 !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4) !important;
        }
        
        .leaflet-popup-tip {
            background: #1a1a1a !important;
            border: 1px solid #2a2a2a !important;
        }
        
        .leaflet-popup-close-button {
            color: #707070 !important;
        }
        
        .leaflet-popup-close-button:hover {
            color: #f5f5f5 !important;
        }
        
        .popup-content {
            padding: 4px 0;
        }
        
        .popup-type {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 2px 8px;
            border-radius: 4px;
            margin-bottom: 6px;
        }
        
        .popup-name {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .popup-detail {
            font-size: 0.85rem;
            color: #a0a0a0;
        }
        
        /* Add To Map — rainbow wrapper + white inner button */
        .add-to-map-wrap {
            position: absolute;
            bottom: 80px;
            right: 76px;
            z-index: 1000;
            padding: 2px;
            border-radius: 12px;
            background: linear-gradient(135deg, #e06060, #e0b040, #50c050, #4090e0, #9050d0);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .add-to-map-wrap:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .add-to-map-btn {
            display: block;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 700;
            font-family: 'Instrument Sans', -apple-system, sans-serif;
            color: #111;
            background: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
        }

        /* Locate me button */
        .locate-btn {
            position: absolute;
            bottom: 80px;
            right: 16px;
            z-index: 1000;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            padding: 12px;
            color: #f5f5f5;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            transition: background 0.2s;
        }
        
        .locate-btn:hover {
            background: rgba(40, 40, 40, 0.95);
        }
        
        .locate-btn svg {
            display: block;
            width: 20px;
            height: 20px;
        }

        /* ── iOS-style pulsing current location marker ─── */
        .user-location-marker {
            position: relative;
            width: 21px;
            height: 21px;
        }

        /* Green pulse waves — 2 gentle staggered rings */
        .user-location-pulse,
        .user-location-pulse2 {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 17px;
            height: 17px;
            border-radius: 50%;
            background: rgba(0, 220, 80, 0.35);
            transform: translate(-50%, -50%) scale(1);
            will-change: transform, opacity;
        }
        /* Hidden on mobile — only show on desktop */
        .user-location-pulse3,
        .user-location-pulse4 { display: none; }
        .user-location-pulse  { animation: locationPulse 4s ease-out infinite 0s; }
        .user-location-pulse2 { animation: locationPulse 4s ease-out infinite 2s; }

        /* The dot itself — black fill, white outline */
        .user-location-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #0a0a0a;
            border: 2.5px solid #ffffff;
            box-shadow: 0 0 8px rgba(0, 220, 80, 0.5);
            z-index: 2;
        }

        @keyframes locationPulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.7;
            }
            100% {
                transform: translate(-50%, -50%) scale(4.5);
                opacity: 0;
            }
        }

        /* ── Location Prompt Modal ─────────────────────── */
        .location-prompt-overlay {
            position: absolute;
            inset: 0;
            z-index: 1002;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.4s ease;
        }

        .location-prompt-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .location-prompt {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.6);
            text-align: center;
        }

        .location-prompt-icon {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .location-prompt-icon svg {
            width: 28px;
            height: 28px;
            color: #d4af37;
        }

        .location-prompt h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #f5f5f5;
            margin: 0 0 6px;
        }

        .location-prompt p {
            font-size: 0.9rem;
            color: #8e8e93;
            margin: 0 0 24px;
            line-height: 1.4;
        }

        .location-prompt-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .location-prompt-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 20px;
            border-radius: 12px;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        .location-prompt-btn:active {
            transform: scale(0.98);
        }

        .location-prompt-btn svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .location-prompt-btn.primary {
            background: #d4af37;
            color: #0a0a0a;
        }

        .location-prompt-btn.primary:hover {
            background: #e0bf4a;
        }

        .location-prompt-btn.primary.loading {
            opacity: 0.7;
            cursor: default;
        }

        .location-prompt-btn.secondary {
            background: #2a2a2a;
            color: #f5f5f5;
        }

        .location-prompt-btn.secondary:hover {
            background: #333;
        }

        .location-prompt-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 4px 0;
        }

        .location-prompt-divider::before,
        .location-prompt-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #2a2a2a;
        }

        .location-prompt-divider span {
            font-size: 0.75rem;
            color: #707070;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .location-prompt-search {
            display: flex;
            gap: 8px;
        }

        .location-prompt-search input {
            flex: 1;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid #2a2a2a;
            background: #0f0f0f;
            color: #f5f5f5;
            font-size: 0.9rem;
            font-family: inherit;
            outline: none;
        }

        .location-prompt-search input::placeholder {
            color: #555;
        }

        .location-prompt-search input:focus {
            border-color: #d4af37;
        }

        .location-prompt-search button {
            padding: 12px 16px;
            border-radius: 10px;
            border: none;
            background: #2a2a2a;
            color: #f5f5f5;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }

        .location-prompt-search button:hover {
            background: #3a3a3a;
        }

        .location-prompt-skip {
            background: none;
            border: none;
            color: #707070;
            font-size: 0.85rem;
            font-family: inherit;
            cursor: pointer;
            padding: 8px;
            margin-top: 4px;
            transition: color 0.2s;
        }

        .location-prompt-skip:hover {
            color: #a0a0a0;
        }
        
        /* Drag handle — hidden on desktop */
        .legend-drag-handle {
            display: none;
        }

        /* Legend backdrop — hidden on desktop */
        .legend-backdrop {
            display: none;
        }

        /* Cluster styling overrides */
        .marker-cluster {
            background-clip: padding-box;
        }
        
        .marker-cluster div {
            width: 30px;
            height: 30px;
            margin-left: 5px;
            margin-top: 5px;
            text-align: center;
            border-radius: 50%;
            font: 12px 'Instrument Sans', -apple-system, sans-serif;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .marker-cluster-small {
            background: rgba(0, 0, 0, 0.25);
        }
        .marker-cluster-small div {
            width: 28px;
            height: 28px;
            font-size: 11px;
        }
        
        .marker-cluster-medium {
            background: rgba(0, 0, 0, 0.3);
        }
        .marker-cluster-medium div {
            width: 32px;
            height: 32px;
            font-size: 12px;
        }
        
        .marker-cluster-large {
            background: rgba(0, 0, 0, 0.35);
        }
        .marker-cluster-large div {
            width: 36px;
            height: 36px;
            font-size: 13px;
        }
        
        /* ── Mobile-first improvements ─────────────────────── */
        @media (max-width: 768px) {
            .map-wrapper {
                margin-top: 52px;
            }

            /* Legend panel — compact floating card, top-right on mobile */
            .map-legend {
                top: 8px;
                right: 8px;
                bottom: auto;
                left: auto;
                min-width: auto;
                width: auto;
                border-radius: 12px;
                padding: 10px 12px 10px;
                max-height: none;
                overflow-y: visible;
            }

            .map-legend.collapsed {
                transform: translateX(calc(100% + 12px));
                opacity: 0;
            }

            /* Hide drag handle on mobile — not needed for floating card */
            .legend-drag-handle {
                display: none;
            }

            .legend-header {
                margin-bottom: 8px;
            }

            .legend-header h3 {
                font-size: 0.85rem;
            }

            .legend-close {
                font-size: 1rem;
            }

            .legend-filters {
                gap: 4px;
            }

            .legend-filter {
                padding: 3px 0;
                gap: 8px;
                min-height: auto;
            }

            .filter-dot {
                width: 10px;
                height: 10px;
                border-width: 1.5px;
            }

            .filter-label {
                font-size: 0.75rem;
            }

            .filter-count {
                font-size: 0.65rem;
            }

            /* Legend backdrop — hide for floating card */
            .legend-backdrop {
                display: none !important;
            }

            /* Legend toggle — bottom-right on mobile */
            .legend-toggle {
                top: auto;
                bottom: 10px;
                left: auto;
                right: 12px;
                padding: 8px 12px;
                font-size: 0.75rem;
                min-height: 36px;
                border-radius: 10px;
                gap: 6px;
                padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
            }
            .legend-toggle svg {
                width: 26px;
                height: 13px;
            }

            /* Hide Add To Map on mobile */
            .add-to-map-wrap {
                display: none;
            }

            /* Hide zoom controls on mobile (pinch to zoom) */
            .leaflet-control-zoom {
                display: none !important;
            }
            
            /* Stats bar — bottom left, safe-area aware */
            .map-stats {
                bottom: 10px;
                left: 12px;
                transform: none;
                font-size: 0.8rem;
                padding: 8px 16px;
                gap: 8px;
                border-radius: 8px;
                padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
            }

            /* Locate me — bottom-left, above stats bar */
            .locate-btn {
                top: auto;
                bottom: 48px;
                left: 12px;
                right: auto;
                padding: 10px;
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                padding-bottom: 10px;
            }

            .locate-btn svg {
                width: 22px;
                height: 22px;
            }

            /* Location prompt — full-width on mobile */
            .location-prompt {
                width: 94%;
                padding: 24px 20px;
                border-radius: 14px;
            }

            .location-prompt h3 {
                font-size: 1.15rem;
            }

            .location-prompt p {
                font-size: 0.85rem;
                margin-bottom: 20px;
            }

            .location-prompt-btn {
                padding: 13px 18px;
                font-size: 0.92rem;
                min-height: 48px;
            }

            .location-prompt-search input {
                padding: 12px 14px;
                font-size: 16px; /* prevent iOS auto-zoom on focus */
            }

            .location-prompt-search button {
                min-width: 48px;
                min-height: 48px;
            }

            /* Popup sizing */
            .leaflet-popup-content-wrapper {
                max-width: 240px !important;
            }

            .popup-name {
                font-size: 0.9rem;
            }

            .popup-detail {
                font-size: 0.8rem;
            }
        }

        /* Small phones */
        @media (max-width: 380px) {
            .legend-toggle {
                padding: 6px 10px;
                font-size: 0.7rem;
                gap: 5px;
            }

            .map-stats {
                font-size: 0.72rem;
                padding: 6px 12px;
            }
        }

        /* ═══════════════════════════════════════════════════════
           Search Bar + Overlay (matches iOS CatholicSearchOverlay)
           ═══════════════════════════════════════════════════════ */
        .map-search-bar { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); z-index: 1001; display: flex; align-items: center; gap: 10px; background: rgba(20,20,20,0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid #2a2a2a; border-radius: 22px; padding: 10px 16px; cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,0.4); width: 100%; max-width: 560px; box-sizing: border-box; }
        .map-search-bar svg { flex-shrink: 0; color: #888; }
        .map-search-placeholder { flex: 1; overflow: hidden; white-space: nowrap; }
        .map-search-placeholder-inner { display: inline-flex; align-items: baseline; }
        .map-search-placeholder-static { color: #888; font-size: 0.95rem; }
        .map-search-placeholder-words { display: inline-grid; margin-left: 0.3em; }
        .map-search-placeholder-words > span { grid-area: 1 / 1; }
        .map-search-placeholder-word { color: #6699ff; font-size: 0.95rem; opacity: 0; transition: opacity 0.5s ease; white-space: nowrap; }
        .map-search-placeholder-word.active { opacity: 1; }

        /* Search overlay */
        .map-search-overlay { position: fixed; inset: 0; z-index: 9999; background: #0D0D10; display: none; flex-direction: column; }
        .map-search-overlay.active { display: flex; }
        .map-search-header { display: flex; align-items: center; gap: 10px; padding: 12px 16px; border-bottom: 1px solid #1e1e1e; background: #141414; flex-shrink: 0; }
        .map-search-back { width: 36px; height: 36px; border-radius: 50%; border: none; background: none; color: #999; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .map-search-back:hover { color: #f5f5f5; }
        .map-search-input { flex: 1; padding: 8px 12px; border-radius: 18px; border: 1px solid #2a2a2a; background: #1a1a1a; font-size: 1rem; font-family: inherit; color: #f5f5f5; outline: none; }
        .map-search-input::placeholder { color: #666; }
        .map-search-input:focus { box-shadow: 0 0 0 2px rgba(51,102,204,0.3); }
        .map-search-clear { width: 28px; height: 28px; border-radius: 50%; border: none; background: #2a2a2a; color: #888; cursor: pointer; display: none; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0; }
        .map-search-clear.visible { display: flex; }

        /* Results */
        .map-search-results { flex: 1; overflow-y: auto; padding: 0; overscroll-behavior: contain; }
        .map-search-section-title { font-size: 0.72rem; font-weight: 700; color: #666; text-transform: uppercase; letter-spacing: 0.8px; padding: 16px 16px 6px; }
        .map-search-row { display: flex; align-items: center; gap: 12px; padding: 10px 16px; cursor: pointer; transition: background 0.15s; }
        .map-search-row:hover { background: #1a1a1a; }
        .map-search-row:active { background: #222; }
        .map-search-row-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.85rem; }
        .map-search-row-info { flex: 1; min-width: 0; }
        .map-search-row-title { font-size: 0.92rem; font-weight: 600; color: #f5f5f5; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .map-search-row-subtitle { font-size: 0.78rem; color: #888; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .map-search-row-badge { font-size: 0.65rem; font-weight: 600; color: #888; background: #1e1e1e; padding: 2px 8px; border-radius: 10px; flex-shrink: 0; white-space: nowrap; }
        .map-search-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem 1rem; color: #666; text-align: center; }
        .map-search-empty svg { width: 40px; height: 40px; color: #444; margin-bottom: 12px; }
        .map-search-empty-text { font-size: 0.9rem; }
        .map-search-divider { height: 1px; background: #1e1e1e; margin: 0 16px; }

        @media (max-width: 768px) {
            .map-search-bar { top: 10px; left: 50%; right: auto; transform: translateX(-50%); width: fit-content; max-width: calc(100% - 104px); padding: 9px 14px; border-radius: 14px; gap: 6px; font-size: 0.82rem; }
            .map-search-placeholder { flex: 0 0 auto; }
            .map-search-placeholder-static, .map-search-placeholder-word { font-size: 0.78rem; }
            .map-search-bar svg { width: 14px; height: 14px; }
            .map-search-header { padding: 10px 12px; padding-top: calc(10px + env(safe-area-inset-top, 0px)); }
            .map-search-input { font-size: 0.95rem; }
            .map-search-row { padding: 9px 14px; gap: 10px; }
            .map-search-row-icon { width: 28px; height: 28px; font-size: 0.75rem; }
            .map-search-row-title { font-size: 0.85rem; }
            .map-search-row-subtitle { font-size: 0.72rem; }
        }

        /* ═══════════════════════════════════════════════════════
           Entity Detail Panel (matches iOS Prime Detail Views)
           ═══════════════════════════════════════════════════════ */
        .entity-detail-overlay { position: fixed; inset: 0; z-index: 9998; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: none; justify-content: center; align-items: flex-end; transition: opacity 0.3s; }
        .entity-detail-overlay.active { display: flex; }
        .entity-detail-panel { background: #ffffff; border-radius: 20px 20px 0 0; width: 100%; max-width: 540px; max-height: 85vh; overflow-y: auto; animation: slideUpDetail 0.35s ease-out; overscroll-behavior: contain; }
        @keyframes slideUpDetail { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .entity-detail-handle { display: none; }
        /* Top navigation bar — circular buttons matching iOS */
        .entity-detail-topnav { display: flex; align-items: center; justify-content: space-between; padding: 8px 20px 12px; }
        .entity-detail-topnav-left, .entity-detail-topnav-right { display: flex; align-items: center; gap: 12px; }
        .entity-detail-nav-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid transparent; background: rgba(245,245,245,0.92); display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: background 0.15s, border-color 0.2s; }
        .entity-detail-nav-btn:hover { background: #e8e8e8; }
        .entity-detail-nav-btn svg { width: 16px; height: 16px; color: #111; }
        .entity-detail-nav-btn.editing { border-color: #3366CC; }
        .entity-detail-nav-btn.editing svg { color: #3366CC; }
        .entity-detail-nav-btn.favorited svg { color: #EF4444; fill: #EF4444; }
        .entity-detail-header { display: flex; align-items: flex-start; gap: 14px; padding: 8px 20px 16px; }
        .entity-detail-icon { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; background: #f0f0f0; }
        .entity-detail-header-info { flex: 1; min-width: 0; }
        .entity-detail-name { font-size: 1.25rem; font-weight: 700; color: #111; line-height: 1.3; margin: 0 0 2px; }
        .entity-detail-type-badge { display: inline-block; font-size: 0.72rem; font-weight: 600; color: #666; background: #f0f0f0; padding: 2px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .entity-detail-close { width: 32px; height: 32px; border-radius: 50%; border: none; background: #f0f0f0; color: #666; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; transition: background 0.2s; }
        .entity-detail-close:hover { background: #e0e0e0; }
        .entity-detail-card { margin: 0 20px 16px; padding: 20px; border-radius: 18px; background: #fff; position: relative; box-shadow: 0 6px 12px rgba(0,0,0,0.06); }
        .entity-detail-card.rainbow { border: 3px solid transparent; background: linear-gradient(#fff, #fff) padding-box, conic-gradient(from 0deg, #EF4444, #F97316, #EAB308, #22C55E, #3B82F6, #EC4899, #EF4444) border-box; box-shadow: 0 6px 12px rgba(0,0,0,0.08), 0 0 16px 2px rgba(239,68,68,0.12), 0 0 16px 2px rgba(59,130,246,0.12); }
        .entity-detail-gallery-icon { display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; color: #3366CC; cursor: pointer; }
        .entity-detail-location { display: flex; align-items: center; gap: 6px; color: #777; font-size: 0.88rem; margin-bottom: 8px; }
        .entity-detail-location svg { width: 14px; height: 14px; flex-shrink: 0; }
        .entity-detail-description { font-size: 0.9rem; line-height: 1.6; color: #444; margin-bottom: 8px; }
        .entity-detail-website-row { display: flex; align-items: center; justify-content: space-between; margin-top: 8px; }
        .entity-detail-website-link { display: inline-flex; align-items: center; gap: 6px; color: #3366CC; font-size: 0.88rem; font-weight: 500; text-decoration: none; }
        .entity-detail-website-link svg { width: 14px; height: 14px; }
        .entity-detail-website-link.disabled { color: #bbb; pointer-events: none; }
        /* Follow Key button */
        .entity-detail-follow-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 14px; margin: 0 20px 16px; max-width: calc(100% - 40px); border-radius: 14px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s, transform 0.1s; color: #fff; background: #111; }
        .entity-detail-follow-btn:hover { transform: translateY(-1px); }
        .entity-detail-follow-btn.following { background: #22C55E; }
        .entity-detail-follow-btn svg { width: 18px; height: 18px; }
        /* 3 Quick Action Buttons — type-specific (Parish: Share/Notify/Map, others: Save/Message/[type]) */
        .entity-detail-quick-actions { display: flex; gap: 12px; margin: 0 20px 20px; }
        .entity-detail-quick-action { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 14px 0; border-radius: 18px; border: none; background: #f2f2f7; cursor: pointer; transition: background 0.15s, transform 0.1s; text-decoration: none; }
        .entity-detail-quick-action:hover { background: #e5e5ea; transform: translateY(-1px); }
        .entity-detail-quick-action svg { width: 18px; height: 18px; color: #011893; }
        .entity-detail-quick-action span { font-size: 0.72rem; font-weight: 500; color: #011893; }
        /* Legacy inline action buttons (for type-specific links) */
        .entity-detail-actions { display: flex; gap: 8px; flex-wrap: wrap; margin: 0 20px 12px; }
        .entity-detail-action-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 10px; border: 1px solid #ddd; background: #f0f0f5; color: #3366CC; font-size: 0.82rem; font-weight: 600; cursor: pointer; text-decoration: none; transition: background 0.2s, transform 0.1s; }
        .entity-detail-action-btn:hover { background: #e8e8f0; transform: translateY(-1px); }
        .entity-detail-action-btn svg { width: 14px; height: 14px; }
        .entity-detail-action-btn.primary-action { background: rgba(51,102,204,0.1); border-color: rgba(51,102,204,0.25); color: #3366CC; }
        /* Locked parish upsell */
        .entity-detail-upsell-hero { text-align: center; padding: 20px 20px 8px; font-size: 1.15rem; font-weight: 700; color: #111; line-height: 1.4; }
        .entity-detail-benefits-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 12px 20px 20px; }
        .entity-detail-benefit { padding: 16px 8px; background: #f2f2f7; border-radius: 12px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .entity-detail-benefit-icon { display: flex; align-items: center; justify-content: center; margin-bottom: 8px; color: #22C55E; }
        .entity-detail-benefit-icon svg { width: 28px; height: 28px; }
        .entity-detail-benefit-title { font-size: 0.82rem; font-weight: 600; color: #111; margin-bottom: 4px; }
        .entity-detail-benefit-desc { font-size: 0.7rem; color: #888; line-height: 1.4; }
        .entity-detail-unlock-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 16px; border-radius: 12px; border: 3px solid transparent; background: linear-gradient(#111, #111) padding-box, conic-gradient(from 0deg, #EF4444, #F97316, #EAB308, #22C55E, #3B82F6, #8B5CF6, #EF4444) border-box; color: #fff; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.1s; text-decoration: none; box-sizing: border-box; }
        .entity-detail-unlock-btn:hover { transform: translateY(-1px); }
        .entity-detail-see-example { display: block; text-align: center; color: #3366CC; font-size: 0.88rem; font-weight: 500; margin-bottom: 20px; cursor: pointer; text-decoration: none; }
        /* Schedule segmented control (Mass/Confession/Adoration tabs) */
        .entity-detail-schedule-tabs { display: flex; margin: 0 20px 0; background: #1a2744; border-radius: 12px; overflow: hidden; }
        .entity-detail-schedule-tab { flex: 1; padding: 10px 0; text-align: center; font-size: 0.78rem; font-weight: 600; color: rgba(255,255,255,0.5); cursor: pointer; transition: background 0.2s, color 0.2s; border: none; background: transparent; }
        .entity-detail-schedule-tab.active { background: #3366CC; color: #fff; border-radius: 10px; margin: 3px; }
        .entity-detail-schedule-tab-content { display: none; }
        .entity-detail-schedule-tab-content.active { display: block; }
        /* Get Involved 2x2 grid */
        .entity-detail-get-involved { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 8px 20px 16px; }
        .entity-detail-program-card { display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 16px 8px; background: #f2f2f7; border-radius: 12px; cursor: pointer; transition: background 0.15s; text-decoration: none; }
        .entity-detail-program-card:hover { background: #e5e5ea; }
        .entity-detail-program-card svg { width: 24px; height: 24px; color: #3366CC; }
        .entity-detail-program-card .program-title { font-size: 0.82rem; font-weight: 600; color: #111; }
        .entity-detail-program-card .program-sub { font-size: 0.68rem; color: #888; }
        /* Sign-Up Sheets button */
        .entity-detail-signup-btn { display: flex; align-items: center; gap: 16px; margin: 8px 20px 16px; padding: 16px; background: #f2f2f7; border-radius: 16px; cursor: pointer; transition: background 0.15s; text-decoration: none; border: none; width: calc(100% - 40px); }
        .entity-detail-signup-btn:hover { background: #e5e5ea; }
        .entity-detail-signup-icon { width: 50px; height: 50px; border-radius: 50%; background: rgba(51,102,204,0.15); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .entity-detail-signup-icon svg { width: 20px; height: 20px; color: #3366CC; }
        .entity-detail-signup-text { flex: 1; text-align: left; }
        .entity-detail-signup-text .title { font-size: 0.95rem; font-weight: 600; color: #111; }
        .entity-detail-signup-text .sub { font-size: 0.82rem; color: #888; margin-top: 2px; }
        .entity-detail-signup-chevron { color: #888; flex-shrink: 0; }
        .entity-detail-signup-chevron svg { width: 14px; height: 14px; }
        /* Location map embed */
        .entity-detail-map-section { margin: 8px 20px 16px; }
        .entity-detail-map-section .section-label { font-size: 1.05rem; font-weight: 700; color: #111; margin-bottom: 12px; }
        .entity-detail-map-embed { width: 100%; height: 220px; border-radius: 24px; overflow: hidden; position: relative; }
        .entity-detail-map-embed iframe { width: 100%; height: 100%; border: 0; }
        .entity-detail-map-open-btn { position: absolute; top: 10px; right: 10px; display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: #111; color: #fff; border-radius: 16px; font-size: 0.82rem; font-weight: 700; cursor: pointer; text-decoration: none; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border: none; z-index: 2; }
        /* Bulletin upload CTA */
        .entity-detail-bulletin { margin: 8px 20px 16px; padding: 24px 20px; background: rgba(51,102,204,0.08); border: 1px dashed rgba(51,102,204,0.35); border-radius: 16px; text-align: center; cursor: pointer; transition: background 0.15s; }
        .entity-detail-bulletin:hover { background: rgba(51,102,204,0.12); }
        .entity-detail-bulletin svg { width: 32px; height: 32px; color: #3366CC; margin-bottom: 12px; }
        .entity-detail-bulletin .bulletin-title { font-size: 0.95rem; font-weight: 600; color: #111; margin-bottom: 4px; }
        .entity-detail-bulletin .bulletin-sub { font-size: 0.78rem; color: #888; }
        /* Message Parish button */
        .entity-detail-message-btn { display: flex; align-items: center; justify-content: center; gap: 8px; margin: 8px 20px 20px; padding: 16px; background: #3366CC; color: #fff; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; width: calc(100% - 40px); transition: background 0.15s; text-decoration: none; }
        .entity-detail-message-btn:hover { background: #2a57b0; }
        .entity-detail-message-btn svg { width: 16px; height: 16px; }
        /* Pilgrimage listing cards (matches iOS PilgrimageListingCard) */
        .entity-detail-travel-section { margin: 12px 20px 16px; padding: 14px; background: rgba(0,0,0,0.03); border-radius: 12px; }
        .entity-detail-travel-section .travel-heading { font-size: 1.05rem; font-weight: 700; color: #111; margin-bottom: 12px; }
        .entity-detail-listing-card { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; padding: 16px; background: #fff; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px; }
        .entity-detail-listing-card:last-child { margin-bottom: 0; }
        .entity-detail-listing-info { flex: 1; min-width: 0; }
        .entity-detail-listing-price { font-size: 1.25rem; font-weight: 700; color: #DC2626; margin-bottom: 4px; }
        .entity-detail-listing-price .limited-badge { display: inline-block; font-size: 0.65rem; font-weight: 600; color: #fff; background: #F97316; padding: 2px 8px; border-radius: 8px; margin-left: 8px; vertical-align: middle; }
        .entity-detail-listing-date { display: flex; align-items: center; gap: 6px; font-size: 0.88rem; color: #111; margin-bottom: 2px; }
        .entity-detail-listing-date svg { width: 14px; height: 14px; color: #3366CC; flex-shrink: 0; }
        .entity-detail-listing-spots { font-size: 0.78rem; color: #888; margin-top: 4px; }
        .entity-detail-listing-explore { display: inline-flex; align-items: center; gap: 6px; padding: 14px 20px; background: linear-gradient(135deg, #DC2626, #DC2626cc); color: #fff; border: none; border-radius: 16px; font-size: 0.88rem; font-weight: 600; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 8px rgba(220,38,38,0.3); transition: transform 0.1s; flex-shrink: 0; text-decoration: none; }
        .entity-detail-listing-explore:hover { transform: translateY(-1px); }
        .entity-detail-listing-explore svg { width: 16px; height: 16px; }
        .entity-detail-listing-explore.disabled { background: #999; box-shadow: none; pointer-events: none; }
        .entity-detail-travel-empty { font-size: 0.88rem; color: #888; padding: 8px 0; }
        /* Pilgrimage reserve modal */
        .pilgrimage-reserve-overlay { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: flex-end; }
        .pilgrimage-reserve-overlay.active { display: flex; }
        .pilgrimage-reserve-panel { background: #fff; border-radius: 20px 20px 0 0; width: 100%; max-width: 540px; max-height: 85vh; overflow-y: auto; padding: 24px; animation: slideUpDetail 0.35s ease-out; }
        .pilgrimage-reserve-close { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .pilgrimage-reserve-close h2 { font-size: 1.15rem; font-weight: 700; color: #111; margin: 0; }
        .pilgrimage-reserve-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
        .pilgrimage-reserve-info-card { padding: 14px; background: #f2f2f7; border-radius: 12px; text-align: center; }
        .pilgrimage-reserve-info-card .label { font-size: 0.72rem; font-weight: 600; color: #888; text-transform: uppercase; margin-bottom: 4px; }
        .pilgrimage-reserve-info-card .value { font-size: 1rem; font-weight: 700; color: #111; }
        .pilgrimage-reserve-cta { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 16px; background: linear-gradient(135deg, #DC2626, #DC2626cc); color: #fff; border: none; border-radius: 16px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 16px; text-decoration: none; box-shadow: 0 2px 8px rgba(220,38,38,0.3); }
        .pilgrimage-reserve-cta:hover { transform: translateY(-1px); }
        .pilgrimage-reserve-cta svg { width: 16px; height: 16px; }
        .entity-detail-section-title { font-size: 0.75rem; font-weight: 700; color: #999; text-transform: uppercase; letter-spacing: 0.8px; padding: 12px 20px 6px; }
        .entity-detail-schedule { margin: 0 16px 8px; padding: 12px 14px; background: #f8f8fa; border-radius: 12px; }
        .entity-detail-schedule-row { display: flex; justify-content: space-between; font-size: 0.82rem; color: #777; padding: 3px 0; }
        .entity-detail-schedule-row .day { color: #333; font-weight: 500; }
        .entity-detail-schedule-row .times { text-align: right; color: #666; }
        /* Upcoming Events — horizontal scroll cards matching iOS */
        .entity-detail-events-heading { font-size: 1.15rem; font-weight: 700; color: #111; padding: 16px 24px 10px; }
        .entity-detail-events { overflow-x: auto; padding-bottom: 16px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .entity-detail-events::-webkit-scrollbar { display: none; }
        .entity-detail-events-inner { display: flex; gap: 12px; padding: 0 24px; }
        .entity-detail-event-item { flex: 0 0 auto; width: 48%; min-width: 180px; max-width: 240px; padding: 16px; background: #f2f2f7; border-radius: 14px; scroll-snap-align: start; }
        .entity-detail-event-title { font-size: 0.92rem; font-weight: 700; color: #111; margin-bottom: 8px; line-height: 1.3; }
        .entity-detail-event-meta { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #888; margin-bottom: 4px; }
        .entity-detail-event-meta svg { width: 14px; height: 14px; flex-shrink: 0; color: #888; }
        .entity-detail-programs { display: flex; flex-wrap: wrap; gap: 6px; margin: 0 16px 16px; }
        .entity-detail-program-pill { display: inline-flex; align-items: center; gap: 4px; padding: 5px 10px; background: rgba(34, 197, 94, 0.08); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; color: #16a34a; font-size: 0.75rem; font-weight: 600; }
        .entity-detail-info-grid { margin: 0 16px 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .entity-detail-info-item { padding: 10px 12px; background: #f8f8fa; border-radius: 10px; }
        .entity-detail-info-label { font-size: 0.68rem; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        .entity-detail-info-value { font-size: 0.88rem; color: #111; font-weight: 500; }
        .entity-detail-info-full { margin: 0 16px 8px; padding: 12px 14px; background: #f8f8fa; border-radius: 12px; }
        .entity-detail-info-full .info-title { font-size: 0.82rem; font-weight: 600; color: #333; margin-bottom: 4px; }
        .entity-detail-info-full .info-text { font-size: 0.82rem; color: #666; line-height: 1.5; }
        .entity-detail-stats { display: flex; gap: 8px; margin: 0 16px 12px; }
        .entity-detail-stat { flex: 1; padding: 12px; background: #f8f8fa; border-radius: 12px; text-align: center; }
        .entity-detail-stat .stat-value { font-size: 1.25rem; font-weight: 700; color: #d4af37; }
        .entity-detail-stat .stat-label { font-size: 0.68rem; color: #999; margin-top: 2px; }
        .entity-detail-contact { margin: 0 16px 16px; padding: 12px 14px; background: #f8f8fa; border-radius: 12px; }
        .entity-detail-contact-row { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 0.85rem; }
        .entity-detail-contact-row svg { width: 14px; height: 14px; color: #999; flex-shrink: 0; }
        .entity-detail-contact-row a { color: #3366CC; text-decoration: none; }
        .entity-detail-contact-row span { color: #333; }
        .entity-detail-footer { padding: 12px 16px 24px; display: flex; gap: 8px; }
        .entity-detail-footer-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: background 0.2s, transform 0.1s; }
        .entity-detail-footer-btn:hover { transform: translateY(-1px); }
        .entity-detail-footer-btn.primary { background: #3366CC; color: #fff; }
        .entity-detail-footer-btn.secondary { background: #f0f0f5; border: 1px solid #ddd; color: #333; }
        .entity-detail-footer-btn svg { width: 16px; height: 16px; }
        .entity-detail-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; gap: 12px; }
        .entity-detail-spinner { width: 32px; height: 32px; border: 3px solid #ddd; border-top-color: #3366CC; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .entity-detail-loading-text { font-size: 0.85rem; color: #999; }
        .entity-detail-hours { margin: 0 16px 12px; padding: 12px 14px; background: #f8f8fa; border-radius: 12px; }
        .entity-detail-hours-row { display: flex; justify-content: space-between; font-size: 0.82rem; color: #777; padding: 3px 0; }
        .entity-detail-hours-row .day { color: #333; font-weight: 500; }
        .entity-detail-hours-row .time { color: #666; text-align: right; }
        .entity-detail-social { display: flex; gap: 8px; margin: 0 16px 16px; flex-wrap: wrap; }
        .entity-detail-social a { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: #f0f0f5; border: 1px solid #ddd; border-radius: 8px; color: #3366CC; font-size: 0.78rem; font-weight: 600; text-decoration: none; }
        /* Hero image */
        .entity-detail-hero { width: 100%; height: 200px; object-fit: cover; border-radius: 16px 16px 0 0; display: block; }
        .entity-detail-hero-carousel { position: relative; width: 100%; height: 200px; overflow: hidden; border-radius: 16px 16px 0 0; }
        .entity-detail-hero-carousel img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.4s; }
        .entity-detail-hero-carousel img.active { opacity: 1; }
        .entity-detail-hero-dots { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; }
        .entity-detail-hero-dots span { width: 7px; height: 7px; border-radius: 50%; background: rgba(255,255,255,0.5); cursor: pointer; }
        .entity-detail-hero-dots span.active { background: #fff; }
        /* Owner edit bar */
        .entity-detail-edit-bar { display: flex; align-items: center; justify-content: flex-end; gap: 8px; padding: 8px 20px 0; }
        .entity-detail-edit-toggle { width: 36px; height: 36px; border-radius: 50%; border: 1px solid #ddd; background: #f8f8fa; color: #666; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .entity-detail-edit-toggle:hover { background: #eee; }
        .entity-detail-edit-toggle.active { background: #3366CC; color: #fff; border-color: #3366CC; }
        .entity-detail-add-section-btn { display: flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 10px; border: 1px solid #ddd; background: #f8f8fa; color: #3366CC; font-size: 0.82rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .entity-detail-add-section-btn:hover { background: #eee; }
        .entity-detail-delete-btn { display: flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 10px; border: 1px solid rgba(220,38,38,0.3); background: rgba(220,38,38,0.06); color: #DC2626; font-size: 0.82rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .entity-detail-delete-btn:hover { background: rgba(220,38,38,0.12); }
        .entity-detail-delete-btn svg { color: #DC2626; }
        /* Editable field */
        .entity-detail-editable { position: relative; }
        .entity-detail-editable.editing { background: #f0f4ff; border-radius: 8px; padding: 8px; }
        .entity-detail-editable textarea, .entity-detail-editable input[type="text"] { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 8px; font-family: inherit; font-size: 0.88rem; color: #111; background: #fff; resize: vertical; box-sizing: border-box; }
        .entity-detail-save-btn { display: inline-flex; align-items: center; gap: 4px; padding: 6px 14px; margin-top: 6px; border-radius: 8px; border: none; background: #3366CC; color: #fff; font-size: 0.78rem; font-weight: 600; cursor: pointer; }
        /* Message owner button */
        .entity-detail-msg-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 10px; border: 1px solid #ddd; background: #f0f0f5; color: #3366CC; font-size: 0.82rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .entity-detail-msg-btn:hover { background: #e8e8f0; }
        /* Add section modal */
        .entity-detail-add-modal { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; }
        .entity-detail-add-modal.active { display: flex; }
        .entity-detail-add-modal-content { background: #fff; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; max-height: 70vh; overflow-y: auto; }
        .entity-detail-add-modal-title { font-size: 1.1rem; font-weight: 700; color: #111; margin-bottom: 16px; }
        .entity-detail-add-modal-item { padding: 12px 14px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: background 0.15s; }
        .entity-detail-add-modal-item:hover { background: #f0f4ff; }
        .entity-detail-add-modal-item h4 { font-size: 0.9rem; font-weight: 600; color: #111; margin: 0 0 2px; }
        .entity-detail-add-modal-item p { font-size: 0.78rem; color: #777; margin: 0; }
        /* PSA card */
        .entity-detail-psa { margin: 0 16px 8px; padding: 14px; background: #f8f8fa; border-radius: 12px; border-left: 3px solid #d4af37; }
        .entity-detail-psa-title { font-size: 0.88rem; font-weight: 600; color: #111; margin-bottom: 4px; }
        .entity-detail-psa-text { font-size: 0.82rem; color: #444; line-height: 1.5; }
        .entity-detail-psa-meta { font-size: 0.72rem; color: #999; margin-top: 6px; }
        /* Gallery grid */
        .entity-detail-gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin: 0 16px 12px; border-radius: 12px; overflow: hidden; }
        .entity-detail-gallery img { width: 100%; aspect-ratio: 1; object-fit: cover; cursor: pointer; }
        /* Staff list */
        .entity-detail-staff-item { display: flex; align-items: center; gap: 10px; padding: 8px 14px; margin: 0 16px 4px; background: #f8f8fa; border-radius: 10px; }
        .entity-detail-staff-avatar { width: 36px; height: 36px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; color: #666; flex-shrink: 0; }
        .entity-detail-staff-name { font-size: 0.85rem; font-weight: 600; color: #111; }
        .entity-detail-staff-role { font-size: 0.75rem; color: #777; }
        /* Job listing */
        .entity-detail-job { margin: 0 16px 8px; padding: 12px 14px; background: #f8f8fa; border-radius: 12px; }
        .entity-detail-job-title { font-size: 0.88rem; font-weight: 600; color: #111; }
        .entity-detail-job-meta { font-size: 0.78rem; color: #777; margin-top: 2px; }
        .entity-detail-job-desc { font-size: 0.82rem; color: #444; margin-top: 6px; line-height: 1.5; }
        /* Vocation process steps */
        .entity-detail-step { display: flex; gap: 12px; margin: 0 16px 8px; }
        .entity-detail-step-num { width: 28px; height: 28px; border-radius: 50%; background: #3366CC; color: #fff; font-size: 0.78rem; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .entity-detail-step-text { flex: 1; }
        .entity-detail-step-title { font-size: 0.85rem; font-weight: 600; color: #111; }
        .entity-detail-step-desc { font-size: 0.78rem; color: #666; margin-top: 2px; line-height: 1.4; }
        /* Member count badge */
        .entity-detail-member-count { display: inline-flex; align-items: center; gap: 4px; font-size: 0.78rem; color: #777; margin-top: 4px; }
        @media (min-width: 769px) { .entity-detail-overlay { align-items: center; } .entity-detail-panel { border-radius: 20px; max-height: 80vh; } }
        @media (max-width: 768px) { .entity-detail-panel { max-height: 90vh; } .entity-detail-header { padding: 6px 16px 12px; } .entity-detail-name { font-size: 1.15rem; } .entity-detail-card { margin: 0 12px 12px; } .entity-detail-footer { padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px)); } .entity-detail-hero, .entity-detail-hero-carousel { height: 160px; } }
    </style>
</head>
<body class="map-page">
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-logo">
                <img src="assets/whitenavelogo.png" alt="Nave" class="logo-img">
                <span class="logo-text">Nave</span>
            </a>
            <div class="nav-links" id="nav-links">
                <a href="map.html" class="nav-link nav-link-active">Map</a>
                <a href="engage.html" class="nav-link">Engage</a>
                <a href="ask-gabe.html" class="nav-link">Ask</a>
                <a href="about.html" class="nav-link">About</a>
                <a href="join.html" class="nav-cta">Try Nave Free</a>
            </div>
            <button class="nav-hamburger" id="nav-hamburger" aria-label="Menu" onclick="document.getElementById('nav-links').classList.toggle('open');document.getElementById('nav-backdrop').classList.toggle('visible');">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </button>
        </div>
    </nav>
    <div class="nav-backdrop" id="nav-backdrop" onclick="document.getElementById('nav-links').classList.remove('open');this.classList.remove('visible');"></div>

    <!-- Map Container -->
    <div class="map-wrapper">
        <!-- Search Bar -->
        <div class="map-search-bar" id="map-search-bar" onclick="openMapSearch()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <div class="map-search-placeholder" id="search-placeholder">
                <span class="map-search-placeholder-inner">
                    <span class="map-search-placeholder-static">Search Catholic</span><span class="map-search-placeholder-words"><span class="map-search-placeholder-word active" data-idx="0">Culture</span><span class="map-search-placeholder-word" data-idx="1">Churches</span><span class="map-search-placeholder-word" data-idx="2">Missionaries</span><span class="map-search-placeholder-word" data-idx="3">Businesses</span><span class="map-search-placeholder-word" data-idx="4">Schools</span><span class="map-search-placeholder-word" data-idx="5">Vocations</span><span class="map-search-placeholder-word" data-idx="6">Retreats</span><span class="map-search-placeholder-word" data-idx="7">Pilgrimages</span><span class="map-search-placeholder-word" data-idx="8">Campus</span></span>
                </span>
            </div>
        </div>

        <!-- Search Overlay -->
        <div class="map-search-overlay" id="map-search-overlay">
            <div class="map-search-header">
                <button class="map-search-back" onclick="closeMapSearch()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                </button>
                <input type="text" class="map-search-input" id="map-search-input" placeholder="Search Catholic Culture" autocomplete="off">
                <button class="map-search-clear" id="map-search-clear" onclick="clearMapSearch()">&times;</button>
            </div>
            <div class="map-search-results" id="map-search-results">
                <div class="map-search-empty" id="map-search-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <div class="map-search-empty-text">Search across all Catholic resources</div>
                </div>
            </div>
        </div>

        <!-- Location Prompt -->
        <div id="location-prompt-overlay" class="location-prompt-overlay">
            <div class="location-prompt">
                <div class="location-prompt-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                </div>
                <h3>Where are you?</h3>
                <p>Help us show Catholic resources near you</p>
                <div class="location-prompt-actions">
                    <button class="location-prompt-btn primary" id="use-my-location-btn" onclick="useMyLocation()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                        </svg>
                        Use My Location
                    </button>

                    <div class="location-prompt-divider"><span>or</span></div>

                    <div class="location-prompt-search">
                        <input type="text" id="city-search-input" placeholder="Enter city or zip code" autocomplete="off">
                        <button onclick="searchCity()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            </svg>
                        </button>
                    </div>

                    <button class="location-prompt-skip" onclick="dismissPrompt()">
                        Browse the full map →
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="map-loading" class="map-loading">
            <div class="map-loading-spinner"></div>
            <div class="map-loading-text">Loading Catholic locations...</div>
        </div>
        
        <!-- Map -->
        <div id="map"></div>
        
        <!-- Add To Map Button (desktop only) -->
        <div class="add-to-map-wrap"><a href="join.html" class="add-to-map-btn">Add To Map</a></div>

        <!-- Legend / Filters -->
        <div id="map-legend" class="map-legend">
            <div class="legend-drag-handle" onclick="toggleLegend()"><span></span></div>
            <div class="legend-header">
                <h3>Map Legend</h3>
                <button class="legend-close" onclick="toggleLegend()">&times;</button>
            </div>
            <div class="legend-filters">
                <label class="legend-filter">
                    <input type="checkbox" data-type="church" checked>
                    <span class="filter-dot" style="background: #3B82F6;"></span>
                    <span class="filter-label">Church</span>
                    <span class="filter-count" id="count-church">0</span>
                </label>
                <label class="legend-filter">
                    <input type="checkbox" data-type="missionary" checked>
                    <span class="filter-dot" style="background: #D4A017;"></span>
                    <span class="filter-label">Missionary</span>
                    <span class="filter-count" id="count-missionary">0</span>
                </label>
                <label class="legend-filter">
                    <input type="checkbox" data-type="pilgrimage" checked>
                    <span class="filter-dot" style="background: #EF4444;"></span>
                    <span class="filter-label">Pilgrimage</span>
                    <span class="filter-count" id="count-pilgrimage">0</span>
                </label>
                <label class="legend-filter">
                    <input type="checkbox" data-type="school" checked>
                    <span class="filter-dot" style="background: #A855F7;"></span>
                    <span class="filter-label">Education</span>
                    <span class="filter-count" id="count-school">0</span>
                </label>
                <label class="legend-filter">
                    <input type="checkbox" data-type="vocation" checked>
                    <span class="filter-dot" style="background: #22C55E;"></span>
                    <span class="filter-label">Vocation</span>
                    <span class="filter-count" id="count-vocation">0</span>
                </label>
                <label class="legend-filter">
                    <input type="checkbox" data-type="retreat" checked>
                    <span class="filter-dot" style="background: #F97316;"></span>
                    <span class="filter-label">Retreat</span>
                    <span class="filter-count" id="count-retreat">0</span>
                </label>
                <label class="legend-filter">
                    <input type="checkbox" data-type="business" checked>
                    <span class="filter-dot" style="background: #A1887F;"></span>
                    <span class="filter-label">Business</span>
                    <span class="filter-count" id="count-business">0</span>
                </label>
                <label class="legend-filter">
                    <input type="checkbox" data-type="campus" checked>
                    <span class="filter-dot" style="background: #166534;"></span>
                    <span class="filter-label">Campus</span>
                    <span class="filter-count" id="count-campus">0</span>
                </label>
            </div>
        </div>
        
        <!-- Toggle Legend Button (when legend is hidden) -->
        <button id="legend-toggle" class="legend-toggle" onclick="toggleLegend()">
            <span class="legend-toggle-label">Map Legend</span>
            <svg width="28" height="14" viewBox="0 0 28 14" fill="currentColor">
                <circle cx="2.5" cy="3.5" r="2.4" fill="#3B82F6"/>
                <circle cx="9.5" cy="3.5" r="2.4" fill="#D4A017"/>
                <circle cx="16.5" cy="3.5" r="2.4" fill="#EF4444"/>
                <circle cx="23.5" cy="3.5" r="2.4" fill="#A855F7"/>
                <circle cx="2.5" cy="10.5" r="2.4" fill="#22C55E"/>
                <circle cx="9.5" cy="10.5" r="2.4" fill="#F97316"/>
                <circle cx="16.5" cy="10.5" r="2.4" fill="#A1887F"/>
                <circle cx="23.5" cy="10.5" r="2.4" fill="#166534"/>
            </svg>
        </button>
        
        <!-- Legend backdrop (mobile only — closes legend on tap) -->
        <div id="legend-backdrop" class="legend-backdrop" onclick="toggleLegend()"></div>

        <!-- Locate Me Button -->
        <button class="locate-btn" onclick="locateMe()" title="Find my location">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
            </svg>
        </button>
        
        <!-- Stats Bar -->
        <div class="map-stats">
            <span><span class="stat-highlight" id="total-visible">0</span> Cultural Keys</span>
        </div>
    </div>

    <!-- Entity Detail Panel -->
    <div class="entity-detail-overlay" id="entity-detail-overlay">
        <div class="entity-detail-panel" id="entity-detail-panel">
            <div class="entity-detail-handle"><span></span></div>
            <div class="entity-detail-topnav">
                <div class="entity-detail-topnav-left">
                    <button class="entity-detail-nav-btn" onclick="closeEntityDetail()" title="Back">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                </div>
                <div class="entity-detail-topnav-right" id="entity-detail-topnav-right">
                    <!-- Populated dynamically by updateTopNavButtons() -->
                </div>
            </div>
            <div id="entity-detail-content"></div>
        </div>
    </div>

    <!-- Add Section Modal -->
    <div class="entity-detail-add-modal" id="add-section-modal">
        <div class="entity-detail-add-modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <div class="entity-detail-add-modal-title">Add Section</div>
                <button onclick="closeAddSectionModal()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:#666;">&times;</button>
            </div>
            <div id="add-section-list"></div>
        </div>
    </div>

    <!-- Pilgrimage Reserve Modal (matches iOS PilgrimageReserveView) -->
    <div class="pilgrimage-reserve-overlay" id="pilgrimage-reserve-overlay">
        <div class="pilgrimage-reserve-panel">
            <div class="pilgrimage-reserve-close">
                <h2 id="reserve-title">Trip Details</h2>
                <button onclick="closePilgrimageReserve()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666;">&times;</button>
            </div>
            <div id="reserve-content"></div>
        </div>
    </div>

    <!-- Waitlist Popup (30s) -->
    <div id="map-waitlist-overlay" class="location-prompt-overlay hidden" style="z-index: 1100;">
        <div class="location-prompt" style="text-align: center;">
            <button onclick="closeMapWaitlist()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:#707070;font-size:1.5rem;cursor:pointer;line-height:1;">&times;</button>
            <div class="location-prompt-icon" style="margin: 0 auto 16px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="#d4af37" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
            </div>
            <h3 style="color:#f5f5f5;font-size:1.25rem;margin:0 0 8px;">Join the Waitlist</h3>
            <p style="color:#888;font-size:0.9rem;margin:0 0 20px;">Love exploring? Be the first to know when Nave launches on iOS.</p>
            <form id="map-waitlist-form">
                <input type="email" id="map-waitlist-email" placeholder="you@email.com" required style="width:100%;padding:12px 16px;font-size:1rem;border:1px solid #333;border-radius:10px;background:#111;color:#f5f5f5;margin-bottom:12px;box-sizing:border-box;">
                <button type="submit" class="map-waitlist-btn" style="width:100%;padding:12px;font-size:1rem;font-weight:600;color:#000;background:#fff;border:none;border-radius:10px;cursor:pointer;">Join the Waitlist</button>
            </form>
            <div id="map-waitlist-success" class="hidden" style="padding:20px 0;">
                <svg width="48" height="48" viewBox="0 0 20 20" fill="none" style="margin:0 auto 12px;display:block;">
                    <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm-2 15l-5-5 1.41-1.41L8 12.17l7.59-7.59L17 6l-9 9z" fill="#d4af37"/>
                </svg>
                <p style="color:#f5f5f5;font-size:1rem;">You're on the list! We'll be in touch.</p>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, getDoc, doc, query, where, addDoc, setDoc, serverTimestamp, updateDoc, onSnapshot, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Firebase config (same project as iOS app)
        const firebaseConfig = {
            apiKey: "AIzaSyDMzrI35yZxIlUr-OJ56acE_bMnYnrHoEw",
            authDomain: "navefirebase.firebaseapp.com",
            projectId: "navefirebase",
            storageBucket: "navefirebase.firebasestorage.app",
            messagingSenderId: "701712826975",
            appId: "1:701712826975:web:placeholder"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUser = null;
        onAuthStateChanged(auth, (user) => { currentUser = user; });

        // Pin colors matching iOS app
        const PIN_COLORS = {
            church: '#3B82F6',
            missionary: '#D4A017',
            pilgrimage: '#EF4444',
            school: '#A855F7',
            vocation: '#22C55E',
            retreat: '#F97316',
            business: '#A1887F',
            campus: '#166534'
        };
        
        // Collection mapping (must match Firebase exactly)
        const COLLECTIONS = {
            church: 'Churches',
            missionary: 'missionaries',
            pilgrimage: 'pilgrimageSites',
            school: 'schools',
            vocation: 'vocations',
            retreat: 'retreats',
            business: 'businesses',
            campus: 'bibleStudies'
        };
        
        // Initialize map
        const map = L.map('map', {
            center: [39.5, -98.35],  // Center of US
            zoom: 5,
            zoomControl: true,
            attributionControl: true
        });
        
        // Dark-themed tile layer (CartoDB Dark Matter)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // Create color-coded cluster icon factory
        function createClusterIcon(type) {
            return function(cluster) {
                const count = cluster.getChildCount();
                let size = 'small';
                if (count >= 100) size = 'large';
                else if (count >= 10) size = 'medium';
                
                const color = PIN_COLORS[type];
                const dims = size === 'large' ? 44 : size === 'medium' ? 40 : 36;
                const innerDims = dims - 8;
                
                return L.divIcon({
                    html: `<div style="background:${color}; width:${innerDims}px; height:${innerDims}px;">${count}</div>`,
                    className: `marker-cluster marker-cluster-${size}`,
                    iconSize: L.point(dims, dims)
                });
            };
        }
        
        // Cluster layer groups for each type
        const layers = {};
        const markerCounts = {};
        
        Object.keys(PIN_COLORS).forEach(type => {
            // Churches cluster more aggressively since there are so many
            const clusterRadius = (type === 'church') ? 200 : 50;
            const unclusterZoom = (type === 'church') ? 9 : 15;
            
            layers[type] = L.markerClusterGroup({
                iconCreateFunction: createClusterIcon(type),
                maxClusterRadius: clusterRadius,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                disableClusteringAtZoom: unclusterZoom
            }).addTo(map);
            markerCounts[type] = 0;
        });
        
        // ── Entity data store ─────────────────────────────────
        const entityDataMap = new Map();

        // Create circle marker — click opens detail panel
        function createMarker(lat, lng, type, name, detail, docId) {
            const marker = L.circleMarker([lat, lng], {
                radius: 6,
                fillColor: PIN_COLORS[type],
                color: '#ffffff',
                weight: 1.5,
                opacity: 0.9,
                fillOpacity: 0.85
            });

            // Click → open full detail panel
            marker.on('click', () => openMapEntityDetail(docId));
            
            return marker;
        }
        
        // Extract coordinates from different document structures
        function getCoords(doc, type) {
            const d = doc.data();
            
            // Missionaries: coordinates nested in locationPrimary { latitude, longitude }
            if (type === 'missionary') {
                if (d.locationPrimary) {
                    const lp = d.locationPrimary;
                    if (lp.latitude !== undefined && lp.longitude !== undefined) {
                        return { lat: lp.latitude, lng: lp.longitude };
                    }
                    if (lp.coordinates) {
                        const c = lp.coordinates;
                        if (c.latitude !== undefined) return { lat: c.latitude, lng: c.longitude };
                    }
                }
                // Also try locationSecondary if primary has no coords
                if (d.locationSecondary) {
                    const ls = d.locationSecondary;
                    if (ls.latitude !== undefined && ls.longitude !== undefined) {
                        return { lat: ls.latitude, lng: ls.longitude };
                    }
                }
            }
            
            // Schools have nested location object
            if (type === 'school') {
                if (d.location?.coordinates) {
                    const c = d.location.coordinates;
                    // GeoPoint
                    if (c.latitude !== undefined) return { lat: c.latitude, lng: c.longitude };
                    if (c._latitude !== undefined) return { lat: c._latitude, lng: c._longitude };
                    // Array [lat, lng]
                    if (Array.isArray(c)) return { lat: c[0], lng: c[1] };
                }
                if (d.location?.latitude !== undefined) return { lat: d.location.latitude, lng: d.location.longitude };
            }
            
            // GeoPoint in coordinates field
            if (d.coordinates) {
                const c = d.coordinates;
                if (c.latitude !== undefined) return { lat: c.latitude, lng: c.longitude };
                if (c._latitude !== undefined) return { lat: c._latitude, lng: c._longitude };
                if (Array.isArray(c)) return { lat: c[0], lng: c[1] };
            }
            
            // Direct lat/lng fields
            if (d.latitude !== undefined && d.longitude !== undefined) {
                return { lat: d.latitude, lng: d.longitude };
            }
            
            // lat/lon fields
            if (d.lat !== undefined && (d.lng !== undefined || d.lon !== undefined)) {
                return { lat: d.lat, lng: d.lng || d.lon };
            }
            
            return null;
        }
        
        // Get name from document
        function getName(doc, type) {
            const d = doc.data();
            return d.name || d.title || d.parishName || 'Unknown';
        }
        
        // Get detail from document
        function getDetail(doc, type) {
            const d = doc.data();
            
            switch (type) {
                case 'church': return d.address || d.city || '';
                case 'missionary': return d.role || d.organization || (d.locationPrimary?.city ? `${d.locationPrimary.city}, ${d.locationPrimary.state || ''}` : '') || '';
                case 'pilgrimage': return d.location || d.city || '';
                case 'school': return d.location?.formatted || d.city || '';
                case 'vocation': return d.location || d.order || '';
                case 'retreat': return d.location || d.city || '';
                case 'business': return d.subcategory || d.category || '';
                case 'campus': return d.location || d.university || '';
                default: return '';
            }
        }
        
        // Load data from Firebase
        async function loadData() {
            const loadingEl = document.getElementById('map-loading');
            let totalLoaded = 0;
            
            const loadPromises = Object.entries(COLLECTIONS).map(async ([type, collectionName]) => {
                try {
                    const snapshot = await getDocs(collection(db, collectionName));
                    let count = 0;
                    
                    snapshot.forEach(doc => {
                        const coords = getCoords(doc, type);
                        if (coords && coords.lat && coords.lng && 
                            Math.abs(coords.lat) <= 90 && Math.abs(coords.lng) <= 180) {
                            const name = getName(doc, type);
                            const detail = getDetail(doc, type);
                            // Store full document data for the detail panel
                            const docId = `${type}_${doc.id}`;
                            entityDataMap.set(docId, { ...doc.data(), _docId: doc.id, _type: type, _coords: coords });
                            const marker = createMarker(coords.lat, coords.lng, type, name, detail, docId);
                            marker.addTo(layers[type]);
                            count++;
                        }
                    });
                    
                    markerCounts[type] = count;
                    document.getElementById(`count-${type}`).textContent = count.toLocaleString();
                    totalLoaded += count;
                    
                } catch (error) {
                    console.warn(`Could not load ${collectionName}:`, error.message);
                }
            });
            
            await Promise.all(loadPromises);

            // Store all entities for "See an example" lookup
            window._allMapEntities = Array.from(entityDataMap.values());

            updateVisibleCount();

            // Hide loading
            loadingEl.classList.add('hidden');
            setTimeout(() => loadingEl.remove(), 500);
        }
        
        // Update visible count — only markers in current viewport
        window.updateVisibleCount = function() {
            const bounds = map.getBounds();
            let total = 0;
            document.querySelectorAll('.legend-filter input[type="checkbox"]').forEach(cb => {
                const type = cb.dataset.type;
                let typeCount = 0;
                if (layers[type]) {
                    layers[type].eachLayer(marker => {
                        if (marker.getLatLng && bounds.contains(marker.getLatLng())) {
                            typeCount++;
                        }
                    });
                }
                const countEl = document.getElementById(`count-${type}`);
                if (countEl) countEl.textContent = typeCount.toLocaleString();
                if (cb.checked) total += typeCount;
            });
            document.getElementById('total-visible').textContent = total.toLocaleString();
        };

        // Update count on map move/zoom
        map.on('moveend', updateVisibleCount);
        
        // Filter toggle handlers
        document.querySelectorAll('.legend-filter input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const type = this.dataset.type;
                if (this.checked) {
                    map.addLayer(layers[type]);
                } else {
                    map.removeLayer(layers[type]);
                }
                updateVisibleCount();
            });
        });
        
        // Legend toggle
        window.toggleLegend = function() {
            const legend = document.getElementById('map-legend');
            const toggle = document.getElementById('legend-toggle');
            const backdrop = document.getElementById('legend-backdrop');
            legend.classList.toggle('collapsed');
            const isCollapsed = legend.classList.contains('collapsed');
            toggle.classList.toggle('visible', isCollapsed);
            // Show/hide backdrop on mobile
            if (backdrop) backdrop.classList.toggle('visible', !isCollapsed);
        };

        // ── Auto-collapse legend on mobile ──
        if (window.innerWidth <= 768) {
            const legend = document.getElementById('map-legend');
            const toggle = document.getElementById('legend-toggle');
            legend.classList.add('collapsed');
            toggle.classList.add('visible');
        }

        // ── Prevent dot shrinking during pinch-zoom on mobile ──
        // Leaflet redraws circles during zoom which causes visual jitter on
        // touch pinch. Disable continuous circle redraws during touch-zoom,
        // only update after zoom ends.
        if ('ontouchstart' in window) {
            let isPinching = false;
            const savedRadii = new Map();

            map.on('zoomstart', () => {
                isPinching = true;
                // Freeze all circle marker radii
                Object.values(layers).forEach(layerGroup => {
                    layerGroup.eachLayer(marker => {
                        if (marker instanceof L.CircleMarker && marker.setRadius) {
                            savedRadii.set(marker, marker.getRadius());
                        }
                    });
                });
            });

            map.on('zoomend', () => {
                isPinching = false;
                // Restore all radii (forces clean redraw at final zoom)
                savedRadii.forEach((radius, marker) => {
                    try { marker.setRadius(radius); } catch(e) {}
                });
                savedRadii.clear();
            });

            // Override the internal _updatePath to freeze during pinch
            const origUpdateStyle = L.CircleMarker.prototype._updateStyle;
            L.CircleMarker.prototype._updateStyle = function() {
                if (isPinching) return;
                origUpdateStyle.call(this);
            };
        }

        // Swipe-down to dismiss legend on mobile
        (function() {
            const legend = document.getElementById('map-legend');
            let startY = 0;
            let currentY = 0;
            let swiping = false;

            legend.addEventListener('touchstart', (e) => {
                // Only enable swipe on the drag handle or at scroll top
                if (legend.scrollTop > 0) return;
                startY = e.touches[0].clientY;
                swiping = true;
            }, { passive: true });

            legend.addEventListener('touchmove', (e) => {
                if (!swiping) return;
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;
                if (diff > 0) {
                    legend.style.transform = `translateY(${diff}px)`;
                }
            }, { passive: true });

            legend.addEventListener('touchend', () => {
                if (!swiping) return;
                swiping = false;
                const diff = currentY - startY;
                legend.style.transform = '';
                if (diff > 80) {
                    toggleLegend();
                }
                currentY = 0;
                startY = 0;
            }, { passive: true });
        })();
        
        // ── User location marker (shared) — iOS-style pulsing dot ──
        let userLocationMarker = null;

        function addUserMarker(lat, lng) {
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
            }

            const pulsingIcon = L.divIcon({
                className: '',
                html: `
                    <div class="user-location-marker">
                        <div class="user-location-pulse"></div>
                        <div class="user-location-pulse2"></div>
                        <div class="user-location-pulse3"></div>
                        <div class="user-location-pulse4"></div>
                        <div class="user-location-dot"></div>
                    </div>
                `,
                iconSize: [21, 21],
                iconAnchor: [11, 11]
            });

            userLocationMarker = L.marker([lat, lng], { icon: pulsingIcon, zIndexOffset: 9999 }).addTo(map);
            userLocationMarker.bindPopup('<div class="popup-content"><div class="popup-name">You are here</div></div>');
        }

        // ── Location Prompt ──────────────────────────────────
        const promptOverlay = document.getElementById('location-prompt-overlay');
        const cityInput = document.getElementById('city-search-input');

        // Check if user already has a saved location
        const savedLocation = localStorage.getItem('nave_user_location');
        if (savedLocation) {
            try {
                const { lat, lng, zoom } = JSON.parse(savedLocation);
                map.setView([lat, lng], zoom || 11);
                addUserMarker(lat, lng);
                // Skip the prompt
                promptOverlay.style.display = 'none';
            } catch (e) {
                // Ignore bad stored data
            }
        }

        // Enter key on city input
        cityInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') searchCity();
        });

        window.dismissPrompt = function() {
            promptOverlay.classList.add('hidden');
            setTimeout(() => promptOverlay.style.display = 'none', 400);
        };

        window.useMyLocation = function() {
            if (!('geolocation' in navigator)) {
                alert('Geolocation is not supported by your browser.');
                return;
            }

            const btn = document.getElementById('use-my-location-btn');
            btn.classList.add('loading');
            btn.innerHTML = `
                <div class="map-loading-spinner" style="width:20px;height:20px;border-width:2px;margin:0;"></div>
                Locating...
            `;

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;
                    map.setView([latitude, longitude], 11);
                    addUserMarker(latitude, longitude);
                    localStorage.setItem('nave_user_location', JSON.stringify({ lat: latitude, lng: longitude, zoom: 11 }));
                    dismissPrompt();
                },
                (err) => {
                    console.warn('Geolocation error:', err);
                    btn.classList.remove('loading');
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                        </svg>
                        Use My Location
                    `;
                    alert('Could not determine your location. Try entering a city instead.');
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        };

        window.searchCity = async function() {
            const query = cityInput.value.trim();
            if (!query) return;

            // Use Nominatim (free geocoding) to find the city
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=us&limit=1`, {
                    headers: { 'Accept-Language': 'en' }
                });
                const results = await res.json();

                if (results.length > 0) {
                    const lat = parseFloat(results[0].lat);
                    const lon = parseFloat(results[0].lon);
                    map.setView([lat, lon], 11);
                    addUserMarker(lat, lon);
                    localStorage.setItem('nave_user_location', JSON.stringify({ lat, lng: lon, zoom: 11 }));
                    dismissPrompt();
                } else {
                    cityInput.style.borderColor = '#EF4444';
                    cityInput.placeholder = 'City not found — try again';
                    cityInput.value = '';
                    setTimeout(() => {
                        cityInput.style.borderColor = '#2a2a2a';
                        cityInput.placeholder = 'Enter city or zip code';
                    }, 2000);
                }
            } catch (err) {
                console.error('Geocoding error:', err);
                alert('Could not search for that location. Please try again.');
            }
        };

        // Locate me button (existing — reuse shared function)
        window.locateMe = function() {
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const { latitude, longitude } = pos.coords;
                        map.setView([latitude, longitude], 11);
                        addUserMarker(latitude, longitude);
                        localStorage.setItem('nave_user_location', JSON.stringify({ lat: latitude, lng: longitude, zoom: 11 }));
                    },
                    (err) => {
                        console.warn('Geolocation error:', err);
                        alert('Could not determine your location. Please enable location services in your browser settings.');
                    },
                    { enableHighAccuracy: false, timeout: 15000, maximumAge: 300000 }
                );
            } else {
                alert('Location services are not available in this browser.');
            }
        };
        
        // ══════════════════════════════════════════════════════
        // ENTITY DETAIL PANEL — iOS Prime Detail Views parity
        // ══════════════════════════════════════════════════════

        const detailOverlay = document.getElementById('entity-detail-overlay');
        const detailContent = document.getElementById('entity-detail-content');
        const detailPanel = document.getElementById('entity-detail-panel');
        let detailEditMode = false;
        let detailCurrentData = null;

        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        function getEntityIcon(type) {
            const icons = { church:'⛪', missionary:'✝️', pilgrimage:'🗺️', retreat:'🙏', school:'🎓', vocation:'📿', business:'🏪', campus:'🎒' };
            return icons[type] || '📍';
        }

        function getTypeLabel(type) {
            const labels = { church:'Church', missionary:'Missionary', pilgrimage:'Pilgrimage', retreat:'Retreat', school:'School', vocation:'Vocation', business:'Business', campus:'Campus Ministry' };
            return labels[type] || type;
        }

        // Collection name for Firestore writes
        function getCollectionForType(type) {
            return COLLECTIONS[type] || '';
        }

        // ── Owner detection (matches iOS UserObjectAssociationService) ──
        function isOwner(d) {
            if (!currentUser) return false;
            return d.createdByUserId === currentUser.uid || d.ownerId === currentUser.uid || d.organizationCreatedByUserId === currentUser.uid;
        }

        // ── Save field to Firestore ──
        async function saveEntityField(d, field, value) {
            const col = getCollectionForType(d._type);
            if (!col || !d._docId) return;
            try {
                await updateDoc(doc(db, col, d._docId), { [field]: value, updatedAt: serverTimestamp() });
                d[field] = value;
                entityDataMap.set(`${d._type}_${d._docId}`, d);
            } catch (err) {
                console.error('Save error:', err);
                alert('Could not save. Please try again.');
            }
        }

        // ── Analytics tracking (matches iOS ListingAnalyticsService) ──
        async function trackDetailView(d) {
            if (!d._docId || !d._type) return;
            try {
                await addDoc(collection(db, 'listingAnalytics'), {
                    entityId: d._docId, entityType: d._type, event: 'view',
                    userId: currentUser?.uid || 'anonymous', timestamp: serverTimestamp()
                });
            } catch (e) { /* silent */ }
        }

        // ── Open detail panel ──────────────────────────────
        async function openMapEntityDetail(docId) {
            const data = entityDataMap.get(docId);
            if (!data) return;
            detailEditMode = false;
            detailCurrentData = data;
            detailOverlay.classList.add('active');
            await updateTopNavButtons();
            renderMapEntityDetail(data);
            trackDetailView(data);
            // Load subcollection data async
            await loadSubcollectionData(data);
        }

        // ── Load subcollection data per type ──
        async function loadSubcollectionData(d) {
            const type = d._type;
            const docId = d._docId;
            let needsRerender = false;
            try {
                if (type === 'church') {
                    // Parish gallery subcollection
                    const gallerySnap = await getDocs(collection(db, 'Churches', docId, 'gallery'));
                    if (gallerySnap.size > 0) {
                        d._gallery = gallerySnap.docs.map(g => g.data());
                        needsRerender = true;
                    }
                    // Groups & ministries
                    const groupsSnap = await getDocs(collection(db, 'Churches', docId, 'groups'));
                    if (groupsSnap.size > 0) { d._groups = groupsSnap.docs.map(g => ({ id: g.id, ...g.data() })); needsRerender = true; }
                    // Staff
                    const staffSnap = await getDocs(collection(db, 'Churches', docId, 'staff'));
                    if (staffSnap.size > 0) { d._staff = staffSnap.docs.map(s => ({ id: s.id, ...s.data() })); needsRerender = true; }
                }
                if (type === 'business') {
                    // Job openings
                    const jobsSnap = await getDocs(collection(db, 'businesses', docId, 'jobOpenings'));
                    if (jobsSnap.size > 0) { d._jobs = jobsSnap.docs.map(j => ({ id: j.id, ...j.data() })); needsRerender = true; }
                }
                if (type === 'retreat') {
                    // Other retreat offerings from same org
                    if (d.organizationId) {
                        const offerQ = query(collection(db, 'retreats'), where('organizationId', '==', d.organizationId), where('isActive', '!=', false));
                        const offerSnap = await getDocs(offerQ);
                        const others = offerSnap.docs.filter(o => o.id !== docId).map(o => ({ id: o.id, ...o.data() }));
                        if (others.length) { d._otherRetreats = others; needsRerender = true; }
                    }
                }
                if (type === 'pilgrimage') {
                    // 1. pilgrimageOfferings — other offerings for the same site
                    try {
                        const offeringSnap = await getDocs(query(collection(db, 'pilgrimageOfferings'), where('siteId', '==', docId)));
                        if (offeringSnap.size > 0) {
                            d._offerings = offeringSnap.docs.filter(o => o.id !== docId).map(o => ({ id: o.id, ...o.data() }));
                            needsRerender = true;
                        }
                    } catch (e) { /* pilgrimageOfferings may not exist */ }
                    // 2. Merge site data from pilgrimageSites
                    if (d.siteId) {
                        try {
                            const siteDoc = await getDoc(doc(db, 'pilgrimageSites', d.siteId));
                            if (siteDoc.exists()) {
                                const site = siteDoc.data();
                                d.siteName = d.siteName || site.name;
                                d.siteDescription = d.siteDescription || site.description;
                                d.siteHistoricalSignificance = d.siteHistoricalSignificance || site.historicalSignificance;
                                d.siteVisitingHours = d.siteVisitingHours || site.visitingHours;
                                d.siteAdmissionInfo = d.siteAdmissionInfo || site.admissionInfo;
                                d.siteImageURL = d.siteImageURL || site.imageURL;
                                d.siteCreatedByUserId = d.siteCreatedByUserId || site.createdByUserId;
                                needsRerender = true;
                            }
                        } catch (e) { /* silent */ }
                    }
                    // 3. pilgrimageListings — travel facilitation listings (matches iOS PilgrimageListingDataService)
                    try {
                        const listingSnap = await getDocs(query(collection(db, 'pilgrimageListings'), where('pilgrimageId', '==', docId)));
                        if (listingSnap.size > 0) {
                            const now = new Date();
                            d._listings = listingSnap.docs.map(l => ({ id: l.id, ...l.data() }))
                                .filter(l => {
                                    // Filter: future dates and spots > 0
                                    let listDate = null;
                                    if (l.date && l.date.toDate) listDate = l.date.toDate();
                                    else if (l.date && l.date.seconds) listDate = new Date(l.date.seconds * 1000);
                                    else if (typeof l.date === 'string') listDate = new Date(l.date);
                                    return (!listDate || listDate >= now) && (l.spots === undefined || l.spots > 0);
                                })
                                .sort((a, b) => {
                                    const da = a.date?.seconds || 0, db2 = b.date?.seconds || 0;
                                    return da - db2;
                                });
                            needsRerender = true;
                        }
                    } catch (e) { /* pilgrimageListings may not exist */ }
                    // 4. Legacy travelFacilitations subcollection
                    try {
                        const travSnap = await getDocs(collection(db, 'pilgrimageSites', docId, 'travelFacilitations'));
                        if (travSnap.size > 0) { d.travelFacilitations = travSnap.docs.map(t => t.data()); needsRerender = true; }
                    } catch (e) { /* silent */ }
                }
            } catch (err) {
                console.warn('Subcollection load error:', err);
            }
            if (needsRerender && detailOverlay.classList.contains('active') && detailCurrentData === d) {
                entityDataMap.set(`${d._type}_${d._docId}`, d);
                renderMapEntityDetail(d);
            }
        }

        window.closeEntityDetail = function() {
            detailOverlay.classList.remove('active');
            detailEditMode = false;
            detailCurrentData = null;
        };

        // Schedule tab switcher (Mass / Confession / Adoration)
        window.switchScheduleTab = function(schedId, tab) {
            // Deactivate all tabs and content
            const tabBar = document.getElementById(schedId + '-tabs');
            if (tabBar) tabBar.querySelectorAll('.entity-detail-schedule-tab').forEach(t => t.classList.remove('active'));
            ['mass', 'confession', 'adoration'].forEach(t => {
                const el = document.getElementById(schedId + '-' + t);
                if (el) el.classList.remove('active');
            });
            // Activate selected
            const content = document.getElementById(schedId + '-' + tab);
            if (content) content.classList.add('active');
            // Activate the clicked button
            if (tabBar) {
                tabBar.querySelectorAll('.entity-detail-schedule-tab').forEach(t => {
                    if (t.textContent.toLowerCase().replace(/\s/g,'') === tab) t.classList.add('active');
                });
            }
        };

        detailOverlay.addEventListener('click', (e) => { if (e.target === detailOverlay) closeEntityDetail(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && detailOverlay.classList.contains('active')) closeEntityDetail(); });

        // Swipe-to-dismiss
        let detailTouchY = 0;
        detailPanel.addEventListener('touchstart', (e) => { if (detailPanel.scrollTop <= 0) detailTouchY = e.touches[0].clientY; }, { passive: true });
        detailPanel.addEventListener('touchmove', (e) => { if (detailPanel.scrollTop <= 0 && e.touches[0].clientY - detailTouchY > 80) closeEntityDetail(); }, { passive: true });

        // ── Add section modal ──
        window.openAddSectionModal = function() {
            document.getElementById('add-section-modal').classList.add('active');
        };
        window.closeAddSectionModal = function() {
            document.getElementById('add-section-modal').classList.remove('active');
        };
        document.getElementById('add-section-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'add-section-modal') closeAddSectionModal();
        });

        // ── Pilgrimage reserve modal (matches iOS PilgrimageReserveView) ──
        window.openPilgrimageReserve = function(listingId) {
            const d = detailCurrentData;
            if (!d || !d._listings) return;
            const listing = d._listings.find(l => l.id === listingId);
            if (!listing) return;

            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            // Parse dates
            const startDate = listing.date?.toDate ? listing.date.toDate() : (listing.date?.seconds ? new Date(listing.date.seconds * 1000) : (typeof listing.date === 'string' ? new Date(listing.date) : null));
            const endDate = listing.endDate?.toDate ? listing.endDate.toDate() : (listing.endDate?.seconds ? new Date(listing.endDate.seconds * 1000) : (typeof listing.endDate === 'string' ? new Date(listing.endDate) : null));
            let dateText = '';
            if (startDate && !isNaN(startDate.getTime())) {
                const sd = startDate.getDate(), sm = months[startDate.getMonth()], sy = startDate.getFullYear();
                if (endDate && !isNaN(endDate.getTime())) {
                    const ed = endDate.getDate(), em = months[endDate.getMonth()];
                    dateText = `${sm} ${sd}–${em} ${ed}, ${sy}`;
                } else {
                    dateText = `${sm} ${sd}, ${sy}`;
                }
            }
            const price = listing.price ? `$${Math.round(listing.price)}` : 'TBD';
            const dest = listing.destination || d.name || d.title || '';
            const agency = listing.travelAgency || '';
            const includes = listing.includes || '';
            const itinerary = listing.itinerary || '';
            const spots = listing.spots || 0;
            const regUrl = listing.registrationURL || '';

            let html = '';
            // Info grid (dates, price, destination, spots)
            html += `<div class="pilgrimage-reserve-info-grid">`;
            html += `<div class="pilgrimage-reserve-info-card"><div class="label">Dates</div><div class="value">${escapeHTML(dateText || 'TBD')}</div></div>`;
            html += `<div class="pilgrimage-reserve-info-card"><div class="label">Price</div><div class="value">${escapeHTML(price)}</div></div>`;
            html += `<div class="pilgrimage-reserve-info-card"><div class="label">Destination</div><div class="value">${escapeHTML(dest)}</div></div>`;
            html += `<div class="pilgrimage-reserve-info-card"><div class="label">Spots</div><div class="value">${spots > 0 ? spots + ' available' : 'Sold out'}</div></div>`;
            html += `</div>`;

            // Travel agency
            if (agency) html += `<div style="margin-bottom:12px;"><div style="font-size:0.72rem;font-weight:600;color:#888;text-transform:uppercase;margin-bottom:4px;">Travel Agency</div><div style="font-size:0.92rem;color:#111;font-weight:500;">${escapeHTML(agency)}</div></div>`;
            // What's included
            if (includes) html += `<div style="margin-bottom:12px;"><div style="font-size:0.72rem;font-weight:600;color:#888;text-transform:uppercase;margin-bottom:4px;">What's Included</div><div style="font-size:0.88rem;color:#444;line-height:1.6;">${escapeHTML(includes)}</div></div>`;
            // Itinerary
            if (itinerary) html += `<div style="margin-bottom:12px;"><div style="font-size:0.72rem;font-weight:600;color:#888;text-transform:uppercase;margin-bottom:4px;">Itinerary</div><div style="font-size:0.88rem;color:#444;line-height:1.6;white-space:pre-line;">${escapeHTML(itinerary)}</div></div>`;

            // CTA button
            if (regUrl && spots > 0) {
                html += `<a href="${regUrl}" target="_blank" rel="noopener" class="pilgrimage-reserve-cta"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>Submit Free Application</a>`;
            } else if (spots > 0) {
                html += `<button class="pilgrimage-reserve-cta" onclick="messageEntityOwner(); closePilgrimageReserve();"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>Contact to Reserve</button>`;
            }

            document.getElementById('reserve-title').textContent = dest ? `Trip to ${dest}` : 'Trip Details';
            document.getElementById('reserve-content').innerHTML = html;
            document.getElementById('pilgrimage-reserve-overlay').classList.add('active');

            // Track analytics
            if (d._docId) {
                addDoc(collection(db, 'listingAnalytics'), { entityId: d._docId, entityType: 'pilgrimage', event: 'explore_listing', listingId, userId: currentUser?.uid || null, timestamp: serverTimestamp() }).catch(() => {});
            }
        };
        window.closePilgrimageReserve = function() {
            document.getElementById('pilgrimage-reserve-overlay').classList.remove('active');
        };
        document.getElementById('pilgrimage-reserve-overlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'pilgrimage-reserve-overlay') closePilgrimageReserve();
        });

        // ── SVG icon constants for nav buttons ──
        const NAV_ICONS = {
            pencil: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`,
            message: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
            heartOutline: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`,
            heartFilled: `<svg viewBox="0 0 24 24" fill="#EF4444" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`,
            bell: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>`,
            house: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            lock: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
            share: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>`
        };

        // ── Update top nav buttons per entity type (matches iOS detail view nav) ──
        let _detailIsFavorited = false;
        async function updateTopNavButtons() {
            const container = document.getElementById('entity-detail-topnav-right');
            if (!container || !detailCurrentData) return;
            const d = detailCurrentData;
            const type = d._type;
            const owner = isOwner(d);
            let html = '';

            // Always 3 buttons: [Message or Pencil] | [middle] | Share
            // Button 1: Pencil (owner) or Message (non-owner)
            if (owner) {
                html += `<button class="entity-detail-nav-btn${detailEditMode ? ' editing' : ''}" onclick="toggleDetailEditMode()" title="Edit">${NAV_ICONS.pencil}</button>`;
            } else {
                html += `<button class="entity-detail-nav-btn" onclick="messageEntityOwner()" title="Message">${NAV_ICONS.message}</button>`;
            }

            // Button 2: Bell (parish) or Heart (non-parish)
            if (type === 'church') {
                html += `<button class="entity-detail-nav-btn" onclick="notifyEntity()" title="Notify">${NAV_ICONS.bell}</button>`;
            } else {
                _detailIsFavorited = false;
                if (currentUser && d._docId) {
                    try {
                        const favSnap = await getDoc(doc(db, 'users', currentUser.uid, 'favorites', d._docId));
                        _detailIsFavorited = favSnap.exists();
                    } catch(e) {}
                }
                html += `<button class="entity-detail-nav-btn${_detailIsFavorited ? ' favorited' : ''}" id="detail-nav-heart-btn" onclick="toggleFavorite()" title="Save">${_detailIsFavorited ? NAV_ICONS.heartFilled : NAV_ICONS.heartOutline}</button>`;
            }

            // Button 3: Share (always)
            html += `<button class="entity-detail-nav-btn" onclick="shareEntity()" title="Share">${NAV_ICONS.share}</button>`;
            container.innerHTML = html;
        }

        // ── Toggle edit mode ──
        window.toggleDetailEditMode = function() {
            detailEditMode = !detailEditMode;
            updateTopNavButtons();
            if (detailCurrentData) renderMapEntityDetail(detailCurrentData);
        };

        // ── Delete entity ──
        window.deleteEntity = async function() {
            if (!detailCurrentData || !isOwner(detailCurrentData)) return;
            if (!confirm('Are you sure you want to delete this listing? This cannot be undone.')) return;
            const d = detailCurrentData;
            const type = d._type;
            const collectionName = Object.entries(COLLECTIONS).find(([t]) => t === type)?.[1];
            if (!collectionName || !d._docId) { alert('Could not determine listing to delete.'); return; }
            try {
                await deleteDoc(doc(db, collectionName, d._docId));
                alert('Listing deleted.');
                closeEntityDetail();
            } catch (err) {
                console.error('Delete error:', err);
                alert('Failed to delete. Please try again.');
            }
        };

        // ── Toggle favorite (Save / Heart) ──
        window.toggleFavorite = async function() {
            if (!currentUser) { alert('Please sign in to save keys.'); return; }
            const d = detailCurrentData;
            if (!d || !d._docId) return;
            const favRef = doc(db, 'users', currentUser.uid, 'favorites', d._docId);
            try {
                if (_detailIsFavorited) {
                    await deleteDoc(favRef);
                    _detailIsFavorited = false;
                } else {
                    await setDoc(favRef, { entityId: d._docId, entityType: d._type, entityName: d.name || d.title || '', savedAt: serverTimestamp() });
                    _detailIsFavorited = true;
                    // Track analytics
                    await addDoc(collection(db, 'listingAnalytics'), { entityId: d._docId, entityType: d._type, event: 'favorite', userId: currentUser.uid, timestamp: serverTimestamp() });
                }
                // Update heart button appearance
                const btn = document.getElementById('detail-nav-heart-btn');
                if (btn) {
                    btn.className = 'entity-detail-nav-btn' + (_detailIsFavorited ? ' favorited' : '');
                    btn.innerHTML = _detailIsFavorited ? NAV_ICONS.heartFilled : NAV_ICONS.heartOutline;
                }
                // Update quick action save button text
                const qaBtn = document.getElementById('detail-qa-save-btn');
                if (qaBtn) {
                    const span = qaBtn.querySelector('span');
                    if (span) span.textContent = _detailIsFavorited ? 'Saved' : 'Save';
                }
            } catch (err) {
                console.error('Favorite error:', err);
            }
        };

        // ── Toggle home parish (House button — parish only) ──
        window.toggleHomeParish = async function() {
            if (!currentUser) { alert('Please sign in to set your home parish.'); return; }
            const d = detailCurrentData;
            if (!d || d._type !== 'church') return;
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.exists() ? userSnap.data() : {};
                if (userData.homeParishId === d._docId) {
                    // Unset home parish
                    await updateDoc(userRef, { homeParishId: null, homeParishName: null });
                    alert('Removed as home parish.');
                } else {
                    // Set home parish
                    await setDoc(userRef, { homeParishId: d._docId, homeParishName: d.name || d.parishName || '' }, { merge: true });
                    alert(`${d.name || d.parishName || 'Parish'} set as your home parish!`);
                }
            } catch (err) {
                console.error('Home parish error:', err);
                alert('Could not update home parish. Please try again.');
            }
        };

        // ── Save inline edit ──
        window.saveInlineEdit = async function(field, inputId) {
            const el = document.getElementById(inputId);
            if (!el || !detailCurrentData) return;
            const value = el.value.trim();
            const btn = el.parentElement.querySelector('.entity-detail-save-btn');
            if (btn) { btn.textContent = 'Saving...'; btn.disabled = true; }
            await saveEntityField(detailCurrentData, field, value);
            if (detailCurrentData) renderMapEntityDetail(detailCurrentData);
        };

        // ── Message owner ──
        window.messageEntityOwner = async function() {
            if (!currentUser || !detailCurrentData) { alert('Please sign in to send messages.'); return; }
            const d = detailCurrentData;
            const ownerId = d.createdByUserId || d.ownerId;
            if (!ownerId) { alert('No owner found for this listing.'); return; }
            if (ownerId === currentUser.uid) { alert('This is your listing.'); return; }
            try {
                const threadQ = query(collection(db, 'messages_threads'),
                    where('participantIds', 'array-contains', currentUser.uid));
                const threadSnap = await getDocs(threadQ);
                let threadId = null;
                threadSnap.forEach(t => {
                    const td = t.data();
                    if (td.participantIds && td.participantIds.includes(ownerId) && td.entityId === d._docId) {
                        threadId = t.id;
                    }
                });
                if (!threadId) {
                    const newThread = await addDoc(collection(db, 'messages_threads'), {
                        participantIds: [currentUser.uid, ownerId],
                        participantNames: { [currentUser.uid]: currentUser.displayName || 'User', [ownerId]: d.name || d.title || 'Owner' },
                        entityId: d._docId, entityType: d._type, entityName: d.name || d.title || '',
                        lastMessage: '', lastMessageAt: serverTimestamp(), createdAt: serverTimestamp()
                    });
                    threadId = newThread.id;
                }
                window.open(`engage.html?thread=${threadId}`, '_blank');
            } catch (err) {
                console.error('Message error:', err);
                alert('Could not start conversation. Please try again.');
            }
        };

        // ── Schedule parser ────────────────────────────────
        function parseSchedule(scheduleData) {
            if (!scheduleData || typeof scheduleData !== 'object' || Array.isArray(scheduleData)) return {};
            const result = {};
            for (const [day, value] of Object.entries(scheduleData)) {
                if (Array.isArray(value)) {
                    const times = [];
                    for (const v of value) {
                        if (typeof v === 'string') times.push(v);
                        else if (typeof v === 'object' && v.time) {
                            let t = v.time;
                            if (v.language && v.language !== 'English') t += ` (${v.language})`;
                            times.push(t);
                        }
                    }
                    if (times.length > 0) result[day] = times;
                } else if (typeof value === 'string') {
                    result[day] = [value];
                }
            }
            return result;
        }

        function renderScheduleRows(schedule) {
            const dayOrder = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Monday-Friday'];
            let html = '';
            for (const day of dayOrder) {
                if (schedule[day] && schedule[day].length > 0) {
                    html += `<div class="entity-detail-schedule-row"><span class="day">${day}</span><span class="times">${schedule[day].map(t => escapeHTML(t)).join(', ')}</span></div>`;
                }
            }
            return html;
        }

        // ── Event parser ───────────────────────────────────
        function parseEvent(data) {
            const title = data.title || data.name || '';
            if (!title) return null;
            let eventDate = null;
            if (data.date && data.date.toDate) {
                eventDate = data.date.toDate();
            } else if (data.date && data.date.seconds) {
                eventDate = new Date(data.date.seconds * 1000);
            } else if (typeof data.date === 'string' && data.date.trim()) {
                // Handle "Month Day" strings (e.g. "March 22") by appending current year
                let dateStr = data.date.trim();
                let parsed = new Date(dateStr);
                if (isNaN(parsed.getTime())) {
                    // Try appending current year: "March 22" → "March 22, 2026"
                    parsed = new Date(dateStr + ', ' + new Date().getFullYear());
                }
                if (!isNaN(parsed.getTime())) {
                    eventDate = parsed;
                }
            }
            // If we still don't have a valid date, show the event anyway with raw date text
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            if (eventDate && !isNaN(eventDate.getTime())) {
                return { title, date: eventDate, time: data.time || null, location: data.location || null,
                    month: months[eventDate.getMonth()] || '', dayNum: eventDate.getDate() || '',
                    rawDate: data.date, description: data.description || null };
            }
            // Fallback: show event with raw date string
            return { title, date: new Date(9999, 0, 1), time: data.time || null, location: data.location || null,
                month: (typeof data.date === 'string' ? data.date.split(' ')[0].substring(0, 3) : ''), dayNum: (typeof data.date === 'string' ? data.date.split(' ')[1] || '' : ''),
                rawDate: data.date, description: data.description || null };
        }

        // ── Shared builders ────────────────────────────────
        function buildHeroImage(d) {
            const images = (d.images || d.imageNames || []).filter(img => img && typeof img === 'string' && img.trim());
            const singleImg = d.imageURL || d.siteImageURL || '';
            if (images.length > 1) {
                let html = `<div class="entity-detail-hero-carousel" id="detail-hero-carousel">`;
                images.forEach((img, i) => {
                    const url = img.startsWith('http') ? img : `https://firebasestorage.googleapis.com/v0/b/navefirebase.firebasestorage.app/o/${encodeURIComponent(img)}?alt=media`;
                    html += `<img src="${url}" alt="" class="${i === 0 ? 'active' : ''}" loading="lazy" onerror="this.remove()">`;
                });
                html += `<div class="entity-detail-hero-dots">`;
                images.forEach((_, i) => { html += `<span class="${i === 0 ? 'active' : ''}" onclick="heroCarouselTo(${i})"></span>`; });
                html += `</div></div>`;
                return html;
            }
            const url = (images.length === 1 ? images[0] : singleImg);
            if (!url || typeof url !== 'string' || !url.trim()) return '';
            const src = url.startsWith('http') ? url : `https://firebasestorage.googleapis.com/v0/b/navefirebase.firebasestorage.app/o/${encodeURIComponent(url)}?alt=media`;
            return `<img class="entity-detail-hero" src="${src}" alt="" loading="lazy" onerror="this.remove()">`;
        }

        window.heroCarouselTo = function(idx) {
            const carousel = document.getElementById('detail-hero-carousel');
            if (!carousel) return;
            carousel.querySelectorAll('img').forEach((img, i) => img.classList.toggle('active', i === idx));
            carousel.querySelectorAll('.entity-detail-hero-dots span').forEach((dot, i) => dot.classList.toggle('active', i === idx));
        };

        // Auto-advance carousel
        let heroInterval = null;
        function startHeroCarousel() {
            clearInterval(heroInterval);
            const carousel = document.getElementById('detail-hero-carousel');
            if (!carousel) return;
            const imgs = carousel.querySelectorAll('img');
            if (imgs.length <= 1) return;
            let cur = 0;
            heroInterval = setInterval(() => { cur = (cur + 1) % imgs.length; heroCarouselTo(cur); }, 4000);
        }

        function buildHeader(d, type) {
            const icon = getEntityIcon(type);
            const name = d.name || d.title || d.parishName || 'Unknown';
            let badgeHTML = '';
            const badge = d.diocese || d.category || d.type || d.schoolType || d.retreatType || d.organization || getTypeLabel(type);
            badgeHTML = `<span class="entity-detail-type-badge">${escapeHTML(badge)}</span>`;
            if (d.isVerified) badgeHTML += `<span class="entity-detail-type-badge" style="background:rgba(34,197,94,0.1);color:#16a34a;margin-left:4px;">✓ Verified</span>`;
            if (d.subcategory && type === 'business') badgeHTML += `<span class="entity-detail-type-badge" style="margin-left:4px;">${escapeHTML(d.subcategory)}</span>`;
            let memberHTML = '';
            if (d.memberCount) memberHTML = `<div class="entity-detail-member-count"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>${d.memberCount} members</div>`;
            return `<div class="entity-detail-header"><div class="entity-detail-icon">${icon}</div><div class="entity-detail-header-info"><div class="entity-detail-name">${escapeHTML(name)}</div>${badgeHTML}${memberHTML}</div></div>`;
        }

        function buildEditBar(d) {
            if (!isOwner(d) || !detailEditMode) return '';
            return `<div class="entity-detail-edit-bar"><button class="entity-detail-add-section-btn" onclick="openAddSectionModal()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Section</button><button class="entity-detail-delete-btn" onclick="deleteEntity()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>Delete</button></div>`;
        }

        function buildEditableField(d, field, label, currentVal, isTextarea) {
            if (!detailEditMode) return '';
            const id = `edit-${field}-${Date.now()}`;
            if (isTextarea) {
                return `<div class="entity-detail-editable editing"><label style="font-size:0.72rem;font-weight:600;color:#999;text-transform:uppercase;">${escapeHTML(label)}</label><textarea id="${id}" rows="3">${escapeHTML(currentVal || '')}</textarea><button class="entity-detail-save-btn" onclick="saveInlineEdit('${field}','${id}')">Save</button></div>`;
            }
            return `<div class="entity-detail-editable editing"><label style="font-size:0.72rem;font-weight:600;color:#999;text-transform:uppercase;">${escapeHTML(label)}</label><input type="text" id="${id}" value="${escapeHTML(currentVal || '')}"><button class="entity-detail-save-btn" onclick="saveInlineEdit('${field}','${id}')">Save</button></div>`;
        }

        function buildLocation(d) {
            const parts = [];
            if (d.address) parts.push(d.address);
            if (d.city && d.state) parts.push(`${d.city}, ${d.state}`);
            else if (d.city) parts.push(d.city);
            else if (d.state) parts.push(d.state);
            else if (d.location && typeof d.location === 'string') parts.push(d.location);
            if (!parts.length && d.locationPrimary) {
                if (d.locationPrimary.city) parts.push(d.locationPrimary.city + (d.locationPrimary.state ? ', ' + d.locationPrimary.state : ''));
            }
            const loc = parts.join(' · ');
            if (!loc) return '';
            return `<div class="entity-detail-location"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg><span>${escapeHTML(loc)}</span></div>`;
        }

        function buildDescription(d) {
            const desc = d.description || d.bio || '';
            if (!desc && !detailEditMode) return '';
            if (detailEditMode && isOwner(d)) return buildEditableField(d, 'description', 'Description', desc, true);
            const truncated = desc.length > 400 ? desc.substring(0, 397) + '...' : desc;
            return `<div class="entity-detail-description">${escapeHTML(truncated)}</div>`;
        }

        function buildMapsUrl(d) {
            if (d._coords) return `https://maps.google.com/maps?q=${d._coords.lat},${d._coords.lng}`;
            if (d.address && d.city) return `https://maps.google.com/maps?q=${encodeURIComponent(d.address + ', ' + d.city + ' ' + (d.state || ''))}`;
            return '';
        }

        // Type-specific action links (Donate, Register, Enroll, etc.) — below the 3 quick actions
        function buildTypeActions(d, type) {
            let html = '';
            if (type === 'missionary' && d.donationLink) html += `<a href="${d.donationLink}" target="_blank" rel="noopener" class="entity-detail-action-btn primary-action">Donate</a>`;
            if (type === 'missionary' && d.calendlyLink) html += `<a href="${d.calendlyLink}" target="_blank" rel="noopener" class="entity-detail-action-btn primary-action">Schedule</a>`;
            if (type === 'retreat') { const regUrl = d.registrationURL || ''; if (regUrl) html += `<a href="${regUrl}" target="_blank" rel="noopener" class="entity-detail-action-btn primary-action">Register</a>`; }
            if (type === 'vocation' && d.applicationLink) html += `<a href="${d.applicationLink}" target="_blank" rel="noopener" class="entity-detail-action-btn primary-action">Apply</a>`;
            if (type === 'school') { const enrollUrl = d.enrollmentURL || ''; if (enrollUrl) html += `<a href="${enrollUrl}" target="_blank" rel="noopener" class="entity-detail-action-btn primary-action">Enroll</a>`; }
            return html ? `<div class="entity-detail-actions">${html}</div>` : '';
        }

        // ── Share entity (Web Share API) ──
        window.shareEntity = function() {
            const d = detailCurrentData;
            if (!d) return;
            const name = d.name || d.title || 'Nave Key';
            const text = `Check out ${name} on Nave`;
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({ title: name, text, url }).catch(() => {});
            } else {
                navigator.clipboard.writeText(`${text} — ${url}`).then(() => alert('Link copied!')).catch(() => {});
            }
        };

        // ── Notify (placeholder) ──
        window.notifyEntity = function() {
            alert('Notifications coming soon! You\'ll be able to get updates from this key.');
        };

        // ── Follow Key toggle ──
        window.toggleFollowKey = async function() {
            if (!currentUser) { alert('Please sign in to follow keys.'); return; }
            const d = detailCurrentData;
            if (!d) return;
            const btn = document.getElementById('detail-follow-btn');
            const isFollowing = btn.classList.contains('following');
            try {
                if (isFollowing) {
                    // Unfollow — remove from user's associatedObjects
                    btn.classList.remove('following');
                    btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>Follow Key`;
                } else {
                    // Follow
                    btn.classList.add('following');
                    btn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>Following Key`;
                    // Track follow
                    await addDoc(collection(db, 'listingAnalytics'), {
                        entityId: d._docId, entityType: d._type, event: 'follow',
                        userId: currentUser.uid, timestamp: serverTimestamp()
                    });
                }
            } catch (err) { console.error('Follow error:', err); }
        };

        function buildContact(d) {
            const phone = d.phone || d.phoneNumber || d.contactInfo?.phone || '';
            const email = d.email || d.contactInfo?.email || '';
            const website = d.website || d.websiteURL || d.link || d.contactInfo?.website || '';
            if (!phone && !email && !website) return '';
            let html = '<div class="entity-detail-contact">';
            if (phone) html += `<div class="entity-detail-contact-row"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg><a href="tel:${phone}">${escapeHTML(phone)}</a></div>`;
            if (email) html += `<div class="entity-detail-contact-row"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg><a href="mailto:${email}">${escapeHTML(email)}</a></div>`;
            if (website) { const url = website.startsWith('http') ? website : 'https://' + website; const display = website.replace(/^https?:\/\/(www\.)?/, '').replace(/\/$/, ''); html += `<div class="entity-detail-contact-row"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2z"/></svg><a href="${url}" target="_blank" rel="noopener">${escapeHTML(display)}</a></div>`; }
            html += '</div>';
            return html;
        }

        function buildSocialMedia(socialObj) {
            if (!socialObj || typeof socialObj !== 'object') return '';
            const entries = Object.entries(socialObj).filter(([,v]) => v);
            if (!entries.length) return '';
            let html = `<div class="entity-detail-section-title">Social Media</div><div class="entity-detail-social">`;
            for (const [platform, url] of entries) {
                const link = String(url).startsWith('http') ? url : 'https://' + url;
                html += `<a href="${link}" target="_blank" rel="noopener">${escapeHTML(platform)}</a>`;
            }
            html += '</div>';
            return html;
        }

        function buildFooter(d) {
            return '';
        }

        function buildInfoItem(label, value) {
            if (!value) return '';
            return `<div class="entity-detail-info-item"><div class="entity-detail-info-label">${escapeHTML(label)}</div><div class="entity-detail-info-value">${escapeHTML(String(value))}</div></div>`;
        }

        function buildInfoFull(title, text) {
            if (!text) return '';
            return `<div class="entity-detail-info-full"><div class="info-title">${escapeHTML(title)}</div><div class="info-text">${escapeHTML(String(text))}</div></div>`;
        }

        function buildGallery(photos) {
            if (!photos || !photos.length) return '';
            let html = `<div class="entity-detail-section-title">Gallery</div><div class="entity-detail-gallery">`;
            photos.slice(0, 9).forEach(p => {
                const url = p.storageUrl || p.imageURL || p.url || '';
                if (url) html += `<img src="${url}" alt="${escapeHTML(p.imageType || '')}" loading="lazy" onerror="this.style.display='none'">`;
            });
            html += '</div>';
            return html;
        }

        function buildStaffList(staff) {
            if (!staff || !staff.length) return '';
            let html = `<div class="entity-detail-section-title">Staff & Leadership</div>`;
            staff.forEach(s => {
                const name = s.name || s.staffName || '';
                const role = s.role || s.title || s.position || '';
                const initials = name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                html += `<div class="entity-detail-staff-item"><div class="entity-detail-staff-avatar">${initials}</div><div><div class="entity-detail-staff-name">${escapeHTML(name)}</div>${role ? `<div class="entity-detail-staff-role">${escapeHTML(role)}</div>` : ''}</div></div>`;
            });
            return html;
        }

        // ── Add section definitions per type (matches iOS AddSectionsSheets) ──
        const ADD_SECTIONS = {
            church: [
                { id: 'events', title: 'Events', desc: 'Add parish events', fields: ['title','description','date','time','location'] },
                { id: 'groups', title: 'Groups & Ministries', desc: 'Add groups or ministries', fields: ['name','description','meetingTime'] },
                { id: 'staff', title: 'Staff & Leadership', desc: 'Add staff members', fields: ['name','role'] },
                { id: 'social', title: 'Social Media', desc: 'Add social media links', fields: ['platform','url'] },
                { id: 'psas', title: 'Pastor PSAs', desc: 'Post announcements', fields: ['title','message','pastorName'] },
                { id: 'gallery', title: 'Gallery Photos', desc: 'Add photos of your parish', fields: ['imageType','url'] }
            ],
            business: [
                { id: 'hours', title: 'Hours', desc: 'Set business hours', fields: ['day','openTime','closeTime'] },
                { id: 'events', title: 'Events', desc: 'Add business events', fields: ['eventName','eventDate','eventTime','eventDescription','eventSignUpLink'] },
                { id: 'marketing', title: 'Marketing', desc: 'Newsletter, reviews, awards', fields: ['marketingNewsletter','customerReviewsSummary','awardsRecognition'] },
                { id: 'philanthropy', title: 'Philanthropy', desc: 'Community involvement', fields: ['communityPartnerships','communityInvolvement'] },
                { id: 'jobs', title: 'Job Openings', desc: 'Post job listings', fields: ['title','type','salary','description'] }
            ],
            school: [
                { id: 'classical', title: 'Classical Education', desc: 'Trivium, Latin, Great Books', fields: ['triviumQuadrivium','latinGreekStudies','greatBooks','socraticMethod'] },
                { id: 'academics', title: 'Academics', desc: 'Enrollment, tuition, financial aid', fields: ['gradeLevels','enrollment','classSize','tuition','financialAid','admissionsProcess','enrollmentURL'] },
                { id: 'formation', title: 'Catholic Formation', desc: 'Mass, confession, sacraments', fields: ['religiousEducation','sacramentalPreparation','dailyMass','confessionSchedule','adoration','virtueFormation'] }
            ],
            missionary: [
                { id: 'contact', title: 'Contact', desc: 'Email, phone, scheduling', fields: ['email','phone','calendlyLink'] },
                { id: 'impact', title: 'Impact Stats', desc: 'Students, campuses, years', fields: ['impactStats.studentsReached','impactStats.campusesCovered','impactStats.yearsOfService'] },
                { id: 'links', title: 'Links', desc: 'Website and donation', fields: ['website','donationLink'] }
            ],
            retreat: [
                { id: 'details', title: 'Retreat Details', desc: 'Topics, speakers, schedule', fields: ['retreatTopics','speakerInfo','scheduleStructure','capacity','pricing'] },
                { id: 'spiritual', title: 'Spiritual Life', desc: 'Mass, confession, adoration', fields: ['massSchedule','confessionAvailability','adorationOpportunities','spiritualDirection'] },
                { id: 'org', title: 'Organization Info', desc: 'Director, contact, frequency', fields: ['directorName','email','phone','retreatFrequency','accommodationInfo'] },
                { id: 'marketing', title: 'Marketing', desc: 'Social media, newsletter', fields: ['socialMedia','newsletter','testimonials'] }
            ],
            vocation: [
                { id: 'contact', title: 'Contact Info', desc: 'Email, phone, website', fields: ['email','phone','website','applicationLink'] },
                { id: 'location', title: 'Location Details', desc: 'Full address', fields: ['address','city','state','zipCode'] },
                { id: 'formation', title: 'Formation Info', desc: 'Process, requirements, discernment', fields: ['formationProcess','requirements','discernmentOpportunities'] },
                { id: 'director', title: 'Director Info', desc: 'Director and community name', fields: ['directorName','communityName'] }
            ],
            pilgrimage: [
                { id: 'description', title: 'Description', desc: 'Site description and history', fields: ['description','siteHistoricalSignificance'] }
            ],
            campus: [
                { id: 'details', title: 'Ministry Details', desc: 'Meeting times and chaplain', fields: ['meetingTimes','chaplainName','chaplainEmail'] },
                { id: 'contact', title: 'Contact', desc: 'Email, phone, website', fields: ['email','phone','website'] }
            ]
        };

        window.populateAddSectionModal = function(type) {
            const sections = ADD_SECTIONS[type] || [];
            const list = document.getElementById('add-section-list');
            list.innerHTML = '';
            sections.forEach(sec => {
                const item = document.createElement('div');
                item.className = 'entity-detail-add-modal-item';
                item.innerHTML = `<h4>${sec.title}</h4><p>${sec.desc}</p>`;
                item.onclick = () => { closeAddSectionModal(); openSectionEditor(sec); };
                list.appendChild(item);
            });
        };

        function openSectionEditor(sec) {
            // For now, create a simple prompt-based editor for each field
            const d = detailCurrentData;
            if (!d) return;
            const col = getCollectionForType(d._type);
            if (!col) return;

            // For subcollection sections (events, groups, staff, jobs), add a new doc
            const subcolSections = ['events','groups','staff','jobs','psas','gallery'];
            if (subcolSections.includes(sec.id)) {
                const values = {};
                for (const field of sec.fields) {
                    const val = prompt(`Enter ${field}:`);
                    if (val === null) return;
                    values[field] = val;
                }
                values.createdAt = serverTimestamp();
                const subCol = sec.id === 'psas' ? 'pastorPSAs' : sec.id === 'jobs' ? 'jobOpenings' : sec.id;
                addDoc(collection(db, col, d._docId, subCol), values).then(() => {
                    alert('Added! Refreshing...');
                    loadSubcollectionData(d);
                }).catch(err => alert('Error: ' + err.message));
                return;
            }

            // For document-level fields, update the entity doc
            const updates = {};
            for (const field of sec.fields) {
                const current = field.includes('.') ? (d[field.split('.')[0]]?.[field.split('.')[1]] || '') : (d[field] || '');
                const val = prompt(`${field}:`, current);
                if (val === null) return;
                if (field.includes('.')) {
                    const [parent, child] = field.split('.');
                    if (!updates[parent]) updates[parent] = d[parent] || {};
                    updates[parent][child] = val;
                } else {
                    updates[field] = val;
                }
            }
            updates.updatedAt = serverTimestamp();
            updateDoc(doc(db, col, d._docId), updates).then(() => {
                Object.assign(d, updates);
                entityDataMap.set(`${d._type}_${d._docId}`, d);
                renderMapEntityDetail(d);
            }).catch(err => alert('Error: ' + err.message));
        }

        // ── Vocation process steps (matches iOS getVocationProcessSteps) ──
        function getVocationProcessSteps(type) {
            const steps = {
                'Priesthood': [
                    { title: 'Discernment', desc: 'Meet with a vocation director and begin prayer and reflection.' },
                    { title: 'Seminary Application', desc: 'Apply to a seminary recommended by your diocese.' },
                    { title: 'Propaedeutic Stage', desc: 'Initial formation period focused on human and spiritual growth.' },
                    { title: 'Philosophy Studies', desc: '2 years studying philosophy and liberal arts.' },
                    { title: 'Theology Studies', desc: '4 years of theological formation.' },
                    { title: 'Ordination', desc: 'Ordination to the diaconate, then priesthood.' }
                ],
                'Religious Life': [
                    { title: 'Inquiry', desc: 'Visit communities and attend come-and-see events.' },
                    { title: 'Postulancy', desc: 'Live with the community for an initial trial period.' },
                    { title: 'Novitiate', desc: '1-2 years of intensive formation and study of the rule.' },
                    { title: 'Temporary Vows', desc: 'Profess vows for a set period (typically 3-6 years).' },
                    { title: 'Perpetual Vows', desc: 'Make a lifelong commitment to the community.' }
                ],
                'Permanent Deacon': [
                    { title: 'Inquiry', desc: 'Meet with the diaconate formation director.' },
                    { title: 'Aspirancy', desc: '1 year of discernment with your spouse (if married).' },
                    { title: 'Candidacy', desc: '3-4 years of academic and pastoral formation.' },
                    { title: 'Ordination', desc: 'Ordained to the permanent diaconate.' }
                ]
            };
            return steps[type] || steps['Priesthood'];
        }

        // ══════════════════════════════════════════════════════
        // SHOW EXAMPLE UNLOCKED PARISH
        // ══════════════════════════════════════════════════════

        window.showExampleUnlockedParish = function() {
            // Find an unlocked parish from the already-loaded markers to show as demo
            const churches = window._allMapEntities || [];
            const unlocked = churches.find(e => e._type === 'church' && e.isUnlocked === true);
            if (unlocked) {
                renderMapEntityDetail(unlocked);
            } else {
                // Fallback: find any premium church
                const premium = churches.find(e => e._type === 'church' && e.isPremium === true);
                if (premium) {
                    renderMapEntityDetail(premium);
                }
            }
        };

        // ══════════════════════════════════════════════════════
        // MASTER RENDER FUNCTION
        // ══════════════════════════════════════════════════════

        function renderMapEntityDetail(d) {
            const type = d._type;

            // Hero image at top
            let html = buildHeroImage(d);

            // Owner edit bar
            html += buildEditBar(d);

            // ── Rainbow hero card (name inside card for all types) ──
            const cardClass = 'entity-detail-card rainbow';
            let cardHTML = '';

            // Name at top of rainbow card
            const name = d.name || d.parishName || d.title || 'Unknown';
            cardHTML += `<div style="font-size:1.35rem;font-weight:700;color:#111;margin-bottom:6px;">${escapeHTML(name)}</div>`;

            // Address line (street only for churches, full for others)
            if (type === 'church') {
                const addr = d.address || '';
                const street = addr.includes(',') ? addr.split(',')[0].trim() : addr;
                if (street) cardHTML += `<div style="font-size:0.92rem;color:#888;margin-bottom:8px;">${escapeHTML(street)}</div>`;
            } else {
                cardHTML += buildLocation(d);
            }

            // Rating row (business)
            if (d.rating) {
                let ratingHTML = `<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;"><span style="color:#EAB308;font-size:0.92rem;">★</span><span style="font-size:0.92rem;font-weight:600;color:#111;">${d.rating}</span>`;
                if (d.reviewCount) ratingHTML += `<span style="font-size:0.78rem;color:#888;">(${d.reviewCount} reviews)</span>`;
                ratingHTML += `</div>`;
                cardHTML += ratingHTML;
            }

            // Category + subcategory (business)
            if (d.category || d.subcategory) {
                const parts = [d.category, d.subcategory].filter(Boolean);
                cardHTML += `<div style="font-size:0.88rem;color:#888;margin-bottom:6px;">${escapeHTML(parts.join(' · '))}</div>`;
            }

            // Founding year
            if (d.foundingYear) cardHTML += `<div style="display:flex;align-items:center;gap:6px;font-size:0.82rem;color:#777;margin-bottom:6px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Since ${escapeHTML(String(d.foundingYear))}</div>`;

            // Feature pills (business — top 3)
            if (Array.isArray(d.features) && d.features.length > 0) {
                cardHTML += `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;">`;
                d.features.slice(0, 3).forEach(f => {
                    const text = typeof f === 'object' ? (f.name || f.title || '') : f;
                    if (text) cardHTML += `<span style="font-size:0.72rem;padding:4px 10px;border-radius:20px;background:rgba(139,92,45,0.1);color:#8B5C2D;">${escapeHTML(text)}</span>`;
                });
                cardHTML += `</div>`;
            }

            // Description (inside rainbow card for all types that have one)
            const desc = d.description || d.bio || '';
            if (desc) {
                if (detailEditMode && isOwner(d)) {
                    cardHTML += buildEditableField(d, 'description', 'Description', desc, true);
                } else {
                    const truncated = desc.length > 300 ? desc.substring(0, 297) + '...' : desc;
                    cardHTML += `<div style="border-top:1px solid #eee;margin:8px 0;"></div>`;
                    cardHTML += `<div class="entity-detail-description">${escapeHTML(truncated)}</div>`;
                }
            }

            // Website (bottom-left) + Gallery icon (bottom-right) — matches iOS
            const website = d.website || d.websiteURL || d.link || d.contactInfo?.website || '';
            cardHTML += `<div class="entity-detail-website-row">`;
            if (website) {
                const url = website.startsWith('http') ? website : 'https://' + website;
                cardHTML += `<a href="${url}" target="_blank" rel="noopener" class="entity-detail-website-link"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2z"/></svg>Visit Website</a>`;
            } else {
                cardHTML += `<span class="entity-detail-website-link disabled"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2z"/></svg>Visit Website</span>`;
            }
            cardHTML += `<div class="entity-detail-gallery-icon" title="Photo Gallery"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="5" width="16" height="14" rx="2"/><rect x="6" y="3" width="16" height="14" rx="2" fill="white"/><circle cx="14" cy="9" r="2"/><path d="M6 17l3-3a2 2 0 0 1 2.8 0L17 19"/></svg></div>`;
            cardHTML += `</div>`;

            html += `<div class="${cardClass}">${cardHTML}</div>`;

            // ── LOCKED CHURCH: show upsell instead of full content (matches iOS PrimeParishDetailView) ──
            const isLockedChurch = type === 'church' && d.isUnlocked !== true;
            if (isLockedChurch) {
                html += renderLockedChurch(d);
                // Locked view: only contact + footer, no follow/actions/sections
                html += buildFooter(d);
                detailContent.innerHTML = html;
                startHeroCarousel();
                return;
            }

            // ── Follow Key button ──
            html += `<button class="entity-detail-follow-btn" id="detail-follow-btn" onclick="toggleFollowKey()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>Follow Key</button>`;

            // ── 3 Quick Action Buttons (type-specific, matches iOS) ──
            // Parish: Share / Notify / Map
            // Business, Retreat, Pilgrimage, Campus: Save / Message / Map
            // School, Vocation: Save / Message / Apply
            // Missionary: Save / Message / Donate
            const mapsUrl = buildMapsUrl(d);
            const QA_SHARE = `<button class="entity-detail-quick-action" onclick="shareEntity()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg><span>Share</span></button>`;
            const QA_NOTIFY = `<button class="entity-detail-quick-action" onclick="notifyEntity()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><span>Notify</span></button>`;
            const QA_MAP = mapsUrl ? `<a href="${mapsUrl}" target="_blank" rel="noopener" class="entity-detail-quick-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg><span>Map</span></a>` : `<button class="entity-detail-quick-action" disabled><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg><span>Map</span></button>`;
            const QA_SAVE = `<button class="entity-detail-quick-action" id="detail-qa-save-btn" onclick="toggleFavorite()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg><span>${_detailIsFavorited ? 'Saved' : 'Save'}</span></button>`;
            const QA_MESSAGE = `<button class="entity-detail-quick-action" onclick="messageEntityOwner()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span>Message</span></button>`;
            const applyUrl = d.applicationLink || d.enrollmentURL || '';
            const QA_APPLY = applyUrl ? `<a href="${applyUrl}" target="_blank" rel="noopener" class="entity-detail-quick-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg><span>Apply</span></a>` : `<button class="entity-detail-quick-action" disabled><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span>Apply</span></button>`;
            const donateUrl = d.donationLink || '';
            const QA_DONATE = donateUrl ? `<a href="${donateUrl}" target="_blank" rel="noopener" class="entity-detail-quick-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><span>Donate</span></a>` : `<button class="entity-detail-quick-action" disabled><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><span>Donate</span></button>`;

            html += `<div class="entity-detail-quick-actions">`;
            if (type === 'church') {
                html += QA_SHARE + QA_NOTIFY + QA_MAP;
            } else if (type === 'school' || type === 'vocation') {
                html += QA_SAVE + QA_MESSAGE + QA_APPLY;
            } else if (type === 'missionary') {
                html += QA_SAVE + QA_MESSAGE + QA_DONATE;
            } else {
                // business, retreat, pilgrimage, campus
                html += QA_SAVE + QA_MESSAGE + QA_MAP;
            }
            html += `</div>`;

            // ── Type-specific sections ──
            switch (type) {
                case 'church': html += renderChurch(d); break;
                case 'business': html += renderBusiness(d); break;
                case 'school': html += renderSchool(d); break;
                case 'missionary': html += renderMissionary(d); break;
                case 'retreat': html += renderRetreat(d); break;
                case 'pilgrimage': html += renderPilgrimage(d); break;
                case 'vocation': html += renderVocation(d); break;
                case 'campus': html += renderCampus(d); break;
            }

            // Contact + footer
            html += `<div class="entity-detail-section-title">Contact</div>`;
            html += buildContact(d);
            html += buildFooter(d);

            detailContent.innerHTML = html;

            // Start carousel if present
            startHeroCarousel();

            // Populate add-section modal for this type
            if (isOwner(d)) populateAddSectionModal(type);
        }

        // ══════════════════════════════════════════════════════
        // CHURCH — PrimeParishUnlockedView
        // ══════════════════════════════════════════════════════

        function renderChurch(d) {
            let html = '';
            const entityId = d._docId || d.id || '';

            // ── 1. UPCOMING EVENTS (shown above schedules for prominence, matches iOS) ──
            if (Array.isArray(d.events) && d.events.length > 0) {
                const upcoming = d.events.map(e => parseEvent(e)).filter(e => e !== null).sort((a, b) => a.date - b.date).slice(0, 5);
                if (upcoming.length) {
                    html += `<div class="entity-detail-events-heading">Upcoming Events</div><div class="entity-detail-events"><div class="entity-detail-events-inner">`;
                    for (const evt of upcoming) {
                        const dateStr = evt.rawDate || (evt.month + ' ' + evt.dayNum);
                        html += `<div class="entity-detail-event-item">`;
                        html += `<div class="entity-detail-event-title">${escapeHTML(evt.title)}</div>`;
                        html += `<div class="entity-detail-event-meta"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>${escapeHTML(dateStr)}</div>`;
                        if (evt.time) html += `<div class="entity-detail-event-meta"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>${escapeHTML(evt.time)}</div>`;
                        html += `</div>`;
                    }
                    html += '</div></div>';
                }
            }

            // ── 2. SCHEDULE — Navy blue segmented control (Mass / Confession / Adoration) ──
            const hasMass = d.massSchedule && typeof d.massSchedule === 'object' && Object.keys(parseSchedule(d.massSchedule)).length > 0;
            const hasConfession = d.confessionSchedule && typeof d.confessionSchedule === 'object' && Object.keys(parseSchedule(d.confessionSchedule)).length > 0;
            const hasAdoration = d.adorationSchedule && typeof d.adorationSchedule === 'object' && Object.keys(parseSchedule(d.adorationSchedule)).length > 0;

            if (hasMass || hasConfession || hasAdoration) {
                const schedId = 'sched-' + entityId;
                html += `<div class="entity-detail-schedule-tabs" id="${schedId}-tabs">`;
                if (hasMass) html += `<button class="entity-detail-schedule-tab active" onclick="switchScheduleTab('${schedId}','mass')">Mass</button>`;
                if (hasConfession) html += `<button class="entity-detail-schedule-tab${!hasMass ? ' active' : ''}" onclick="switchScheduleTab('${schedId}','confession')">Confession</button>`;
                if (hasAdoration) html += `<button class="entity-detail-schedule-tab${!hasMass && !hasConfession ? ' active' : ''}" onclick="switchScheduleTab('${schedId}','adoration')">Adoration</button>`;
                html += `</div>`;

                if (hasMass) html += `<div class="entity-detail-schedule-tab-content active" id="${schedId}-mass"><div class="entity-detail-schedule">${renderScheduleRows(parseSchedule(d.massSchedule))}</div></div>`;
                if (hasConfession) html += `<div class="entity-detail-schedule-tab-content${!hasMass ? ' active' : ''}" id="${schedId}-confession"><div class="entity-detail-schedule">${renderScheduleRows(parseSchedule(d.confessionSchedule))}</div></div>`;
                if (hasAdoration) html += `<div class="entity-detail-schedule-tab-content${!hasMass && !hasConfession ? ' active' : ''}" id="${schedId}-adoration"><div class="entity-detail-schedule">${renderScheduleRows(parseSchedule(d.adorationSchedule))}</div></div>`;
            }

            // ── 3. PASTOR ANNOUNCEMENTS ──
            if (Array.isArray(d.pastorPSAs) && d.pastorPSAs.length > 0) {
                html += `<div class="entity-detail-section-title">Pastor Announcements</div>`;
                d.pastorPSAs.forEach(psa => {
                    html += `<div class="entity-detail-psa"><div class="entity-detail-psa-title">${escapeHTML(psa.title || '')}</div><div class="entity-detail-psa-text">${escapeHTML(psa.message || '')}</div>`;
                    if (psa.pastorName) html += `<div class="entity-detail-psa-meta">— ${escapeHTML(psa.pastorName)}</div>`;
                    html += `</div>`;
                });
            }

            // ── 4. GET INVOLVED — 2×2 grid (OCIA, Confirmation, First Eucharist, Marriage Prep) — always visible ──
            const getInvolvedPrograms = [
                { icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`, title: 'OCIA', sub: 'Start your journey' },
                { icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 0.67s0.74 2.65 0.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l0.03-0.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5 0.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-0.36 3.6-1.21 4.62-2.58 0.39 1.29 0.59 2.65 0.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/></svg>`, title: 'Confirmation', sub: 'Youth & adult' },
                { icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61z"/></svg>`, title: 'First Eucharist', sub: 'Sacrament prep' },
                { icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`, title: 'Marriage Prep', sub: 'Pre-Cana' }
            ];
            html += `<div class="entity-detail-section-title">Get Involved</div>`;
            html += `<div class="entity-detail-get-involved">`;
            getInvolvedPrograms.forEach(p => {
                const url = d.prepClassSignupURL || d.signupURL || '#';
                html += `<a href="${url !== '#' ? escapeHTML(url) : '#'}" ${url !== '#' ? 'target="_blank" rel="noopener"' : ''} class="entity-detail-program-card">${p.icon}<span class="program-title">${p.title}</span><span class="program-sub">${p.sub}</span></a>`;
            });
            html += `</div>`;

            // ── 5. SIGN-UP SHEETS BUTTON ──
            const signupURL = d.signupURL || d.prepClassSignupURL || '';
            html += `<button class="entity-detail-signup-btn" onclick="${signupURL ? `window.open('${escapeHTML(signupURL)}','_blank')` : 'void(0)'}">
                <div class="entity-detail-signup-icon"><svg viewBox="0 0 24 24" fill="currentColor" color="#3366CC"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></div>
                <div class="entity-detail-signup-text"><div class="title">Sign-Up Sheets</div><div class="sub">Groups, Liturgy, Service & More</div></div>
                <div class="entity-detail-signup-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></div>
            </button>`;

            // ── 6. STAFF & LEADERSHIP (from subcollection) ──
            if (d._staff && d._staff.length > 0) html += buildStaffList(d._staff);

            // ── 7. GROUPS & MINISTRIES (from subcollection) ──
            if (d._groups && d._groups.length > 0) {
                html += `<div class="entity-detail-section-title">Groups & Ministries</div>`;
                d._groups.forEach(g => {
                    html += buildInfoFull(g.name || 'Ministry', g.description || g.meetingTime || '');
                });
            }

            // ── 8. LOCATION MAP ──
            if (d.latitude && d.longitude) {
                const lat = d.latitude;
                const lng = d.longitude;
                const addr = encodeURIComponent(d.address || d.name || '');
                html += `<div class="entity-detail-map-section">
                    <div class="section-label">Location</div>
                    <div class="entity-detail-map-embed">
                        <iframe src="https://www.openstreetmap.org/export/embed.html?bbox=${lng-0.005}%2C${lat-0.003}%2C${lng+0.005}%2C${lat+0.003}&layer=mapnik&marker=${lat}%2C${lng}" loading="lazy"></iframe>
                    </div>
                </div>`;
            }

            // ── 9. BULLETIN UPLOAD ──
            html += `<div class="entity-detail-bulletin" onclick="window.location.href='join.html'">
                <svg viewBox="0 0 24 24" fill="none" stroke="#3366CC" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                <div class="bulletin-title">Upload Bulletin</div>
                <div class="bulletin-sub">Scan your weekly bulletin to update events and schedules</div>
            </div>`;

            // ── 10. MESSAGE PARISH ──
            html += `<button class="entity-detail-message-btn" onclick="messageEntityOwner()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                Message Parish
            </button>`;

            // ── 11. GALLERY (from subcollection) ──
            if (d._gallery && d._gallery.length > 0) html += buildGallery(d._gallery);

            // ── 12. SOCIAL MEDIA ──
            if (d.socialMedia && typeof d.socialMedia === 'object') html += buildSocialMedia(d.socialMedia);

            return html;
        }

        // ══════════════════════════════════════════════════════
        // LOCKED CHURCH — PrimeParishDetailView (upsell CTA)
        // ══════════════════════════════════════════════════════

        function renderLockedChurch(d) {
            let html = '';

            // Hero text
            html += `<div class="entity-detail-upsell-hero">Scan your bulletin, we do the rest.</div>`;

            // 2×2 benefits grid
            html += `<div class="entity-detail-benefits-grid">`;

            const benefits = [
                { icon: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="12" y1="14" x2="12" y2="18"/><line x1="10" y1="16" x2="14" y2="16"/></svg>`, title: 'Share Events', desc: 'Parish events on the Nave map' },
                { icon: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/><line x1="18" y1="8" x2="18" y2="14"/><line x1="15" y1="11" x2="21" y2="11"/></svg>`, title: 'Give Christ', desc: 'OCIA, Confirmation, First Eucharist signups' },
                { icon: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M9 15l2 2 4-4"/></svg>`, title: 'Mass Rosters', desc: 'Lector, altar server, sacristan signups' },
                { icon: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/><circle cx="18" cy="4" r="3" fill="#22C55E" stroke="none"/></svg>`, title: 'Notify Laity', desc: 'Mass changes, reminders, announcements' }
            ];

            benefits.forEach(b => {
                html += `<div class="entity-detail-benefit">
                    <div class="entity-detail-benefit-icon">${b.icon}</div>
                    <div class="entity-detail-benefit-title">${b.title}</div>
                    <div class="entity-detail-benefit-desc">${b.desc}</div>
                </div>`;
            });

            html += `</div>`;

            // CTA: "Unlock Parish For Everyone" with rainbow border
            html += `<div style="padding: 0 20px 8px;">
                <a href="join.html" class="entity-detail-unlock-btn">Unlock Parish For Everyone</a>
            </div>`;

            // "See an example" link — find an unlocked parish
            html += `<a href="#" class="entity-detail-see-example" onclick="showExampleUnlockedParish(); return false;">See an example</a>`;

            return html;
        }

        // ══════════════════════════════════════════════════════
        // BUSINESS — BusinessDetailViewPrime
        // ══════════════════════════════════════════════════════

        function renderBusiness(d) {
            let html = '';

            // Features (top capsules like iOS hero)
            if (Array.isArray(d.features) && d.features.length > 0) {
                html += `<div class="entity-detail-section-title">Highlights</div><div class="entity-detail-programs">`;
                d.features.slice(0, 5).forEach(f => {
                    const text = typeof f === 'object' ? (f.name || f.title || JSON.stringify(f)) : f;
                    html += `<div class="entity-detail-program-pill">${escapeHTML(text)}</div>`;
                });
                html += '</div>';
            }

            // Hours
            if (Array.isArray(d.hours) && d.hours.length > 0) {
                html += `<div class="entity-detail-section-title">Hours</div><div class="entity-detail-hours">`;
                d.hours.forEach(h => {
                    const day = h.day || h.dayOfWeek || '';
                    const isClosed = h.isClosed === true;
                    const time = isClosed ? 'Closed' : (h.openTime && h.closeTime ? `${h.openTime} - ${h.closeTime}` : h.hours || h.time || h.open || '');
                    if (day) html += `<div class="entity-detail-hours-row"><span class="day">${escapeHTML(day)}</span><span class="time">${escapeHTML(time)}</span></div>`;
                });
                html += '</div>';
            } else if (typeof d.hours === 'object' && d.hours && !Array.isArray(d.hours)) {
                html += `<div class="entity-detail-section-title">Hours</div><div class="entity-detail-hours">`;
                for (const [day, time] of Object.entries(d.hours)) {
                    html += `<div class="entity-detail-hours-row"><span class="day">${escapeHTML(day)}</span><span class="time">${escapeHTML(String(time))}</span></div>`;
                }
                html += '</div>';
            }

            // Services
            const serviceFields = [
                ['Services Offered', d.servicesOffered], ['Special Offers', d.specialOffers],
                ['Loyalty Program', d.loyaltyProgram], ['Membership Benefits', d.membershipBenefits]
            ].filter(([,v]) => v);
            if (serviceFields.length) {
                html += `<div class="entity-detail-section-title">Services</div>`;
                serviceFields.forEach(([label, value]) => { html += buildInfoFull(label, value); });
            }

            // Events (premium events array + single event)
            const hasEvents = d.eventTitle || (Array.isArray(d.premiumEvents) && d.premiumEvents.length > 0);
            if (hasEvents) {
                html += `<div class="entity-detail-section-title">Events</div>`;
                if (Array.isArray(d.premiumEvents)) {
                    d.premiumEvents.forEach(evt => {
                        let evtHTML = `<div class="entity-detail-info-full"><div class="info-title">${escapeHTML(evt.name || '')}</div><div class="info-text">${evt.date ? escapeHTML(evt.date) : ''}${evt.time ? ' at ' + escapeHTML(evt.time) : ''}${evt.details ? '<br>' + escapeHTML(evt.details) : ''}</div>`;
                        if (evt.signUpLink) evtHTML += `<a href="${evt.signUpLink}" target="_blank" rel="noopener" style="color:#3366CC;font-size:0.82rem;">Sign Up →</a>`;
                        evtHTML += `</div>`;
                        html += evtHTML;
                    });
                }
                if (d.eventTitle) {
                    html += `<div class="entity-detail-info-full"><div class="info-title">${escapeHTML(d.eventTitle)}${d.eventSubtitle ? ' — ' + escapeHTML(d.eventSubtitle) : ''}</div><div class="info-text">${d.eventDate ? escapeHTML(d.eventDate) : ''}${d.eventTime ? ' at ' + escapeHTML(d.eventTime) : ''}</div></div>`;
                }
                if (d.cateringOptions) html += buildInfoFull('Catering Options', d.cateringOptions);
                if (d.privateEventsInfo) html += buildInfoFull('Private Events', d.privateEventsInfo);
            }

            // Philanthropy
            const hasPhilanthropy = d.communityPartnerships || d.communityInvolvement || d.additionalEventsSummary;
            if (hasPhilanthropy) {
                html += `<div class="entity-detail-section-title">Community & Philanthropy</div>`;
                if (d.communityPartnerships) html += buildInfoFull('Parish Support', d.communityPartnerships);
                if (d.communityInvolvement) html += buildInfoFull('Nonprofit Partnerships', d.communityInvolvement);
                if (d.additionalEventsSummary) html += buildInfoFull('Event Sponsorships', d.additionalEventsSummary);
            }

            // Awards & Reviews
            if (d.awardsRecognition) html += buildInfoFull('Awards & Recognition', d.awardsRecognition);
            if (d.customerReviewsSummary) html += buildInfoFull('Customer Reviews', d.customerReviewsSummary);
            if (d.marketingNewsletter) html += buildInfoFull('Newsletter', d.marketingNewsletter);

            // Job Openings (from subcollection)
            if (d._jobs && d._jobs.length > 0) {
                html += `<div class="entity-detail-section-title">Job Openings</div>`;
                d._jobs.forEach(job => {
                    html += `<div class="entity-detail-job"><div class="entity-detail-job-title">${escapeHTML(job.title || '')}</div>`;
                    const meta = [job.type, job.salary].filter(Boolean).join(' · ');
                    if (meta) html += `<div class="entity-detail-job-meta">${escapeHTML(meta)}</div>`;
                    if (job.description) html += `<div class="entity-detail-job-desc">${escapeHTML(job.description)}</div>`;
                    html += '</div>';
                });
            }

            // Social Media
            html += buildSocialMedia(d.socialMedia || d.contactInfo?.socialMedia);

            return html;
        }

        // ══════════════════════════════════════════════════════
        // SCHOOL — SchoolDetailViewPrime
        // ══════════════════════════════════════════════════════

        function renderSchool(d) {
            let html = '';

            // Administration
            const principal = d.principalName || d.headmasterName || '';
            if (principal) html += buildInfoFull('Principal / Headmaster', principal);

            // Academics grid
            const academicFields = [
                ['Grade Levels', d.gradeLevels], ['Enrollment', d.enrollment],
                ['Class Size', d.classSize], ['Tuition', d.tuition],
                ['Financial Aid', d.financialAid], ['Admissions', d.admissionsProcess]
            ].filter(([, v]) => v);

            if (academicFields.length) {
                html += `<div class="entity-detail-section-title">Academics</div><div class="entity-detail-info-grid">`;
                academicFields.forEach(([label, value]) => { html += buildInfoItem(label, value); });
                html += '</div>';
                if (d.parentInvolvement) html += buildInfoFull('Parent Involvement', d.parentInvolvement);
                if (d.enrollmentURL) html += `<div style="margin:0 16px 12px;"><a href="${d.enrollmentURL}" target="_blank" rel="noopener" class="entity-detail-action-btn primary-action" style="display:inline-flex;">Apply / Enroll</a></div>`;
            }

            // Classical Education
            const classicalFields = [
                ['Trivium & Quadrivium', d.triviumQuadrivium], ['Latin & Greek', d.latinGreekStudies],
                ['Great Books', d.greatBooks], ['Socratic Method', d.socraticMethod]
            ].filter(([, v]) => v);
            if (classicalFields.length) {
                html += `<div class="entity-detail-section-title">Classical Education</div>`;
                classicalFields.forEach(([label, value]) => { html += buildInfoFull(label, value); });
            }

            // Catholic Formation
            const formationFields = [
                ['Religious Education', d.religiousEducation], ['Sacramental Preparation', d.sacramentalPreparation],
                ['Daily Mass', d.dailyMass], ['Confession', d.confessionSchedule],
                ['Adoration', d.adoration], ['Virtue Formation', d.virtueFormation]
            ].filter(([, v]) => v);
            if (formationFields.length) {
                html += `<div class="entity-detail-section-title">Catholic Formation</div>`;
                formationFields.forEach(([label, value]) => {
                    if (typeof value === 'object') html += buildInfoFull(label, JSON.stringify(value));
                    else html += buildInfoFull(label, value);
                });
            }

            // Marketing
            const marketingFields = [
                ['Social Media', d.socialMedia], ['Newsletter', d.newsletter],
                ['Virtual Tours', d.virtualTours], ['Open Houses', d.openHouses]
            ].filter(([, v]) => v);
            if (marketingFields.length) {
                html += `<div class="entity-detail-section-title">Marketing & Connect</div>`;
                marketingFields.forEach(([label, value]) => {
                    if (typeof value === 'object') html += buildSocialMedia(value);
                    else html += buildInfoFull(label, value);
                });
            }

            return html;
        }

        // ══════════════════════════════════════════════════════
        // MISSIONARY — MissionaryDetailViewPrime
        // ══════════════════════════════════════════════════════

        function renderMissionary(d) {
            let html = '';

            // Role & Organization
            if (d.role) html += buildInfoFull('Role', d.role);
            if (d.organization) html += buildInfoFull('Organization', d.organization);
            if (d.campus) html += buildInfoFull('Campus', d.campus);

            // Impact Stats
            const stats = d.impactStats;
            if (stats && (stats.studentsReached || stats.campusesCovered || stats.yearsOfService)) {
                html += `<div class="entity-detail-section-title">Impact</div><div class="entity-detail-stats">`;
                if (stats.studentsReached) html += `<div class="entity-detail-stat"><div class="stat-value">${escapeHTML(String(stats.studentsReached))}</div><div class="stat-label">Students Reached</div></div>`;
                if (stats.campusesCovered) html += `<div class="entity-detail-stat"><div class="stat-value">${escapeHTML(String(stats.campusesCovered))}</div><div class="stat-label">Campuses</div></div>`;
                if (stats.yearsOfService) html += `<div class="entity-detail-stat"><div class="stat-value">${escapeHTML(String(stats.yearsOfService))}</div><div class="stat-label">Years</div></div>`;
                html += '</div>';
            }

            // Edit mode fields for missionary
            if (detailEditMode && isOwner(d)) {
                html += buildEditableField(d, 'name', 'Name', d.name, false);
                html += buildEditableField(d, 'role', 'Role', d.role, false);
                html += buildEditableField(d, 'organization', 'Organization', d.organization, false);
                html += buildEditableField(d, 'website', 'Website', d.website, false);
                html += buildEditableField(d, 'donationLink', 'Donation Link', d.donationLink, false);
                html += buildEditableField(d, 'email', 'Email', d.email, false);
                html += buildEditableField(d, 'phone', 'Phone', d.phone, false);
                html += buildEditableField(d, 'calendlyLink', 'Calendly Link', d.calendlyLink, false);
            }

            // FOCUS Bible Studies
            if (Array.isArray(d.bibleStudies) && d.bibleStudies.length > 0) {
                html += `<div class="entity-detail-section-title">Bible Studies</div><div class="entity-detail-schedule">`;
                d.bibleStudies.forEach(bs => {
                    const day = bs.dayOfWeek || '';
                    const time = bs.time || '';
                    const participants = bs.currentParticipants && bs.maxParticipants ? `${bs.currentParticipants}/${bs.maxParticipants}` : '';
                    html += `<div class="entity-detail-schedule-row"><span class="day">${escapeHTML(day)} ${escapeHTML(time)}</span><span class="times">${participants ? escapeHTML(participants) + ' spots' : ''}</span></div>`;
                });
                html += '</div>';
            }

            return html;
        }

        // ══════════════════════════════════════════════════════
        // RETREAT — RetreatDetailViewPrime
        // ══════════════════════════════════════════════════════

        function renderRetreat(d) {
            let html = '';

            // Dates & Pricing grid
            const dateFields = [
                ['Date', d.date ? (typeof d.date === 'string' ? d.date : '') : ''],
                ['Duration', d.duration], ['Price', d.price], ['Capacity', d.capacity],
                ['Formats', d.retreatFormats], ['Group Sizes', d.groupSizes]
            ].filter(([, v]) => v);
            if (dateFields.length) {
                html += `<div class="entity-detail-section-title">Details</div><div class="entity-detail-info-grid">`;
                dateFields.forEach(([label, value]) => { html += buildInfoItem(label, value); });
                html += '</div>';
            }

            // Organization
            if (d.organizationName) {
                html += `<div class="entity-detail-section-title">Organization</div>`;
                html += buildInfoFull(d.organizationName, d.organizationDescription);
                if (d.organizationWebsite) {
                    const url = d.organizationWebsite.startsWith('http') ? d.organizationWebsite : 'https://' + d.organizationWebsite;
                    html += `<div style="margin:0 16px 12px;"><a href="${url}" target="_blank" rel="noopener" class="entity-detail-action-btn">Organization Website</a></div>`;
                }
            }

            // Program
            const programFields = [
                ['Topics & Themes', d.retreatTopics], ['Speaker Info', d.speakerInfo],
                ['Schedule & Structure', d.scheduleStructure], ['Pricing Details', d.pricing]
            ].filter(([, v]) => v);
            if (programFields.length) {
                html += `<div class="entity-detail-section-title">Program</div>`;
                programFields.forEach(([label, value]) => { html += buildInfoFull(label, value); });
            }

            // Spiritual Life
            const spirFields = [
                ['Mass Schedule', d.massSchedule], ['Confession', d.confessionAvailability],
                ['Adoration', d.adorationOpportunities], ['Spiritual Direction', d.spiritualDirection],
                ['Prayer Formats', d.prayerFormats]
            ].filter(([, v]) => v);
            if (spirFields.length) {
                html += `<div class="entity-detail-section-title">Spiritual Life</div>`;
                spirFields.forEach(([label, value]) => {
                    if (typeof value === 'object' && !Array.isArray(value)) {
                        const schedule = parseSchedule(value);
                        if (Object.keys(schedule).length) html += `<div class="entity-detail-schedule">${renderScheduleRows(schedule)}</div>`;
                        else html += buildInfoFull(label, JSON.stringify(value));
                    } else {
                        html += buildInfoFull(label, value);
                    }
                });
            }

            // Logistics
            const logFields = [
                ['Director', d.directorName], ['Accommodation', d.accommodationInfo],
                ['Frequency', d.retreatFrequency]
            ].filter(([, v]) => v);
            if (logFields.length) {
                html += `<div class="entity-detail-section-title">Logistics</div>`;
                logFields.forEach(([label, value]) => { html += buildInfoFull(label, value); });
            }

            // Address
            const addr = [d.city, d.state, d.zipCode].filter(Boolean).join(', ');
            if (addr) html += buildInfoFull('Location', addr);

            // Testimonials
            if (d.testimonials) html += buildInfoFull('Testimonials', d.testimonials);

            // Other retreat offerings
            if (d._otherRetreats && d._otherRetreats.length > 0) {
                html += `<div class="entity-detail-section-title">Other Retreats</div>`;
                d._otherRetreats.forEach(r => {
                    html += buildInfoFull(r.title || r.retreatTitle || r.name || 'Retreat', r.description || r.date || '');
                });
            }

            // Social
            html += buildSocialMedia(d.socialMedia);

            // Message Retreat (full-width blue button — matches iOS)
            html += `<button class="entity-detail-message-btn" onclick="messageEntityOwner()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                Message Retreat
            </button>`;

            return html;
        }

        // ══════════════════════════════════════════════════════
        // PILGRIMAGE — PilgrimageDetailViewPrime
        // ══════════════════════════════════════════════════════

        function renderPilgrimage(d) {
            let html = '';

            // Site info
            if (d.siteName || d.siteDescription) {
                html += `<div class="entity-detail-section-title">Site Information</div>`;
                if (d.siteName) html += buildInfoFull(d.siteName, d.siteDescription);
                if (d.siteHistoricalSignificance) html += buildInfoFull('Historical Significance', d.siteHistoricalSignificance);
                if (d.siteVisitingHours) html += buildInfoFull('Visiting Hours', d.siteVisitingHours);
                if (d.siteAdmissionInfo) html += buildInfoFull('Admission', d.siteAdmissionInfo);
            }

            // ── Travel Facilitations (matches iOS PilgrimageListingCard) ──
            html += `<div class="entity-detail-travel-section"><div class="travel-heading">Travel Facilitations</div>`;
            const listings = d._listings || [];
            if (listings.length > 0) {
                listings.forEach(listing => {
                    const price = listing.price ? `$${Math.round(listing.price)}` : '';
                    const spots = listing.spots || 0;
                    const limited = spots > 0 && spots <= 5;
                    // Format date range
                    let dateText = '';
                    const startDate = listing.date?.toDate ? listing.date.toDate() : (listing.date?.seconds ? new Date(listing.date.seconds * 1000) : (typeof listing.date === 'string' ? new Date(listing.date) : null));
                    const endDate = listing.endDate?.toDate ? listing.endDate.toDate() : (listing.endDate?.seconds ? new Date(listing.endDate.seconds * 1000) : (typeof listing.endDate === 'string' ? new Date(listing.endDate) : null));
                    if (startDate && !isNaN(startDate.getTime())) {
                        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                        const sd = startDate.getDate(), sm = months[startDate.getMonth()], sy = startDate.getFullYear();
                        if (endDate && !isNaN(endDate.getTime()) && endDate.getTime() !== startDate.getTime()) {
                            const ed = endDate.getDate(), em = months[endDate.getMonth()], ey = endDate.getFullYear();
                            if (sy === ey && startDate.getMonth() === endDate.getMonth()) {
                                dateText = `${sm} ${sd}–${ed}, ${sy}`;
                            } else if (sy === ey) {
                                dateText = `${sm} ${sd}–${em} ${ed}, ${sy}`;
                            } else {
                                dateText = `${sm} ${sd}, ${sy}–${em} ${ed}, ${ey}`;
                            }
                        } else {
                            dateText = `${sm} ${sd}, ${sy}`;
                        }
                    } else if (typeof listing.date === 'string') {
                        dateText = listing.date;
                    }
                    const dest = listing.destination || '';
                    const regUrl = listing.registrationURL || '';
                    const listingId = listing.id || '';
                    html += `<div class="entity-detail-listing-card">`;
                    html += `<div class="entity-detail-listing-info">`;
                    html += `<div class="entity-detail-listing-price">${escapeHTML(price)}${limited ? '<span class="limited-badge">Limited</span>' : ''}</div>`;
                    if (dateText) html += `<div class="entity-detail-listing-date"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>${escapeHTML(dateText)}</div>`;
                    if (spots > 0) html += `<div class="entity-detail-listing-spots">${spots} spots available</div>`;
                    html += `</div>`;
                    html += `<button class="entity-detail-listing-explore${spots === 0 ? ' disabled' : ''}" onclick="openPilgrimageReserve('${escapeHTML(listingId)}')"><svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/><path d="M12 8l4 4-4 4" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>Explore</button>`;
                    html += `</div>`;
                });
            } else {
                html += `<div class="entity-detail-travel-empty">No upcoming trips are currently available.</div>`;
            }
            html += `</div>`;

            // ── Other Offerings at this site ──
            if (d._offerings && d._offerings.length > 0) {
                html += `<div class="entity-detail-section-title">Other Pilgrimage Offerings</div>`;
                d._offerings.forEach(o => {
                    const title = o.title || o.name || 'Offering';
                    const oDate = o.date || '';
                    const oDesc = o.description || '';
                    html += buildInfoFull(title, [oDate, oDesc].filter(Boolean).join(' · '));
                });
            }

            // Pilgrimage type
            if (d.type && d.type !== d._type) html += buildInfoFull('Pilgrimage Type', d.type);

            // Message Pilgrimage (full-width blue button — matches iOS)
            html += `<button class="entity-detail-message-btn" onclick="messageEntityOwner()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                Message Pilgrimage
            </button>`;

            return html;
        }

        // ══════════════════════════════════════════════════════
        // VOCATION — VocationDetailViewPrime
        // ══════════════════════════════════════════════════════

        function renderVocation(d) {
            let html = '';

            // Overview grid
            const infoFields = [
                ['Vocation Director', d.directorName], ['Community', d.communityName],
                ['Vocation Type', d.type && d.type !== d._type ? d.type : '']
            ].filter(([, v]) => v);
            if (infoFields.length) {
                html += `<div class="entity-detail-section-title">Overview</div><div class="entity-detail-info-grid">`;
                infoFields.forEach(([label, value]) => { html += buildInfoItem(label, value); });
                html += '</div>';
            }

            // Formation
            const formFields = [
                ['Formation Process', d.formationProcess],
                ['Requirements', d.requirements],
                ['Discernment Opportunities', d.discernmentOpportunities]
            ].filter(([, v]) => v);
            if (formFields.length) {
                html += `<div class="entity-detail-section-title">Formation & Discernment</div>`;
                formFields.forEach(([label, value]) => { html += buildInfoFull(label, value); });
            } else {
                // Show hardcoded process steps like iOS does when no formation data
                const vocType = d.type || 'Priesthood';
                const steps = getVocationProcessSteps(vocType);
                html += `<div class="entity-detail-section-title">Formation Process</div>`;
                steps.forEach((step, i) => {
                    html += `<div class="entity-detail-step"><div class="entity-detail-step-num">${i + 1}</div><div class="entity-detail-step-text"><div class="entity-detail-step-title">${escapeHTML(step.title)}</div><div class="entity-detail-step-desc">${escapeHTML(step.desc)}</div></div></div>`;
                });
            }

            // Location details
            const addr = [d.address, d.city, d.state, d.zipCode].filter(Boolean).join(', ');
            if (addr) html += buildInfoFull('Location', addr);

            // Edit mode fields
            if (detailEditMode && isOwner(d)) {
                html += `<div class="entity-detail-section-title">Edit Fields</div>`;
                html += buildEditableField(d, 'title', 'Title', d.title, false);
                html += buildEditableField(d, 'email', 'Email', d.email, false);
                html += buildEditableField(d, 'phone', 'Phone', d.phone, false);
                html += buildEditableField(d, 'website', 'Website', d.website, false);
                html += buildEditableField(d, 'applicationLink', 'Application Link', d.applicationLink, false);
                html += buildEditableField(d, 'directorName', 'Director Name', d.directorName, false);
                html += buildEditableField(d, 'communityName', 'Community Name', d.communityName, false);
            }

            return html;
        }

        // ══════════════════════════════════════════════════════
        // CAMPUS — Campus Ministry detail
        // ══════════════════════════════════════════════════════

        function renderCampus(d) {
            let html = '';
            if (d.university) html += buildInfoFull('University', d.university);
            if (d.organization) html += buildInfoFull('Organization', d.organization);
            if (d.type && d.type !== d._type) html += buildInfoFull('Type', d.type);
            if (d.meetingTimes || d.meetingTime) html += buildInfoFull('Meeting Times', d.meetingTimes || d.meetingTime);
            if (d.chaplainName) html += buildInfoFull('Chaplain', d.chaplainName + (d.chaplainEmail ? ' · ' + d.chaplainEmail : ''));
            if (d.introduction) html += buildInfoFull('About', d.introduction);
            if (d.parishAddress) html += buildInfoFull('Parish Address', d.parishAddress);
            if (d.memberCount) html += buildInfoItem('Members', d.memberCount);

            // Social
            if (d.socialMedia && typeof d.socialMedia === 'object') html += buildSocialMedia(d.socialMedia);

            return html;
        }

        // ══════════════════════════════════════════════════════
        // SEARCH BAR — iOS CatholicSearchOverlay parity
        // ══════════════════════════════════════════════════════

        const searchOverlay = document.getElementById('map-search-overlay');
        const searchInput = document.getElementById('map-search-input');
        const searchResults = document.getElementById('map-search-results');
        const searchClearBtn = document.getElementById('map-search-clear');
        const searchEmptyEl = document.getElementById('map-search-empty');
        let searchDebounceTimer = null;

        // ── Animated placeholder (matches iOS ScrollingSearchTextController) ──
        (function() {
            const words = document.querySelectorAll('.map-search-placeholder-word');
            let currentIdx = 0;
            const total = words.length;

            setInterval(() => {
                words[currentIdx].classList.remove('active');
                currentIdx = (currentIdx + 1) % total;
                words[currentIdx].classList.add('active');
            }, 1800);
        })();

        // ── Open / close search overlay ──
        window.openMapSearch = function() {
            searchOverlay.classList.add('active');
            searchInput.focus();
        };

        window.closeMapSearch = function() {
            searchOverlay.classList.remove('active');
            searchInput.blur();
        };

        window.clearMapSearch = function() {
            searchInput.value = '';
            searchClearBtn.classList.remove('visible');
            searchResults.innerHTML = '';
            searchResults.appendChild(searchEmptyEl);
            searchEmptyEl.style.display = '';
            searchInput.focus();
        };

        // Close on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && searchOverlay.classList.contains('active')) closeMapSearch();
        });

        // ── Normalize for search (diacritics, lowercase, collapse spaces) ──
        function normalizeForSearch(text) {
            if (!text) return '';
            return String(text).normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .toLowerCase().replace(/\s+/g, ' ').trim();
        }

        // ── Search fields per type ──
        function getSearchableText(data, type) {
            const parts = [];
            const n = data.name || data.title || data.parishName || '';
            if (n) parts.push(n);

            switch (type) {
                case 'church':
                    if (data.address) parts.push(data.address);
                    if (data.city) parts.push(data.city);
                    if (data.diocese) parts.push(data.diocese);
                    break;
                case 'missionary':
                    if (data.locationPrimary?.city) parts.push(data.locationPrimary.city);
                    if (data.organization) parts.push(data.organization);
                    break;
                case 'vocation':
                    if (data.location) parts.push(data.location);
                    if (data.communityName) parts.push(data.communityName);
                    break;
                case 'retreat':
                    if (data.location) parts.push(data.location);
                    if (data.city) parts.push(data.city);
                    if (data.organizationName) parts.push(data.organizationName);
                    break;
                case 'pilgrimage':
                    if (data.location) parts.push(data.location);
                    if (data.city) parts.push(data.city);
                    if (data.siteName) parts.push(data.siteName);
                    break;
                case 'school':
                    if (data.location?.city) parts.push(data.location.city);
                    else if (data.city) parts.push(data.city);
                    break;
                case 'campus':
                    if (data.location) parts.push(data.location);
                    if (data.university) parts.push(data.university);
                    if (data.type) parts.push(data.type);
                    break;
                case 'business':
                    if (data.city) parts.push(data.city);
                    if (data.subcategory) parts.push(data.subcategory);
                    if (data.category) parts.push(data.category);
                    break;
            }
            return normalizeForSearch(parts.join(' '));
        }

        // ── Section config (order + limits matching iOS) ──
        const SEARCH_SECTIONS = [
            { type: 'church', title: 'Churches', limit: 5 },
            { type: 'missionary', title: 'Missionaries', limit: 5 },
            { type: 'vocation', title: 'Vocations', limit: 2 },
            { type: 'retreat', title: 'Retreats', limit: 2 },
            { type: 'pilgrimage', title: 'Pilgrimage', limit: 3 },
            { type: 'school', title: 'Education', limit: 2 },
            { type: 'campus', title: 'Campus Ministries', limit: 2 },
            { type: 'business', title: 'Businesses', limit: 5 }
        ];

        const TYPE_ICONS = {
            church: '⛪', missionary: '✝️', pilgrimage: '🗺️', retreat: '🙏',
            school: '🎓', vocation: '📿', business: '🏪', campus: '🎒'
        };

        const TYPE_LABELS = {
            church: 'Church', missionary: 'Missionary', pilgrimage: 'Pilgrimage',
            retreat: 'Retreat', school: 'School', vocation: 'Vocation',
            business: 'Business', campus: 'Campus'
        };

        // ── Perform search across entityDataMap ──
        function performMapSearch(query) {
            const q = normalizeForSearch(query);
            if (q.length < 2) {
                searchResults.innerHTML = '';
                searchResults.appendChild(searchEmptyEl);
                searchEmptyEl.style.display = '';
                return;
            }

            const tokens = q.split(' ').filter(t => t.length > 0);
            const sections = [];

            for (const sec of SEARCH_SECTIONS) {
                const matches = [];
                entityDataMap.forEach((data, docId) => {
                    if (data._type !== sec.type) return;
                    const haystack = getSearchableText(data, sec.type);
                    const allMatch = tokens.every(tok => haystack.includes(tok));
                    if (allMatch) matches.push({ docId, data });
                });
                if (matches.length > 0) {
                    sections.push({ ...sec, results: matches.slice(0, sec.limit) });
                }
            }

            renderSearchResults(sections, q);
        }

        // ── Get subtitle for result row ──
        function getResultSubtitle(data, type) {
            switch (type) {
                case 'church': return data.address || data.city || data.diocese || '';
                case 'missionary': return data.organization || (data.locationPrimary?.city ? data.locationPrimary.city + (data.locationPrimary.state ? ', ' + data.locationPrimary.state : '') : '') || '';
                case 'vocation': return data.location || data.communityName || '';
                case 'retreat': return data.location || data.organizationName || data.city || '';
                case 'pilgrimage': return data.location || data.city || '';
                case 'school': return data.location?.city || data.city || '';
                case 'campus': return data.university || data.location || '';
                case 'business': return [data.subcategory, data.city].filter(Boolean).join(' · ') || '';
                default: return '';
            }
        }

        // ── Render search results ──
        function renderSearchResults(sections, query) {
            if (sections.length === 0) {
                searchResults.innerHTML = `<div class="map-search-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><div class="map-search-empty-text">No results for "${escapeHTML(query)}"</div></div>`;
                return;
            }

            let html = '';
            for (const sec of sections) {
                html += `<div class="map-search-section-title">${sec.title}</div>`;
                sec.results.forEach((r, i) => {
                    const name = r.data.name || r.data.title || r.data.parishName || 'Unknown';
                    const subtitle = getResultSubtitle(r.data, sec.type);
                    const color = PIN_COLORS[sec.type];
                    const icon = TYPE_ICONS[sec.type] || '📍';
                    const badge = TYPE_LABELS[sec.type] || sec.type;
                    html += `<div class="map-search-row" onclick="selectSearchResult('${r.docId}')"><div class="map-search-row-icon" style="background:${color}22;"><span>${icon}</span></div><div class="map-search-row-info"><div class="map-search-row-title">${escapeHTML(name)}</div>${subtitle ? `<div class="map-search-row-subtitle">${escapeHTML(subtitle)}</div>` : ''}</div><span class="map-search-row-badge">${badge}</span></div>`;
                    if (i < sec.results.length - 1) html += `<div class="map-search-divider"></div>`;
                });
            }
            searchResults.innerHTML = html;
        }

        // ── Select search result: close overlay, fly to, open detail ──
        window.selectSearchResult = function(docId) {
            const data = entityDataMap.get(docId);
            if (!data) return;
            closeMapSearch();
            if (data._coords) {
                map.flyTo([data._coords.lat, data._coords.lng], 14, { duration: 0.8 });
            }
            setTimeout(() => openMapEntityDetail(docId), 400);
        };

        // ── Debounced search on input ──
        searchInput.addEventListener('input', () => {
            const val = searchInput.value.trim();
            searchClearBtn.classList.toggle('visible', val.length > 0);
            if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => performMapSearch(val), 300);
        });

        // Enter key submits search
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
                performMapSearch(searchInput.value.trim());
            }
        });

        // Start loading
        loadData();

        // ── Waitlist popup after 30s ──────────────────────────
        (function() {
            if (sessionStorage.getItem('nave_map_waitlist_shown')) return;
            setTimeout(() => {
                if (sessionStorage.getItem('nave_map_waitlist_shown')) return;
                document.getElementById('map-waitlist-overlay').classList.remove('hidden');
                sessionStorage.setItem('nave_map_waitlist_shown', '1');
            }, 30000);
        })();

        function closeMapWaitlist() {
            document.getElementById('map-waitlist-overlay').classList.add('hidden');
        }

        document.getElementById('map-waitlist-overlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'map-waitlist-overlay') closeMapWaitlist();
        });

        document.getElementById('map-waitlist-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('map-waitlist-email').value.trim();
            if (!email) return;
            const btn = e.target.querySelector('.map-waitlist-btn');
            btn.disabled = true;
            btn.textContent = 'Submitting...';
            try {
                const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const { db } = await import('./firebase-config.js');
                await addDoc(collection(db, 'waitlist'), {
                    email: email,
                    createdAt: serverTimestamp(),
                    source: 'map_30s'
                });
                document.getElementById('map-waitlist-form').classList.add('hidden');
                document.getElementById('map-waitlist-success').classList.remove('hidden');
                setTimeout(() => closeMapWaitlist(), 2000);
            } catch (err) {
                console.error('Waitlist error:', err);
                btn.textContent = 'Error - Try Again';
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
