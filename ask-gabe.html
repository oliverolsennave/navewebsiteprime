<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ask Gabe — Nave</title>
    <meta name="description" content="Ask Gabe, your expert Catholic AI assistant. Discover parishes, schools, pilgrimages, retreats, missionaries, vocations, businesses, and campus ministries.">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Favicon (red Nave logo, cache-busted) -->
    <link rel="icon" href="/favicon.ico?v=20260209-red" sizes="48x48">
    <link rel="icon" href="assets/favicon-32.png?v=20260209-red" sizes="32x32" type="image/png">
    <link rel="icon" href="assets/favicon-16.png?v=20260209-red" sizes="16x16" type="image/png">
    <link rel="icon" href="assets/favicon-adaptive.svg?v=20260209-red" type="image/svg+xml" sizes="any">
    <link rel="apple-touch-icon" href="assets/apple-touch-icon.png?v=20260209-red" sizes="180x180">
    <link rel="mask-icon" href="assets/favicon-adaptive.svg?v=20260209-red" color="#CC3333">
    <link rel="shortcut icon" href="/favicon.ico?v=20260209-red">
    <link rel="manifest" href="site.webmanifest">
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="theme-color" content="#0D0D10">
    
    <style>
        /* Ask Gabe Page — same dark theme */
        .ask-page { height: 100vh; display: flex; flex-direction: column; overflow: hidden; background: #0D0D10; }
        .ask-wrapper { flex: 1; display: flex; flex-direction: column; margin-top: 57px; overflow: hidden; }
        .ask-chat-area { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 1.5rem; }

        /* Welcome View */
        .ask-welcome { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 3rem 1rem; min-height: 100%; }
        .ask-welcome-icon { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, rgba(51, 102, 204, 0.2), rgba(51, 102, 204, 0.1)); display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; }
        .ask-welcome-icon svg { display: block; }
        .ask-welcome h2 { font-size: 1.75rem; font-weight: 700; color: #f5f5f5; margin-bottom: 0.5rem; }
        .ask-welcome p { font-size: 1rem; color: #888; margin-bottom: 2rem; }

        /* Suggestion chips */
        .ask-suggestions-label { font-size: 0.8rem; color: #888; letter-spacing: 0.2px; margin-bottom: 0.75rem; text-align: left; width: 100%; max-width: 500px; }
        .ask-suggestions { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; max-width: 500px; width: 100%; }
        .ask-chip { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: rgba(51, 102, 204, 0.12); border: 1px solid rgba(51, 102, 204, 0.3); border-radius: 12px; color: #6699ff; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: background 0.2s, transform 0.1s; text-align: left; }
        .ask-chip:hover { background: rgba(51, 102, 204, 0.22); transform: translateY(-1px); }
        .ask-chip:active { transform: translateY(0); }
        .ask-chip svg { flex-shrink: 0; width: 18px; height: 18px; }

        /* Chat messages */
        .ask-messages { display: flex; flex-direction: column; gap: 1rem; max-width: 800px; margin: 0 auto; width: 100%; }
        .ask-msg { display: flex; gap: 0.5rem; max-width: 85%; }
        .ask-msg-user { align-self: flex-end; flex-direction: row-reverse; }
        .ask-msg-assistant { align-self: flex-start; }
        .ask-msg-avatar { width: 32px; height: 32px; border-radius: 50%; background: rgba(51, 102, 204, 0.25); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .ask-msg-avatar svg { width: 16px; height: 16px; }
        .ask-msg-content { display: flex; flex-direction: column; gap: 0.25rem; min-width: 0; }
        .ask-msg-label { font-size: 0.75rem; font-weight: 500; color: #888; display: flex; align-items: center; gap: 0.35rem; }
        .ask-msg-bubble { padding: 0.75rem 1rem; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; overflow-wrap: break-word; }
        .ask-msg-user .ask-msg-bubble { background: #3366CC; color: #fff; border-bottom-right-radius: 4px; }
        .ask-msg-assistant .ask-msg-bubble { background: #1e1e1e; color: #f5f5f5; border-bottom-left-radius: 4px; }

        /* Markdown rendering inside assistant bubbles */
        .ask-msg-assistant .ask-msg-bubble strong { font-weight: 700; color: #fff; }
        .ask-msg-assistant .ask-msg-bubble em { font-style: italic; color: #ccc; }
        .ask-msg-assistant .ask-msg-bubble .gabe-section-header { display: block; font-weight: 700; font-size: 0.95em; color: #fff; margin-top: 0.8em; margin-bottom: 0.35em; }
        .ask-msg-assistant .ask-msg-bubble .gabe-section-header:first-child { margin-top: 0.2em; }
        .ask-msg-assistant .ask-msg-bubble .gabe-bullet { display: block; padding-left: 0.2em; margin-bottom: 0.45em; line-height: 1.5; }
        .ask-msg-assistant .ask-msg-bubble .gabe-bullet strong { color: #fff; }
        .ask-msg-assistant .ask-msg-bubble .gabe-bullet .gabe-desc { display: block; color: #bbb; font-size: 0.92em; margin-top: 0.1em; }

        /* Suggestion cards */
        .ask-suggestion-cards { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .ask-suggestion-card { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: rgba(51, 102, 204, 0.12); border: 1px solid rgba(51, 102, 204, 0.3); border-radius: 12px; cursor: pointer; transition: background 0.2s, transform 0.1s; }
        .ask-suggestion-card:hover { background: rgba(51, 102, 204, 0.22); transform: translateY(-1px); }
        .ask-suggestion-card-icon { width: 28px; height: 28px; border-radius: 6px; background: #3366CC; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; flex-shrink: 0; }
        .ask-suggestion-card-info { display: flex; flex-direction: column; min-width: 0; }
        .ask-suggestion-card-name { font-size: 0.85rem; font-weight: 600; color: #f5f5f5; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .ask-suggestion-card-type { font-size: 0.72rem; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Rainbow event cards */
        .ask-event-cards { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .ask-event-card { display: flex; flex-direction: column; gap: 6px; padding: 12px; min-width: 150px; max-width: 200px; background: #1a1a1a; border-radius: 12px; border: 2.5px solid transparent; background-clip: padding-box; position: relative; cursor: pointer; transition: transform 0.1s, box-shadow 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .ask-event-card::before { content: ''; position: absolute; inset: -2.5px; border-radius: 14px; background: linear-gradient(135deg, #EF4444, #F97316, #EAB308, #22C55E, #06B6D4, #3B82F6, #8B5CF6); z-index: -1; }
        .ask-event-card:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .ask-event-card-title { font-size: 0.85rem; font-weight: 600; color: #f5f5f5; line-height: 1.3; }
        .ask-event-card-meta { display: flex; align-items: center; gap: 4px; font-size: 0.72rem; color: #888; }
        .ask-event-card-meta svg { width: 12px; height: 12px; flex-shrink: 0; }

        /* Typing indicator */
        .ask-typing { display: flex; align-items: center; gap: 0.5rem; align-self: flex-start; }
        .ask-typing-dots { display: flex; gap: 4px; padding: 0.75rem 1rem; background: #1e1e1e; border-radius: 18px; border-bottom-left-radius: 4px; }
        .ask-typing-dots span { width: 8px; height: 8px; border-radius: 50%; background: #666; animation: askDot 1.2s infinite; }
        .ask-typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .ask-typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes askDot { 0%, 60%, 100% { opacity: 0.4; transform: scale(0.8); } 30% { opacity: 1; transform: scale(1.2); } }

        /* Input area */
        .ask-input-area { background: #141414; border-top: 1px solid #2a2a2a; padding: 0.75rem 1rem; }
        .ask-input-container { max-width: 800px; margin: 0 auto; }
        .ask-input-card { background: #1e1e1e; border: 1px solid #2a2a2a; border-radius: 24px; padding: 0; overflow: hidden; transition: box-shadow 0.2s; }
        .ask-input-card:focus-within { box-shadow: 0 0 0 2px rgba(51, 102, 204, 0.3); }
        .ask-input { width: 100%; padding: 0.75rem 1rem; border-radius: 0; border: none; background: transparent; font-size: 0.95rem; font-family: inherit; color: #f5f5f5; outline: none; box-sizing: border-box; }
        .ask-input::placeholder { color: #666; }
        .ask-input:focus { box-shadow: none; }
        .ask-input-bottom { display: flex; align-items: center; padding: 0 0.5rem 0.5rem; }
        .ask-tool-btns { display: flex; gap: 2px; }
        .ask-tool-btn { width: 34px; height: 34px; border-radius: 50%; border: none; background: none; color: #888; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.15s, color 0.15s; }
        .ask-tool-btn:hover { background: #2a2a2a; color: #ccc; }
        .ask-tool-btn svg { width: 18px; height: 18px; }
        .ask-send-btn { width: 34px; height: 34px; border-radius: 50%; border: none; background: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; padding: 0; margin-left: auto; }
        .ask-send-btn:disabled { opacity: 0.3; cursor: default; }
        .ask-send-btn svg { width: 30px; height: 30px; }
        .ask-disclaimer { text-align: center; font-size: 0.72rem; color: #666; margin-top: 6px; }

        /* Error banner */
        .ask-error-banner { background: rgba(255, 59, 48, 0.1); border: 1px solid rgba(255, 59, 48, 0.25); border-radius: 12px; padding: 0.75rem 1rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .ask-error-banner span { font-size: 0.85rem; color: #FF3B30; }
        .ask-error-banner button { margin-left: auto; background: none; border: none; color: #6699ff; font-weight: 600; cursor: pointer; font-size: 0.85rem; }

        /* New chat button */
        .ask-new-chat-btn { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 8px; border: none; background: rgba(51, 102, 204, 0.15); color: #6699ff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; z-index: 10; }
        .ask-new-chat-btn:hover { background: rgba(51, 102, 204, 0.25); }

        /* ── Mobile ─────────────────────────────────────── */
        @media (max-width: 768px) {
            .ask-page { height: 100vh; height: 100dvh; }
            .ask-wrapper { margin-top: 52px; overflow: hidden; }
            .ask-welcome { padding: 1.5rem 1rem 1rem; min-height: auto; justify-content: flex-start; }
            .ask-welcome-icon { width: 64px; height: 64px; margin-bottom: 0.75rem; }
            .ask-welcome-icon svg { width: 32px; height: 32px; }
            .ask-welcome h2 { font-size: 1.3rem; margin-bottom: 0.25rem; }
            .ask-welcome p { font-size: 0.85rem; margin-bottom: 1rem; }
            .ask-suggestions-label { margin-bottom: 0.5rem; }
            .ask-suggestions { grid-template-columns: 1fr; gap: 0.5rem; }
            .ask-chip { padding: 0.75rem 1rem; font-size: 0.88rem; border-radius: 14px; }
            .ask-chip svg { width: 20px; height: 20px; }
            .ask-chip-extra { display: none; }

            /* Chat area — prevent horizontal overflow */
            .ask-chat-area { padding: 0.75rem; overflow-x: hidden; }
            .ask-messages { gap: 0.75rem; width: 100%; }

            /* Messages — full-width, no clipping */
            .ask-msg { max-width: 88%; gap: 0.4rem; }
            .ask-msg-avatar { width: 26px; height: 26px; flex-shrink: 0; }
            .ask-msg-avatar svg { width: 13px; height: 13px; }
            .ask-msg-content { min-width: 0; max-width: 100%; }
            .ask-msg-bubble { padding: 0.6rem 0.8rem; font-size: 0.9rem; border-radius: 16px; word-break: break-word; }
            .ask-msg-user .ask-msg-bubble { border-bottom-right-radius: 4px; }
            .ask-msg-assistant .ask-msg-bubble { border-bottom-left-radius: 4px; }
            .ask-msg-label { font-size: 0.7rem; }

            /* Suggestion cards — horizontal scroll, contained */
            .ask-suggestion-cards { flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; scrollbar-width: none; max-width: 100%; }
            .ask-suggestion-cards::-webkit-scrollbar { display: none; }
            .ask-suggestion-card { min-width: 160px; max-width: 200px; flex-shrink: 0; padding: 0.5rem 0.7rem; }
            .ask-suggestion-card-name { font-size: 0.8rem; }
            .ask-suggestion-card-type { font-size: 0.68rem; }

            /* Event cards — horizontal scroll */
            .ask-event-cards { flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; scrollbar-width: none; max-width: 100%; }
            .ask-event-cards::-webkit-scrollbar { display: none; }
            .ask-event-card { min-width: 140px; max-width: 170px; flex-shrink: 0; padding: 10px; }

            /* Input area — safe-area aware */
            .ask-input-area { padding: 0.4rem 0.6rem; padding-bottom: calc(0.4rem + env(safe-area-inset-bottom, 0px)); }
            .ask-input { padding: 0.6rem 0.85rem; font-size: 0.95rem; }
            .ask-input-card { border-radius: 22px; }
            .ask-tool-btn { width: 32px; height: 32px; }
            .ask-tool-btn svg { width: 17px; height: 17px; }
            .ask-send-btn { width: 32px; height: 32px; }
            .ask-send-btn svg { width: 28px; height: 28px; }
            .ask-disclaimer { font-size: 0.68rem; margin-top: 5px; }
            .ask-new-chat-btn { top: 8px; right: 8px; width: 34px; height: 34px; }
        }
        @media (max-width: 380px) {
            .ask-welcome h2 { font-size: 1.25rem; }
            .ask-chip { padding: 0.75rem 0.85rem; font-size: 0.84rem; }
            .ask-msg { max-width: 92%; }
            .ask-msg-bubble { font-size: 0.86rem; padding: 0.55rem 0.75rem; }
            .ask-suggestion-card { min-width: 145px; }
        }

        /* ═══ Entity Detail Modal — White Prime Theme (matches Map tab) ═══ */
        .entity-detail-overlay { position: fixed; inset: 0; z-index: 9998; background: rgba(0,0,0,0.35); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: none; justify-content: center; align-items: flex-end; transition: opacity 0.3s; }
        .entity-detail-overlay.active { display: flex; }
        .entity-detail-panel { background: #ffffff; border-radius: 20px 20px 0 0; width: 100%; max-width: 540px; max-height: 85vh; overflow-y: auto; animation: slideUpDetail 0.35s ease-out; overscroll-behavior: contain; }
        @keyframes slideUpDetail { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .entity-detail-handle { display: flex; justify-content: center; padding: 10px 0 4px; cursor: grab; }
        .entity-detail-handle span { width: 36px; height: 4px; border-radius: 2px; background: #ccc; }
        .entity-detail-header { display: flex; align-items: flex-start; gap: 14px; padding: 8px 20px 16px; }
        .entity-detail-icon { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; background: #f0f0f0; }
        .entity-detail-header-info { flex: 1; min-width: 0; }
        .entity-detail-name { font-size: 1.25rem; font-weight: 700; color: #111; line-height: 1.3; margin: 0 0 2px; }
        .entity-detail-type-badge { display: inline-block; font-size: 0.72rem; font-weight: 600; color: #666; background: #f0f0f0; padding: 2px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .entity-detail-close { width: 32px; height: 32px; border-radius: 50%; border: none; background: #f0f0f0; color: #666; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; transition: background 0.2s; }
        .entity-detail-close:hover { background: #e0e0e0; }
        /* Rainbow card */
        .entity-detail-card { margin: 0 20px 16px; padding: 20px; border-radius: 18px; background: #fff; position: relative; box-shadow: 0 6px 12px rgba(0,0,0,0.06); }
        .entity-detail-card.rainbow { border: 3px solid transparent; background: linear-gradient(#fff, #fff) padding-box, conic-gradient(from 0deg, #EF4444, #F97316, #EAB308, #22C55E, #3B82F6, #EC4899, #EF4444) border-box; box-shadow: 0 6px 12px rgba(0,0,0,0.08), 0 0 16px 2px rgba(239,68,68,0.12), 0 0 16px 2px rgba(59,130,246,0.12); }
        .entity-detail-location { display: flex; align-items: center; gap: 6px; color: #777; font-size: 0.88rem; margin-bottom: 8px; }
        .entity-detail-location svg { width: 14px; height: 14px; flex-shrink: 0; }
        .entity-detail-description { font-size: 0.9rem; line-height: 1.6; color: #444; margin-bottom: 8px; }
        .entity-detail-website-row { display: flex; align-items: center; justify-content: space-between; margin-top: 8px; }
        .entity-detail-website-link { display: inline-flex; align-items: center; gap: 6px; color: #3366CC; font-size: 0.88rem; font-weight: 500; text-decoration: none; }
        .entity-detail-website-link svg { width: 14px; height: 14px; }
        .entity-detail-website-link.disabled { color: #bbb; pointer-events: none; }
        /* Follow Key button */
        .entity-detail-follow-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: calc(100% - 40px); padding: 14px; margin: 0 20px 16px; border-radius: 14px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s, transform 0.1s; color: #fff; background: #111; }
        .entity-detail-follow-btn:hover { transform: translateY(-1px); }
        .entity-detail-follow-btn svg { width: 18px; height: 18px; }
        /* Quick actions (3 buttons) */
        .entity-detail-quick-actions { display: flex; gap: 12px; margin: 0 20px 20px; }
        .entity-detail-quick-action { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 14px 0; border-radius: 18px; border: none; background: #f2f2f7; cursor: pointer; transition: background 0.15s, transform 0.1s; text-decoration: none; }
        .entity-detail-quick-action:hover { background: #e5e5ea; transform: translateY(-1px); }
        .entity-detail-quick-action svg { width: 18px; height: 18px; color: #011893; }
        .entity-detail-quick-action span { font-size: 0.72rem; font-weight: 500; color: #011893; }
        /* Section title */
        .entity-detail-section-title { font-size: 0.75rem; font-weight: 700; color: #999; text-transform: uppercase; letter-spacing: 0.8px; padding: 12px 20px 6px; }
        /* Schedule */
        .entity-detail-schedule { margin: 0 16px 8px; padding: 12px 14px; background: #f8f8fa; border-radius: 12px; }
        .entity-detail-schedule-row { display: flex; justify-content: space-between; font-size: 0.82rem; color: #777; padding: 3px 0; }
        .entity-detail-schedule-row .day { color: #333; font-weight: 500; }
        .entity-detail-schedule-row .times { text-align: right; color: #666; }
        /* Schedule segmented control (Mass/Confession/Adoration tabs) */
        .entity-detail-schedule-tabs { display: flex; margin: 0 20px 0; background: #1a2744; border-radius: 12px; overflow: hidden; }
        .entity-detail-schedule-tab { flex: 1; padding: 10px 0; text-align: center; font-size: 0.78rem; font-weight: 600; color: rgba(255,255,255,0.5); cursor: pointer; transition: background 0.2s, color 0.2s; border: none; background: transparent; }
        .entity-detail-schedule-tab.active { background: #3366CC; color: #fff; border-radius: 10px; margin: 3px; }
        .entity-detail-schedule-tab-content { display: none; }
        .entity-detail-schedule-tab-content.active { display: block; }
        /* Upcoming Events — horizontal scroll cards */
        .entity-detail-events-heading { font-size: 1.15rem; font-weight: 700; color: #111; padding: 16px 24px 10px; }
        .entity-detail-events { overflow-x: auto; padding-bottom: 16px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .entity-detail-events::-webkit-scrollbar { display: none; }
        .entity-detail-events-inner { display: flex; gap: 12px; padding: 0 24px; }
        .entity-detail-event-item { flex: 0 0 auto; width: 48%; min-width: 180px; max-width: 240px; padding: 16px; background: #f2f2f7; border-radius: 14px; scroll-snap-align: start; }
        .entity-detail-event-title { font-size: 0.92rem; font-weight: 700; color: #111; margin-bottom: 8px; line-height: 1.3; }
        .entity-detail-event-meta { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #888; margin-bottom: 4px; }
        .entity-detail-event-meta svg { width: 14px; height: 14px; flex-shrink: 0; color: #888; }
        /* Programs & sacraments pills */
        .entity-detail-programs { display: flex; flex-wrap: wrap; gap: 6px; margin: 0 16px 16px; }
        .entity-detail-program-pill { display: inline-flex; align-items: center; gap: 4px; padding: 5px 10px; background: rgba(34, 197, 94, 0.08); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; color: #16a34a; font-size: 0.75rem; font-weight: 600; }
        /* Get Involved 2x2 grid */
        .entity-detail-get-involved { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 8px 20px 16px; }
        .entity-detail-program-card { display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 16px 8px; background: #f2f2f7; border-radius: 12px; cursor: pointer; transition: background 0.15s; text-decoration: none; }
        .entity-detail-program-card:hover { background: #e5e5ea; }
        .entity-detail-program-card svg { width: 24px; height: 24px; color: #3366CC; }
        .entity-detail-program-card .program-title { font-size: 0.82rem; font-weight: 600; color: #111; }
        .entity-detail-program-card .program-sub { font-size: 0.68rem; color: #888; }
        /* Sign-Up Sheets button */
        .entity-detail-signup-btn { display: flex; align-items: center; gap: 16px; margin: 8px 20px 16px; padding: 16px; background: #f2f2f7; border-radius: 16px; cursor: pointer; transition: background 0.15s; text-decoration: none; border: none; width: calc(100% - 40px); }
        .entity-detail-signup-btn:hover { background: #e5e5ea; }
        .entity-detail-signup-icon { width: 50px; height: 50px; border-radius: 50%; background: rgba(51,102,204,0.15); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .entity-detail-signup-icon svg { width: 20px; height: 20px; color: #3366CC; }
        .entity-detail-signup-text { flex: 1; text-align: left; }
        .entity-detail-signup-text .title { font-size: 0.95rem; font-weight: 600; color: #111; }
        .entity-detail-signup-text .sub { font-size: 0.82rem; color: #888; margin-top: 2px; }
        .entity-detail-signup-chevron { color: #888; flex-shrink: 0; }
        .entity-detail-signup-chevron svg { width: 14px; height: 14px; }
        /* Pastor Announcements */
        .entity-detail-psa { margin: 0 16px 8px; padding: 14px; background: #f8f8fa; border-radius: 12px; border-left: 3px solid #d4af37; }
        .entity-detail-psa-title { font-size: 0.88rem; font-weight: 600; color: #111; margin-bottom: 4px; }
        .entity-detail-psa-text { font-size: 0.82rem; color: #444; line-height: 1.5; }
        .entity-detail-psa-meta { font-size: 0.72rem; color: #999; margin-top: 6px; }
        /* Location map embed */
        .entity-detail-map-section { margin: 8px 20px 16px; }
        .entity-detail-map-section .section-label { font-size: 1.05rem; font-weight: 700; color: #111; margin-bottom: 12px; }
        .entity-detail-map-embed { width: 100%; height: 220px; border-radius: 24px; overflow: hidden; position: relative; }
        .entity-detail-map-embed iframe { width: 100%; height: 100%; border: 0; }
        /* Bulletin upload CTA */
        .entity-detail-bulletin { margin: 8px 20px 16px; padding: 24px 20px; background: rgba(51,102,204,0.08); border: 1px dashed rgba(51,102,204,0.35); border-radius: 16px; text-align: center; cursor: pointer; transition: background 0.15s; }
        .entity-detail-bulletin:hover { background: rgba(51,102,204,0.12); }
        .entity-detail-bulletin svg { width: 32px; height: 32px; color: #3366CC; margin-bottom: 12px; }
        .entity-detail-bulletin .bulletin-title { font-size: 0.95rem; font-weight: 600; color: #111; margin-bottom: 4px; }
        .entity-detail-bulletin .bulletin-sub { font-size: 0.78rem; color: #888; }
        /* Message Parish button */
        .entity-detail-message-btn { display: flex; align-items: center; justify-content: center; gap: 8px; margin: 8px 20px 20px; padding: 16px; background: #3366CC; color: #fff; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; width: calc(100% - 40px); transition: background 0.15s; text-decoration: none; }
        .entity-detail-message-btn:hover { background: #2a57b0; }
        .entity-detail-message-btn svg { width: 16px; height: 16px; }
        /* Locked parish upsell */
        .entity-detail-upsell-hero { text-align: center; padding: 20px 20px 8px; font-size: 1.15rem; font-weight: 700; color: #111; line-height: 1.4; }
        .entity-detail-benefits-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 12px 20px 20px; }
        .entity-detail-benefit { padding: 16px 8px; background: #f2f2f7; border-radius: 12px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .entity-detail-benefit-icon { display: flex; align-items: center; justify-content: center; margin-bottom: 8px; color: #22C55E; }
        .entity-detail-benefit-icon svg { width: 28px; height: 28px; }
        .entity-detail-benefit-title { font-size: 0.82rem; font-weight: 600; color: #111; margin-bottom: 4px; }
        .entity-detail-benefit-desc { font-size: 0.7rem; color: #888; line-height: 1.4; }
        .entity-detail-unlock-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: calc(100% - 40px); margin: 0 20px 16px; padding: 16px; border-radius: 12px; border: 3px solid transparent; background: linear-gradient(#111, #111) padding-box, conic-gradient(from 0deg, #EF4444, #F97316, #EAB308, #22C55E, #3B82F6, #8B5CF6, #EF4444) border-box; color: #fff; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.1s; text-decoration: none; box-sizing: border-box; }
        .entity-detail-unlock-btn:hover { transform: translateY(-1px); }
        /* Contact */
        .entity-detail-contact { margin: 0 16px 16px; padding: 12px 14px; background: #f8f8fa; border-radius: 12px; }
        .entity-detail-contact-row { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 0.85rem; }
        .entity-detail-contact-row svg { width: 14px; height: 14px; color: #999; flex-shrink: 0; }
        .entity-detail-contact-row a { color: #3366CC; text-decoration: none; }
        .entity-detail-contact-row span { color: #333; }
        /* Footer */
        .entity-detail-footer { padding: 12px 16px 24px; display: flex; gap: 8px; }
        .entity-detail-footer-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: background 0.2s, transform 0.1s; }
        .entity-detail-footer-btn:hover { transform: translateY(-1px); }
        .entity-detail-footer-btn.primary { background: #3366CC; color: #fff; }
        .entity-detail-footer-btn.secondary { background: #f0f0f5; border: 1px solid #ddd; color: #333; }
        .entity-detail-footer-btn svg { width: 16px; height: 16px; }
        /* Loading */
        .entity-detail-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; gap: 12px; }
        .entity-detail-spinner { width: 32px; height: 32px; border: 3px solid #ddd; border-top-color: #3366CC; border-radius: 50%; animation: detailSpin 0.8s linear infinite; }
        @keyframes detailSpin { to { transform: rotate(360deg); } }
        .entity-detail-loading-text { font-size: 0.85rem; color: #999; }
        /* Hero image */
        .entity-detail-hero { width: 100%; height: 200px; object-fit: cover; border-radius: 16px 16px 0 0; display: block; }
        @media (min-width: 769px) { .entity-detail-overlay { align-items: center; } .entity-detail-panel { border-radius: 20px; max-height: 80vh; } }
        @media (max-width: 768px) { .entity-detail-panel { max-height: 90vh; } .entity-detail-header { padding: 6px 16px 12px; } .entity-detail-name { font-size: 1.15rem; } .entity-detail-card { margin: 0 12px 12px; } .entity-detail-footer { padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px)); } }
    </style>
</head>
<body class="ask-page">
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-logo">
                <img src="assets/whitenavelogo.png" alt="Nave" class="logo-img">
                <span class="logo-text">Nave</span>
            </a>
            <div class="nav-links" id="nav-links">
                <a href="map.html" class="nav-link">Map</a>
                <a href="engage.html" class="nav-link">Engage</a>
                <a href="ask-gabe.html" class="nav-link nav-link-active">Ask</a>
                <a href="about.html" class="nav-link">About</a>
                <a href="join.html" class="nav-cta">Try Nave Free</a>
            </div>
            <button class="nav-hamburger" id="nav-hamburger" aria-label="Menu" onclick="document.getElementById('nav-links').classList.toggle('open');document.getElementById('nav-backdrop').classList.toggle('visible');">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </button>
        </div>
    </nav>
    <div class="nav-backdrop" id="nav-backdrop" onclick="document.getElementById('nav-links').classList.remove('open');this.classList.remove('visible');"></div>
    <script>requestAnimationFrame(()=>document.getElementById('nav-links').classList.add('ready'));</script>

    <div class="ask-wrapper" style="position:relative;">


        <!-- Chat Area -->
        <div class="ask-chat-area" id="ask-chat-area">
            <!-- Welcome View -->
            <div class="ask-welcome" id="ask-welcome">
                <div class="ask-welcome-icon">
                    <svg viewBox="0 0 120 120" width="48" height="48">
                        <rect x="10" y="10" width="100" height="100" rx="22" fill="#3366CC"/>
                        <text x="60" y="78" font-family="-apple-system, SF Pro, sans-serif" font-size="60" font-weight="600" fill="white" text-anchor="middle">?</text>
                    </svg>
                </div>

                <h2>Ask Gabe</h2>
                <p>Your shortcut to Catholic resources.</p>

                <div class="ask-suggestions-label">Try asking about...</div>
                <div class="ask-suggestions">
                    <button class="ask-chip" onclick="submitChip(this)">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>
                        Parishes near me
                    </button>
                    <button class="ask-chip" onclick="submitChip(this)">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>
                        Classical Catholic schools
                    </button>
                    <button class="ask-chip" onclick="submitChip(this)">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.05 4.14l-.39-.39c-.39-.39-1.02-.39-1.41 0l-.01.01c-.39.39-.39 1.02 0 1.41l.39.39c.39.39 1.03.39 1.42 0l-.01-.01c.4-.39.4-1.02.01-1.41zM3.01 10.5H1.99c-.55 0-1.01.45-1.01 1s.45 1.01 1.01 1.01h1.02c.55 0 .99-.46.99-1.01s-.44-1-.99-1zm8.99-6.02V3.49c0-.55-.45-.99-1-1s-1 .44-1 .99V4.5c0 .55.44.99 1 .99s1-.44 1-.99zM19.76 4.14c-.39-.39-1.02-.39-1.41 0l-.39.39c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l.39-.39c.39-.39.39-1.02 0-1.41zM17.95 18.86l.39.39c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-.39-.39c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41zM21.01 10.5c-.55 0-1.01.45-1.01 1s.45 1.01 1.01 1.01H22c.55 0 1.01-.45 1.01-1.01-.01-.55-.46-1-1.01-1h-.99zM12 6.5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.01c0 .55.45 1 1 1s1-.45 1-1v-1.02c0-.55-.45-1-1-1s-1 .45-1 1v1.02zm-7.36-2.65c.39.39 1.02.39 1.41 0l.39-.39c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-.39.39c-.38.39-.38 1.02 0 1.41z"/></svg>
                        Retreat centers
                    </button>
                    <button class="ask-chip" onclick="submitChip(this)">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
                        Pilgrimage sites
                    </button>
                    <button class="ask-chip ask-chip-extra" onclick="submitChip(this)">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        Catholic businesses
                    </button>
                    <button class="ask-chip ask-chip-extra" onclick="submitChip(this)">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                        Missionaries near me
                    </button>
                    <button class="ask-chip ask-chip-extra" onclick="submitChip(this)">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/></svg>
                        Campus ministry
                    </button>
                    <button class="ask-chip ask-chip-extra" onclick="submitChip(this)">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.5 10.2c0 2.57-2.1 5.79-6.16 9.51L12 20l-.34-.31C7.6 15.99 5.5 12.77 5.5 10.2c0-3.84 2.82-6.7 6.5-6.7s6.5 2.85 6.5 6.7zM12 2C7.31 2 3.5 5.53 3.5 10.2c0 3.73 2.84 7.58 7.17 11.54l.01.01c.38.35.85.55 1.32.55.47 0 .94-.2 1.32-.55l.01-.01C17.66 17.78 20.5 13.93 20.5 10.2 20.5 5.53 16.69 2 12 2z"/></svg>
                        Vocations &amp; religious life
                    </button>
                </div>
            </div>

            <!-- Messages container (hidden initially) -->
            <div class="ask-messages" id="ask-messages" style="display:none;"></div>
        </div>

        <!-- Input Area -->
        <div class="ask-input-area">
            <div class="ask-input-container">
                <div class="ask-input-card">
                    <input type="text" class="ask-input" id="ask-input" placeholder="Ask anything" autocomplete="off">
                    <div class="ask-input-bottom">
                        <div class="ask-tool-btns">
                            <!-- Attach -->
                            <button class="ask-tool-btn" title="Attach" type="button">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
                            </button>
                            <!-- Location -->
                            <button class="ask-tool-btn" title="Use location" type="button">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 10-16 0c0 3 2.7 7 8 11.7z"/></svg>
                            </button>
                            <!-- Map -->
                            <button class="ask-tool-btn" title="Explore map" type="button" onclick="window.location.href='map.html'">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
                            </button>
                            <!-- Browse -->
                            <button class="ask-tool-btn" title="Browse keys" type="button">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            </button>
                        </div>
                        <button class="ask-send-btn" id="ask-send-btn" disabled onclick="handleSend()">
                            <svg viewBox="0 0 48 48" fill="none">
                                <circle cx="24" cy="24" r="22" fill="#3366CC"/>
                                <path d="M24 14l0 20M24 14l-7 7M24 14l7 7" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="ask-disclaimer">Gabe can make mistakes. Check important info.</div>
            </div>
        </div>
    </div>

    <!-- Entity Detail Modal -->
    <div class="entity-detail-overlay" id="entity-detail-overlay">
        <div class="entity-detail-panel" id="entity-detail-panel">
            <div id="entity-detail-content"></div>
        </div>
    </div>

    <script type="module">
        // ── Import Gabe service (orchestrator + 8 experts) ──
        import { sendMessage as gabeSend, clearConversation, fetchEntityFullDetails } from './gabe-service.js';

        // ── DOM ──
        const input = document.getElementById('ask-input');
        const sendBtn = document.getElementById('ask-send-btn');
        const welcomeEl = document.getElementById('ask-welcome');
        const messagesEl = document.getElementById('ask-messages');
        const chatArea = document.getElementById('ask-chat-area');
        let isSending = false;

        input.addEventListener('input', () => { sendBtn.disabled = input.value.trim() === '' || isSending; });
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && input.value.trim() && !isSending) handleSend(); });

        window.submitChip = function(el) { input.value = el.textContent.trim(); handleSend(); };
        window.handleSend = handleSend;
        window.startNewChat = startNewChat;

        // ── Entity Detail Modal ──
        const detailOverlay = document.getElementById('entity-detail-overlay');
        const detailContent = document.getElementById('entity-detail-content');
        const detailPanel = document.getElementById('entity-detail-panel');
        window._entitySuggestions = [];

        window.openEntityDetail = async function(index) {
            const entity = window._entitySuggestions[index];
            if (!entity) return;
            detailOverlay.classList.add('active');
            detailContent.innerHTML = `<div class="entity-detail-loading"><div class="entity-detail-spinner"></div><div class="entity-detail-loading-text">Loading details...</div></div>`;
            try {
                const details = await fetchEntityFullDetails(entity);
                renderEntityDetail(details || {
                    ...entity, address: '', city: '', state: '', diocese: '', phone: '', email: '', website: '',
                    description: entity.description || '', category: entity.subtitle || '', coordinates: null,
                    massSchedule: null, confessionSchedule: null, adorationSchedule: null,
                    events: [], isUnlocked: false, hasOCIA: false, hasConfirmation: false, hasFirstEucharist: false, hasMarriagePrep: false,
                    organization: '', memberCount: 0, features: []
                });
            } catch (err) {
                console.error('Detail fetch error:', err);
                renderEntityDetail({ ...entity, address: '', city: '', state: '', description: entity.description || '', coordinates: null, massSchedule: null, confessionSchedule: null, adorationSchedule: null, events: [], website: '', phone: '', email: '', diocese: '', category: entity.subtitle || '', isUnlocked: false, hasOCIA: false, hasConfirmation: false, hasFirstEucharist: false, hasMarriagePrep: false, organization: '', memberCount: 0, features: [] });
            }
        };

        window.closeEntityDetail = function() { detailOverlay.classList.remove('active'); };
        detailOverlay.addEventListener('click', (e) => { if (e.target === detailOverlay) window.closeEntityDetail(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && detailOverlay.classList.contains('active')) window.closeEntityDetail(); });

        let detailTouchStartY = 0;
        detailPanel.addEventListener('touchstart', (e) => { if (detailPanel.scrollTop <= 0) detailTouchStartY = e.touches[0].clientY; }, { passive: true });
        detailPanel.addEventListener('touchmove', (e) => { if (detailPanel.scrollTop <= 0 && e.touches[0].clientY - detailTouchStartY > 80) window.closeEntityDetail(); }, { passive: true });

        // ── Helper: Parse schedule dict ──
        function parseSchedule(scheduleData) {
            if (!scheduleData || typeof scheduleData !== 'object' || Array.isArray(scheduleData)) return {};
            const result = {};
            for (const [day, value] of Object.entries(scheduleData)) {
                if (Array.isArray(value)) {
                    const times = [];
                    for (const v of value) {
                        if (typeof v === 'string') times.push(v);
                        else if (typeof v === 'object' && v.time) {
                            let t = v.time;
                            if (v.language && v.language !== 'English') t += ` (${v.language})`;
                            if (v.endTime) t += ` – ${v.endTime}`;
                            times.push(t);
                        }
                    }
                    if (times.length > 0) result[day] = times;
                } else if (typeof value === 'string') {
                    result[day] = [value];
                }
            }
            return result;
        }

        // ── Helper: Parse event data ──
        function parseEvent(data) {
            const title = data.title || data.name || '';
            if (!title) return null;
            let eventDate = null;
            if (data.date && data.date.toDate) eventDate = data.date.toDate();
            else if (data.date && data.date.seconds) eventDate = new Date(data.date.seconds * 1000);
            else if (typeof data.date === 'string' && data.date.trim()) {
                let dateStr = data.date.trim();
                let parsed = new Date(dateStr);
                if (isNaN(parsed.getTime())) parsed = new Date(dateStr + ', ' + new Date().getFullYear());
                if (!isNaN(parsed.getTime())) eventDate = parsed;
            }
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            if (eventDate && !isNaN(eventDate.getTime())) {
                return { title, date: eventDate, time: data.time || null, location: data.location || null,
                    month: months[eventDate.getMonth()] || '', dayNum: eventDate.getDate() || '',
                    rawDate: data.date, description: data.description || null };
            }
            return { title, date: new Date(9999, 0, 1), time: data.time || null, location: data.location || null,
                month: (typeof data.date === 'string' ? data.date.split(' ')[0].substring(0, 3) : ''), dayNum: (typeof data.date === 'string' ? data.date.split(' ')[1] || '' : ''),
                rawDate: data.date, description: data.description || null };
        }

        // ── Helper: Switch schedule tab ──
        window.switchScheduleTab = function(schedId, tab) {
            const tabBar = document.getElementById(schedId + '-tabs');
            if (tabBar) tabBar.querySelectorAll('.entity-detail-schedule-tab').forEach(t => t.classList.remove('active'));
            ['mass', 'confession', 'adoration'].forEach(t => {
                const el = document.getElementById(schedId + '-' + t);
                if (el) el.classList.remove('active');
            });
            const content = document.getElementById(schedId + '-' + tab);
            if (content) content.classList.add('active');
            if (tabBar) {
                tabBar.querySelectorAll('.entity-detail-schedule-tab').forEach(t => {
                    if (t.textContent.toLowerCase().replace(/\s/g,'') === tab) t.classList.add('active');
                });
            }
        };

        // ── Render schedule rows ──
        function renderScheduleRows(schedule) {
            const dayOrder = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Monday-Friday'];
            let html = '';
            for (const day of dayOrder) {
                if (schedule[day] && schedule[day].length > 0) {
                    html += `<div class="entity-detail-schedule-row"><span class="day">${day}</span><span class="times">${schedule[day].map(t => escapeHTML(t)).join(', ')}</span></div>`;
                }
            }
            return html;
        }

        // ── Render entity detail — Prime View (matches Map tab) ──
        function renderEntityDetail(d) {
            const isChurch = d.type === 'Church';
            const isOrganization = d.type === 'Organization';

            // Build maps URLs
            let mapsUrl = '';
            if (d.coordinates && d.coordinates.lat && d.coordinates.lng) mapsUrl = `https://maps.google.com/maps?q=${d.coordinates.lat},${d.coordinates.lng}`;
            else if (d.address && d.city) mapsUrl = `https://maps.google.com/maps?q=${encodeURIComponent(d.address + ', ' + d.city + ' ' + (d.state || ''))}`;
            let naveMapUrl = '';
            if (d.coordinates && d.coordinates.lat && d.coordinates.lng) naveMapUrl = `map.html?lat=${d.coordinates.lat}&lng=${d.coordinates.lng}&z=15`;

            // Hero image
            let html = '';
            const heroImg = d.imageURL || d.siteImageURL || '';
            if (heroImg) {
                const src = heroImg.startsWith('http') ? heroImg : `https://firebasestorage.googleapis.com/v0/b/navefirebase.firebasestorage.app/o/${encodeURIComponent(heroImg)}?alt=media`;
                html += `<img class="entity-detail-hero" src="${src}" alt="" loading="lazy" onerror="this.remove()">`;
            }

            // Handle bar + close button
            html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px 4px;"><div style="flex:1;"></div><div class="entity-detail-handle" style="padding:0;"><span></span></div><div style="flex:1;display:flex;justify-content:flex-end;"><button class="entity-detail-close" onclick="closeEntityDetail()">&times;</button></div></div>`;

            // ── Rainbow card ──
            const cardClass = 'entity-detail-card rainbow';
            let cardHTML = '';

            // Name inside card
            cardHTML += `<div style="font-size:1.35rem;font-weight:700;color:#111;margin-bottom:6px;">${escapeHTML(d.name)}</div>`;

            // Address
            if (isChurch) {
                const addr = d.address || '';
                const street = addr.includes(',') ? addr.split(',')[0].trim() : addr;
                if (street) cardHTML += `<div style="font-size:0.92rem;color:#888;margin-bottom:8px;">${escapeHTML(street)}</div>`;
            } else {
                const locParts = [];
                if (d.address) locParts.push(d.address);
                if (d.city && d.state) locParts.push(`${d.city}, ${d.state}`);
                else if (d.city) locParts.push(d.city);
                else if (d.state) locParts.push(d.state);
                const loc = locParts.join(' · ');
                if (loc) cardHTML += `<div class="entity-detail-location"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg><span>${escapeHTML(loc)}</span></div>`;
            }

            // Description
            if (d.description) {
                const desc = d.description.length > 300 ? d.description.substring(0, 297) + '...' : d.description;
                cardHTML += `<div style="border-top:1px solid #eee;margin:8px 0;"></div>`;
                cardHTML += `<div class="entity-detail-description">${escapeHTML(desc)}</div>`;
            }

            // Website link + close button row
            const website = d.website || '';
            cardHTML += `<div class="entity-detail-website-row">`;
            if (website) {
                const url = website.startsWith('http') ? website : 'https://' + website;
                cardHTML += `<a href="${url}" target="_blank" rel="noopener" class="entity-detail-website-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>Visit Website</a>`;
            } else {
                cardHTML += `<span class="entity-detail-website-link disabled"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>Visit Website</span>`;
            }
            cardHTML += `</div>`;
            html += `<div class="${cardClass}">${cardHTML}</div>`;

            // ── LOCKED CHURCH: upsell view ──
            if (isChurch && d.isUnlocked !== true) {
                html += renderLockedChurch(d);
                html += buildFooter(d, naveMapUrl);
                detailContent.innerHTML = html;
                return;
            }

            // ── Follow Key button ──
            html += `<button class="entity-detail-follow-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>Follow Key</button>`;

            // ── Quick Actions (3 buttons) ──
            const QA_SHARE = `<button class="entity-detail-quick-action" onclick="shareAskEntity()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg><span>Share</span></button>`;
            const QA_NOTIFY = `<button class="entity-detail-quick-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><span>Notify</span></button>`;
            const QA_MAP = mapsUrl ? `<a href="${mapsUrl}" target="_blank" rel="noopener" class="entity-detail-quick-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg><span>Map</span></a>` : `<button class="entity-detail-quick-action" disabled><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg><span>Map</span></button>`;
            const QA_SAVE = `<button class="entity-detail-quick-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg><span>Save</span></button>`;
            const QA_MESSAGE = `<button class="entity-detail-quick-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span>Message</span></button>`;

            html += `<div class="entity-detail-quick-actions">`;
            if (isChurch) {
                html += QA_SHARE + QA_NOTIFY + QA_MAP;
            } else {
                html += QA_SAVE + QA_MESSAGE + QA_MAP;
            }
            html += `</div>`;

            // ── Type-specific sections ──
            if (isChurch) html += renderChurchSections(d);

            // ── Contact ──
            if (d.phone || d.email || d.website) {
                html += `<div class="entity-detail-section-title">Contact</div>`;
                html += buildContact(d);
            }

            // Organization features
            if (isOrganization && d.features && d.features.length > 0) {
                html += `<div class="entity-detail-section-title">Features</div><div class="entity-detail-programs">${d.features.map(f => `<div class="entity-detail-program-pill">${escapeHTML(f)}</div>`).join('')}</div>`;
            }

            // Footer
            html += buildFooter(d, naveMapUrl);
            detailContent.innerHTML = html;
        }

        // ── Church sections (matching map.html renderChurch) ──
        function renderChurchSections(d) {
            let html = '';
            const entityId = d.id || d.name || '';

            // 1. Upcoming Events (horizontal scroll cards)
            if (Array.isArray(d.events) && d.events.length > 0) {
                const upcoming = d.events.map(e => parseEvent(e)).filter(e => e !== null).sort((a, b) => a.date - b.date).slice(0, 5);
                if (upcoming.length) {
                    html += `<div class="entity-detail-events-heading">Upcoming Events</div><div class="entity-detail-events"><div class="entity-detail-events-inner">`;
                    for (const evt of upcoming) {
                        const dateStr = evt.rawDate || (evt.month + ' ' + evt.dayNum);
                        html += `<div class="entity-detail-event-item">`;
                        html += `<div class="entity-detail-event-title">${escapeHTML(evt.title)}</div>`;
                        html += `<div class="entity-detail-event-meta"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>${escapeHTML(typeof dateStr === 'string' ? dateStr : '')}</div>`;
                        if (evt.time) html += `<div class="entity-detail-event-meta"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>${escapeHTML(evt.time)}</div>`;
                        html += `</div>`;
                    }
                    html += '</div></div>';
                }
            }

            // 2. Schedule — Navy blue segmented control (Mass / Confession / Adoration)
            const hasMass = d.massSchedule && typeof d.massSchedule === 'object' && Object.keys(parseSchedule(d.massSchedule)).length > 0;
            const hasConfession = d.confessionSchedule && typeof d.confessionSchedule === 'object' && Object.keys(parseSchedule(d.confessionSchedule)).length > 0;
            const hasAdoration = d.adorationSchedule && typeof d.adorationSchedule === 'object' && Object.keys(parseSchedule(d.adorationSchedule)).length > 0;

            if (hasMass || hasConfession || hasAdoration) {
                const schedId = 'ask-sched-' + entityId.replace(/[^a-zA-Z0-9]/g, '');
                html += `<div class="entity-detail-schedule-tabs" id="${schedId}-tabs">`;
                if (hasMass) html += `<button class="entity-detail-schedule-tab active" onclick="switchScheduleTab('${schedId}','mass')">Mass</button>`;
                if (hasConfession) html += `<button class="entity-detail-schedule-tab${!hasMass ? ' active' : ''}" onclick="switchScheduleTab('${schedId}','confession')">Confession</button>`;
                if (hasAdoration) html += `<button class="entity-detail-schedule-tab${!hasMass && !hasConfession ? ' active' : ''}" onclick="switchScheduleTab('${schedId}','adoration')">Adoration</button>`;
                html += `</div>`;

                if (hasMass) html += `<div class="entity-detail-schedule-tab-content active" id="${schedId}-mass"><div class="entity-detail-schedule">${renderScheduleRows(parseSchedule(d.massSchedule))}</div></div>`;
                if (hasConfession) html += `<div class="entity-detail-schedule-tab-content${!hasMass ? ' active' : ''}" id="${schedId}-confession"><div class="entity-detail-schedule">${renderScheduleRows(parseSchedule(d.confessionSchedule))}</div></div>`;
                if (hasAdoration) html += `<div class="entity-detail-schedule-tab-content${!hasMass && !hasConfession ? ' active' : ''}" id="${schedId}-adoration"><div class="entity-detail-schedule">${renderScheduleRows(parseSchedule(d.adorationSchedule))}</div></div>`;
            }

            // 3. Pastor Announcements
            if (Array.isArray(d.pastorPSAs) && d.pastorPSAs.length > 0) {
                html += `<div class="entity-detail-section-title">Pastor Announcements</div>`;
                d.pastorPSAs.forEach(psa => {
                    html += `<div class="entity-detail-psa"><div class="entity-detail-psa-title">${escapeHTML(psa.title || '')}</div><div class="entity-detail-psa-text">${escapeHTML(psa.message || '')}</div>`;
                    if (psa.pastorName) html += `<div class="entity-detail-psa-meta">— ${escapeHTML(psa.pastorName)}</div>`;
                    html += `</div>`;
                });
            }

            // 4. Get Involved — 2x2 grid
            html += `<div class="entity-detail-section-title">Get Involved</div>`;
            html += `<div class="entity-detail-get-involved">`;
            const programs = [
                { icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`, title: 'OCIA', sub: 'Start your journey' },
                { icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 0.67s0.74 2.65 0.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l0.03-0.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5 0.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-0.36 3.6-1.21 4.62-2.58 0.39 1.29 0.59 2.65 0.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/></svg>`, title: 'Confirmation', sub: 'Youth & adult' },
                { icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61z"/></svg>`, title: 'First Eucharist', sub: 'Sacrament prep' },
                { icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`, title: 'Marriage Prep', sub: 'Pre-Cana' }
            ];
            programs.forEach(p => {
                html += `<a href="#" class="entity-detail-program-card">${p.icon}<span class="program-title">${p.title}</span><span class="program-sub">${p.sub}</span></a>`;
            });
            html += `</div>`;

            // 5. Sign-Up Sheets
            html += `<button class="entity-detail-signup-btn">
                <div class="entity-detail-signup-icon"><svg viewBox="0 0 24 24" fill="currentColor" color="#3366CC"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></div>
                <div class="entity-detail-signup-text"><div class="title">Sign-Up Sheets</div><div class="sub">Groups, Liturgy, Service & More</div></div>
                <div class="entity-detail-signup-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></div>
            </button>`;

            // 6. Location Map
            if (d.coordinates && d.coordinates.lat && d.coordinates.lng) {
                const lat = d.coordinates.lat;
                const lng = d.coordinates.lng;
                html += `<div class="entity-detail-map-section">
                    <div class="section-label">Location</div>
                    <div class="entity-detail-map-embed">
                        <iframe src="https://www.openstreetmap.org/export/embed.html?bbox=${lng-0.005}%2C${lat-0.003}%2C${lng+0.005}%2C${lat+0.003}&layer=mapnik&marker=${lat}%2C${lng}" loading="lazy"></iframe>
                    </div>
                </div>`;
            }

            // 7. Bulletin Upload CTA
            html += `<div class="entity-detail-bulletin" onclick="window.location.href='join.html'">
                <svg viewBox="0 0 24 24" fill="none" stroke="#3366CC" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                <div class="bulletin-title">Upload Bulletin</div>
                <div class="bulletin-sub">Scan your weekly bulletin to update events and schedules</div>
            </div>`;

            // 8. Message Parish
            html += `<button class="entity-detail-message-btn">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                Message Parish
            </button>`;

            return html;
        }

        // ── Locked church upsell ──
        function renderLockedChurch(d) {
            let html = '';
            html += `<div class="entity-detail-upsell-hero">Scan your bulletin, we do the rest.</div>`;
            html += `<div class="entity-detail-benefits-grid">`;
            const benefits = [
                { icon: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="12" y1="14" x2="12" y2="18"/><line x1="10" y1="16" x2="14" y2="16"/></svg>`, title: 'Share Events', desc: 'Parish events on the Nave map' },
                { icon: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/><line x1="18" y1="8" x2="18" y2="14"/><line x1="15" y1="11" x2="21" y2="11"/></svg>`, title: 'Give Christ', desc: 'OCIA, Confirmation, First Eucharist signups' },
                { icon: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M9 15l2 2 4-4"/></svg>`, title: 'Mass Rosters', desc: 'Lector, altar server, sacristan signups' },
                { icon: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/><circle cx="18" cy="4" r="3" fill="#22C55E" stroke="none"/></svg>`, title: 'Notify Laity', desc: 'Mass changes, reminders, announcements' }
            ];
            benefits.forEach(b => {
                html += `<div class="entity-detail-benefit"><div class="entity-detail-benefit-icon">${b.icon}</div><div class="entity-detail-benefit-title">${b.title}</div><div class="entity-detail-benefit-desc">${b.desc}</div></div>`;
            });
            html += `</div>`;
            html += `<a href="join.html" class="entity-detail-unlock-btn" style="display:flex;text-decoration:none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>Unlock Your Parish</a>`;

            // Contact section for locked
            if (d.phone || d.email || d.website) {
                html += `<div class="entity-detail-section-title">Contact</div>`;
                html += buildContact(d);
            }
            return html;
        }

        // ── Build contact section ──
        function buildContact(d) {
            const phone = d.phone || '';
            const email = d.email || '';
            const website = d.website || '';
            if (!phone && !email && !website) return '';
            let html = '<div class="entity-detail-contact">';
            if (phone) html += `<div class="entity-detail-contact-row"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg><a href="tel:${phone}">${escapeHTML(phone)}</a></div>`;
            if (email) html += `<div class="entity-detail-contact-row"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg><a href="mailto:${email}">${escapeHTML(email)}</a></div>`;
            if (website) { const url = website.startsWith('http') ? website : 'https://' + website; const display = website.replace(/^https?:\/\/(www\.)?/, '').replace(/\/$/, ''); html += `<div class="entity-detail-contact-row"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2z"/></svg><a href="${url}" target="_blank" rel="noopener">${escapeHTML(display)}</a></div>`; }
            html += '</div>';
            return html;
        }

        // ── Build footer ──
        function buildFooter(d, naveMapUrl) {
            let html = `<div class="entity-detail-footer">`;
            if (naveMapUrl) html += `<a href="${naveMapUrl}" class="entity-detail-footer-btn primary" style="text-decoration:none;"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>View on Map</a>`;
            html += `<button class="entity-detail-footer-btn secondary" onclick="askGabeAbout('${escapeHTML(d.name).replace(/'/g, "\\'")}')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Ask Gabe</button>`;
            html += `</div>`;
            return html;
        }

        // ── Share entity ──
        window.shareAskEntity = function() {
            const name = 'Nave Key';
            const text = `Check out this key on Nave`;
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({ title: name, text, url }).catch(() => {});
            } else {
                navigator.clipboard.writeText(`${text} — ${url}`).then(() => alert('Link copied!')).catch(() => {});
            }
        };

        window.askGabeAbout = function(name) { window.closeEntityDetail(); input.value = `Tell me more about ${name}`; handleSend(); };

        // ── Send message ──
        async function handleSend() {
            const text = input.value.trim();
            if (!text || isSending) return;
            welcomeEl.style.display = 'none';
            messagesEl.style.display = 'flex';
            addMessage(text, 'user');
            input.value = '';
            sendBtn.disabled = true;
            isSending = true;
            const typingEl = showTyping();

            try {
                const result = await gabeSend(text);
                typingEl.remove();
                addMessage(result.text, 'assistant', result.suggestions, result.events);
            } catch (err) {
                typingEl.remove();
                console.error('Gabe error:', err);
                if (err.message.startsWith('API_ERROR_429')) addErrorBanner('Rate limited — please wait a moment and try again.');
                else addErrorBanner('Something went wrong. Please try again.');
            }

            isSending = false;
            sendBtn.disabled = input.value.trim() === '';
            scrollToBottom();
        }

        // ── UI helpers ──
        function addMessage(text, role, suggestions, events) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `ask-msg ask-msg-${role}`;

            if (role === 'assistant') {
                let suggestionsHTML = '';
                if (suggestions && suggestions.length > 0) {
                    const startIdx = window._entitySuggestions.length;
                    suggestions.forEach(s => window._entitySuggestions.push(s));
                    const cards = suggestions.map((s, i) => {
                        const typeLabel = s.subtitle || s.type || '';
                        const icon = getEntityIcon(s.type);
                        const idx = startIdx + i;
                        return `<div class="ask-suggestion-card" onclick="window.openEntityDetail(${idx})"><div class="ask-suggestion-card-icon">${icon}</div><div class="ask-suggestion-card-info"><div class="ask-suggestion-card-name">${escapeHTML(s.name)}</div><div class="ask-suggestion-card-type">${escapeHTML(typeLabel)}${s.location ? ' · ' + escapeHTML(s.location) : ''}</div></div></div>`;
                    }).join('');
                    suggestionsHTML = `<div class="ask-suggestion-cards">${cards}</div>`;
                }

                let eventsHTML = '';
                if (events && events.length > 0) {
                    const eventCards = events.map(e => {
                        const parishLabel = e.parishName ? ` · ${escapeHTML(e.parishName)}` : '';
                        return `<div class="ask-event-card" onclick="window.submitChip({textContent:'Tell me more about ${escapeHTML(e.title).replace(/'/g, "\\'")}'})"><div class="ask-event-card-title">${escapeHTML(e.title)}</div><div class="ask-event-card-meta"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg>${escapeHTML(e.date)}</div>${e.time ? `<div class="ask-event-card-meta"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>${escapeHTML(e.time)}${parishLabel}</div>` : ''}</div>`;
                    }).join('');
                    eventsHTML = `<div class="ask-event-cards">${eventCards}</div>`;
                }

                msgDiv.innerHTML = `<div class="ask-msg-avatar"><svg viewBox="0 0 120 120"><rect x="10" y="10" width="100" height="100" rx="22" fill="#3366CC"/><text x="60" y="78" font-family="-apple-system, SF Pro, sans-serif" font-size="60" font-weight="600" fill="white" text-anchor="middle">?</text></svg></div><div class="ask-msg-content"><div class="ask-msg-label">Gabe</div><div class="ask-msg-bubble">${renderGabeMarkdown(text)}</div>${suggestionsHTML}${eventsHTML}</div>`;
            } else {
                msgDiv.innerHTML = `<div class="ask-msg-content"><div class="ask-msg-bubble">${escapeHTML(text)}</div></div>`;
            }
            messagesEl.appendChild(msgDiv);
            scrollToBottom();
        }

        function addErrorBanner(message) {
            const banner = document.createElement('div');
            banner.className = 'ask-error-banner';
            banner.innerHTML = `<span>${message}</span>`;
            messagesEl.appendChild(banner);
            scrollToBottom();
        }

        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ask-typing';
            typingDiv.innerHTML = `<div class="ask-msg-avatar"><svg viewBox="0 0 120 120"><rect x="10" y="10" width="100" height="100" rx="22" fill="#3366CC"/><text x="60" y="78" font-family="-apple-system, SF Pro, sans-serif" font-size="60" font-weight="600" fill="white" text-anchor="middle">?</text></svg></div><div class="ask-typing-dots"><span></span><span></span><span></span></div>`;
            messagesEl.appendChild(typingDiv);
            scrollToBottom();
            return typingDiv;
        }

        function scrollToBottom() { chatArea.scrollTop = chatArea.scrollHeight; }
        function escapeHTML(str) { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; }
        function escapeHTMLWithBreaks(str) { return escapeHTML(str).replace(/\n/g, '<br>'); }

        // Lightweight markdown renderer for Gabe's responses
        function renderGabeMarkdown(str) {
            const lines = str.split('\n');
            let html = '';
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmed = line.trim();
                if (!trimmed) { html += '<br>'; continue; }

                // Section header: "## Header" or emoji + bold header
                const headerMatch = trimmed.match(/^#{1,3}\s+(.+)$/);
                if (headerMatch) {
                    html += `<span class="gabe-section-header">${renderInline(headerMatch[1])}</span>`;
                    continue;
                }

                // Bullet point: "• text" or "- text"
                const bulletMatch = trimmed.match(/^[•\-]\s+(.+)$/);
                if (bulletMatch) {
                    // Check if next line is a description (non-bullet, non-header, non-empty)
                    let desc = '';
                    if (i + 1 < lines.length) {
                        const nextTrimmed = lines[i + 1].trim();
                        if (nextTrimmed && !nextTrimmed.match(/^[•\-\d#]/) && !nextTrimmed.match(/^\d+\./)) {
                            desc = `<span class="gabe-desc">${renderInline(nextTrimmed)}</span>`;
                            i++; // skip the description line
                        }
                    }
                    html += `<span class="gabe-bullet">• ${renderInline(bulletMatch[1])}${desc}</span>`;
                    continue;
                }

                // Numbered item: "1. text"
                const numMatch = trimmed.match(/^(\d+)\.\s+(.+)$/);
                if (numMatch) {
                    let desc = '';
                    if (i + 1 < lines.length) {
                        const nextTrimmed = lines[i + 1].trim();
                        if (nextTrimmed && !nextTrimmed.match(/^[•\-\d#]/) && !nextTrimmed.match(/^\d+\./)) {
                            desc = `<span class="gabe-desc">${renderInline(nextTrimmed)}</span>`;
                            i++;
                        }
                    }
                    html += `<span class="gabe-bullet">${numMatch[1]}. ${renderInline(numMatch[2])}${desc}</span>`;
                    continue;
                }

                // Regular text
                html += renderInline(trimmed) + '<br>';
            }
            return html;
        }

        // Render inline markdown: **bold** and *italic*
        function renderInline(str) {
            let s = escapeHTML(str);
            s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
            return s;
        }
        function getEntityIcon(type) {
            const icons = { 'Church': '⛪', 'Missionary': '✝️', 'Pilgrimage': '🗺️', 'Retreat': '🙏', 'School': '🎓', 'Vocation': '📿', 'Business': '🏪', 'Campus Ministry': '🎒', 'Organization': '🏛️' };
            return icons[type] || '📍';
        }

        function startNewChat() { clearConversation(); messagesEl.innerHTML = ''; messagesEl.style.display = 'none'; welcomeEl.style.display = 'flex'; window._entitySuggestions = []; }
    </script>

    <!-- Waitlist Popup (30s) -->
    <div id="waitlist-overlay" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);justify-content:center;align-items:center;">
        <div style="background:#1a1a1a;border:1px solid #2a2a2a;border-radius:16px;padding:32px;max-width:400px;width:90%;text-align:center;position:relative;">
            <button onclick="closeWaitlistPopup()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:#707070;font-size:1.5rem;cursor:pointer;line-height:1;">&times;</button>
            <div style="width:56px;height:56px;border-radius:50%;background:rgba(212,175,55,0.12);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#d4af37" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            </div>
            <h3 style="color:#f5f5f5;font-size:1.25rem;margin:0 0 8px;">Join the Waitlist</h3>
            <p style="color:#888;font-size:0.9rem;margin:0 0 20px;">Love what you see? Be the first to know when Nave launches on iOS.</p>
            <form id="waitlist-popup-form">
                <input type="email" id="waitlist-popup-email" placeholder="you@email.com" required style="width:100%;padding:12px 16px;font-size:1rem;border:1px solid #333;border-radius:10px;background:#111;color:#f5f5f5;margin-bottom:12px;box-sizing:border-box;">
                <button type="submit" class="waitlist-popup-btn" style="width:100%;padding:12px;font-size:1rem;font-weight:600;color:#000;background:#fff;border:none;border-radius:10px;cursor:pointer;">Join the Waitlist</button>
            </form>
            <div id="waitlist-popup-success" style="display:none;padding:20px 0;">
                <svg width="48" height="48" viewBox="0 0 20 20" fill="none" style="margin:0 auto 12px;display:block;"><path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm-2 15l-5-5 1.41-1.41L8 12.17l7.59-7.59L17 6l-9 9z" fill="#d4af37"/></svg>
                <p style="color:#f5f5f5;font-size:1rem;">You're on the list! We'll be in touch.</p>
            </div>
        </div>
    </div>
    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        if (!sessionStorage.getItem('nave_gabe_waitlist_shown')) {
            setTimeout(() => {
                if (sessionStorage.getItem('nave_gabe_waitlist_shown')) return;
                document.getElementById('waitlist-overlay').style.display = 'flex';
                sessionStorage.setItem('nave_gabe_waitlist_shown', '1');
            }, 30000);
        }
        window.closeWaitlistPopup = () => { document.getElementById('waitlist-overlay').style.display = 'none'; };
        document.getElementById('waitlist-overlay')?.addEventListener('click', (e) => { if (e.target.id === 'waitlist-overlay') window.closeWaitlistPopup(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') window.closeWaitlistPopup(); });
        document.getElementById('waitlist-popup-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('waitlist-popup-email').value.trim();
            if (!email) return;
            const btn = e.target.querySelector('.waitlist-popup-btn');
            btn.disabled = true; btn.textContent = 'Submitting...';
            try {
                await addDoc(collection(db, 'waitlist'), { email, createdAt: serverTimestamp(), source: 'gabe_30s' });
                document.getElementById('waitlist-popup-form').style.display = 'none';
                document.getElementById('waitlist-popup-success').style.display = 'block';
                setTimeout(() => window.closeWaitlistPopup(), 2000);
            } catch (err) { console.error('Waitlist error:', err); btn.textContent = 'Error - Try Again'; btn.disabled = false; }
        });
    </script>
</body>
</html>
